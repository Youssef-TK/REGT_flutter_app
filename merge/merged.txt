// File: c:\Users\Youssef\Documents\flutter_apps\regt_app\lib\main.dart
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:regt_app/providers/app_state.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import 'screens/ads_screen.dart';
import 'screens/home_screen.dart';
import 'screens/login_screen.dart';
import 'screens/profile_screen.dart';
import 'screens/referrals_screen.dart';
// import 'screens/surveys_screen.dart';
import 'screens/withdrawal_screen.dart';
import 'package:flutter_dotenv/flutter_dotenv.dart';
// import 'dart:async';
// import 'package:app_links/app_links.dart';  // Deep linking package

void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  await dotenv.load(fileName: ".env");

  await Supabase.initialize(
    url: dotenv.env['SUPABASE_URL']!,
    anonKey: dotenv.env['SUPABASE_ANON_KEY']!,
  );

  Supabase.instance.client.auth.onAuthStateChange.listen((data) {
    final event = data.event;
    final session = data.session;

    if (event == AuthChangeEvent.signedIn && session != null) {
      // User confirmed email and signed in
      // Navigate to home or refresh UI
      // Note: Use a navigator key or context if needed; for simplicity, assume it's handled in widgets
      print('User signed in after confirmation');
    }
  });
  runApp(
    ChangeNotifierProvider(create: (_) => AppState(), child: const MyApp()),
  );
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'REGT Token Earning App',
      theme: ThemeData(
        primarySwatch: Colors.amber,
        scaffoldBackgroundColor: Colors.black,
        textTheme: const TextTheme(bodyLarge: TextStyle(color: Colors.white)),
      ),
      home: const LoginScreen(),
      routes: {
        '/home': (context) => const HomeScreen(),
        '/ads': (context) => const AdsScreen(),
        // '/surveys': (context) => const SurveysScreen(),
        '/referrals': (context) => const ReferralsScreen(),
        '/withdrawal': (context) => const WithdrawalScreen(),
        '/profile': (context) => const ProfileScreen(),
      },
    );
  }
}


// File: c:\Users\Youssef\Documents\flutter_apps\regt_app\lib\providers\app_state.dart
import 'package:flutter/material.dart';

class AppState extends ChangeNotifier {
  double balance = 0.0;
  String language = 'en';

  void updateBalance(double newBalance) {
    balance = newBalance;
    notifyListeners();
  }

  void changeLanguage(String newLang) {
    language = newLang;
    notifyListeners();
  }
}

// File: c:\Users\Youssef\Documents\flutter_apps\regt_app\lib\screens\ads_screen.dart
// import 'dart:async';
// import 'dart:convert';
// import 'dart:io';

// import 'package:flutter/material.dart';
// import 'package:google_mobile_ads/google_mobile_ads.dart';
// import 'package:supabase_flutter/supabase_flutter.dart';

// class AdsScreen extends StatefulWidget {
//   const AdsScreen({super.key});

//   @override
//   State<AdsScreen> createState() => _AdsScreenState();
// }

// class _AdsScreenState extends State<AdsScreen> {
//   RewardedAd? _rewardedAd;
//   int _adsWatched = 0;
//   bool _isAdReady = false;
//   bool _isOnCooldown = false;
//   Duration _remainingCooldown = Duration.zero;
//   Timer? _cooldownTimer;

//   String get _adUnitId {
//     if (Platform.isAndroid) {
//       return 'ca-app-pub-3940256099942544/5224354917';  // Test
//     } else {
//       return 'ca-app-pub-3940256099942544/1712485313';  // Test
//     }
//   }

//   @override
//   void initState() {
//     super.initState();
//     _loadAd();
//     _loadAdsWatched();
//   }

//   Future<void> _loadAdsWatched() async {
//     final userId = Supabase.instance.client.auth.currentUser?.id;
//     if (userId == null) return;

//     final today = DateTime.now().subtract(const Duration(days: 1)).toIso8601String();
//     try {
//       final response = await Supabase.instance.client
//           .from('ad_events')
//           .select()
//           .eq('user_id', userId)
//           .eq('status', 'success')
//           .gte('timestamp', today)
//           .count(CountOption.exact);
//       setState(() {
//         _adsWatched = response.count ?? 0;
//       });
//       debugPrint('Loaded ads watched: $_adsWatched');
//     } catch (e) {
//       debugPrint('Error loading ads watched: $e');
//       setState(() {
//         _adsWatched = 0;
//       });
//     }
//   }

//   void _loadAd() {
//     RewardedAd.load(
//       adUnitId: _adUnitId,
//       request: const AdRequest(),
//       rewardedAdLoadCallback: RewardedAdLoadCallback(
//         onAdLoaded: (ad) {
//           debugPrint('Ad loaded');
//           setState(() {
//             _rewardedAd = ad;
//             _isAdReady = true;
//           });
//           ad.fullScreenContentCallback = FullScreenContentCallback(
//             onAdShowedFullScreenContent: (ad) => debugPrint('Ad showed full screen'),
//             onAdFailedToShowFullScreenContent: (ad, error) {
//               debugPrint('Ad failed to show: $error');
//               ad.dispose();
//               _loadAd();
//             },
//             onAdDismissedFullScreenContent: (ad) {
//               debugPrint('Ad dismissed');
//               ad.dispose();
//               _loadAd();
//             },
//           );
//         },
//         onAdFailedToLoad: (error) {
//           debugPrint('Ad failed to load: $error');
//           Future.delayed(const Duration(seconds: 5), _loadAd); // Add delay to prevent rapid retry loops
//         },
//       ),
//     );
//   }

//   void _showAd() async {
//     if (_rewardedAd == null || _isOnCooldown || _adsWatched >= 16) {
//       debugPrint('Cannot show ad: ${_rewardedAd == null ? 'No ad' : ''} ${_isOnCooldown ? 'Cooldown' : ''} ${ _adsWatched >= 16 ? 'Max ads' : ''}');
//       return;
//     }

//     debugPrint('Showing ad');
//     _rewardedAd!.show(
//       onUserEarnedReward: (ad, reward) async {
//         debugPrint('Reward earned! Type: ${reward.type}, Amount: ${reward.amount}');
//         double baseReward = 0.006;
//         _adsWatched++;
//         if (_adsWatched % 10 == 0) baseReward += 1.0;
//         final userId = Supabase.instance.client.auth.currentUser?.id;
//         if (userId == null) return;

//         try {
//           debugPrint('Inserting ad event');
//           await Supabase.instance.client.from('ad_events').insert({
//             'user_id': userId,
//             'status': 'success',
//             'reward': baseReward,
//             'timestamp': DateTime.now().toIso8601String(),
//             'ip_address': 'dummy',
//           });
//           debugPrint('Ad event inserted');

//           debugPrint('Fetching current balance');
//           final currentResponse = await Supabase.instance.client
//               .from('user_balances')
//               .select('balance, transaction_history')
//               .eq('user_id', userId)
//               .maybeSingle();

//           final newHistoryEntry = {
//             'type': 'ad_reward',
//             'amount': baseReward,
//             'date': DateTime.now().toIso8601String(),
//           };

//           if (currentResponse == null) {
//             debugPrint('No balance row - inserting new');
//             await Supabase.instance.client.from('user_balances').insert({
//               'user_id': userId,
//               'balance': baseReward,
//               'transaction_history': jsonEncode([newHistoryEntry]),
//             });
//           } else {
//             debugPrint('Updating existing balance');
//             double currentBalance = currentResponse['balance'] ?? 0.0;
//             dynamic historyData = currentResponse['transaction_history'];
//             List<dynamic> history;
//             if (historyData is List) {
//               history = historyData;
//             } else if (historyData is String) {
//               history = jsonDecode(historyData);
//             } else {
//               history = [];
//             }
//             history.add(newHistoryEntry);
//             await Supabase.instance.client.from('user_balances').update({
//               'balance': currentBalance + baseReward,
//               'transaction_history': jsonEncode(history),
//             }).eq('user_id', userId);
//           }
//           debugPrint('Balance updated');

//           await _loadAdsWatched();
//           setState(() {
//             _isOnCooldown = true;
//             _remainingCooldown = const Duration(seconds: 30); // Set to 30 seconds
//           });
//           _startCooldownTimer();
//         } catch (e) {
//           debugPrint('Error updating balance: $e');
//           if (mounted) {
//             ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Failed to update balance: $e')));
//           }
//         }
//       },
//     );
//     _rewardedAd = null;
//     _loadAd();
//   }

//   void _startCooldownTimer() {
//     _cooldownTimer?.cancel(); // Cancel any existing timer
//     _cooldownTimer = Timer.periodic(const Duration(seconds: 1), (timer) {
//       if (_remainingCooldown.inSeconds <= 0) {
//         timer.cancel();
//         setState(() {
//           _isOnCooldown = false;
//           _remainingCooldown = Duration.zero;
//         });
//       } else {
//         setState(() {
//           _remainingCooldown = _remainingCooldown - const Duration(seconds: 1);
//         });
//       }
//     });
//   }

//   String _formatCooldown() {
//     final minutes = _remainingCooldown.inMinutes;
//     final seconds = _remainingCooldown.inSeconds % 60;
//     return '$minutes:${seconds.toString().padLeft(2, '0')}';
//   }

//   @override
//   void dispose() {
//     _cooldownTimer?.cancel();
//     _rewardedAd?.dispose();
//     super.dispose();
//   }

//   @override
//   Widget build(BuildContext context) {
//     return Scaffold(
//       backgroundColor: Colors.black,
//       appBar: AppBar(title: const Text('Ads')),
//       body: Center(
//         child: Column(
//           mainAxisAlignment: MainAxisAlignment.center,
//           children: [
//             Text('Ads Watched: $_adsWatched / 16', style: const TextStyle(color: Colors.white)),
//             const SizedBox(height: 10),
//             Text(
//               _isOnCooldown ? 'Cooldown: ${_formatCooldown()}' : 'Ready to watch ad!',
//               style: const TextStyle(color: Colors.white, fontSize: 16),
//             ),
//             const SizedBox(height: 10),
//             ElevatedButton(
//               onPressed: _isAdReady && !_isOnCooldown ? _showAd : () {}, // Empty function to keep button visible
//               style: ElevatedButton.styleFrom(
//                 backgroundColor: _isOnCooldown ? Colors.grey : Colors.yellow, // Grey during cooldown, yellow otherwise
//                 foregroundColor: Colors.black, // Text/icon color
//                 minimumSize: const Size(200, 50), // Ensure consistent size
//               ),
//               child: Text(_isOnCooldown ? 'Wait: ${_formatCooldown()}' : 'Watch Ad'),
//             ),
//           ],
//         ),
//       ),
//     );
//   }
// }

// import 'dart:async';
// import 'dart:convert';
// import 'dart:io';

// import 'package:flutter/material.dart';
// import 'package:google_mobile_ads/google_mobile_ads.dart' hide AppState;
// import 'package:provider/provider.dart';
// import 'package:supabase_flutter/supabase_flutter.dart';
// import 'package:regt_app/providers/app_state.dart';

// class AdsScreen extends StatefulWidget {
//   const AdsScreen({super.key});

//   @override
//   State<AdsScreen> createState() => _AdsScreenState();
// }

// class _AdsScreenState extends State<AdsScreen> {
//   RewardedAd? _rewardedAd;
//   int _adsWatched = 0;
//   bool _isAdReady = false;
//   bool _isOnCooldown = false;
//   Duration _remainingCooldown = Duration.zero;
//   Timer? _cooldownTimer;
//   double _lastReward = 0.0;

//   String get _adUnitId {
//     if (Platform.isAndroid) {
//       return 'ca-app-pub-3940256099942544/5224354917';  // Test
//     } else {
//       return 'ca-app-pub-3940256099942544/1712485313';  // Test
//     }
//   }

//   @override
//   void initState() {
//     super.initState();
//     _loadAd();
//     _loadAdsWatched();
//   }

//   Future<void> _loadAdsWatched() async {
//     final userId = Supabase.instance.client.auth.currentUser?.id;
//     if (userId == null) return;

//     final today = DateTime.now().subtract(const Duration(days: 1)).toIso8601String();
//     try {
//       final response = await Supabase.instance.client
//           .from('ad_events')
//           .select()
//           .eq('user_id', userId)
//           .eq('status', 'success')
//           .gte('timestamp', today)
//           .count(CountOption.exact);
//       setState(() {
//         _adsWatched = response.count ?? 0;
//       });
//       debugPrint('Loaded ads watched: $_adsWatched');
//     } catch (e) {
//       debugPrint('Error loading ads watched: $e');
//       setState(() {
//         _adsWatched = 0;
//       });
//     }
//   }

//   void _loadAd() {
//     RewardedAd.load(
//       adUnitId: _adUnitId,
//       request: const AdRequest(),
//       rewardedAdLoadCallback: RewardedAdLoadCallback(
//         onAdLoaded: (ad) {
//           debugPrint('Ad loaded');
//           setState(() {
//             _rewardedAd = ad;
//             _isAdReady = true;
//           });
//           ad.fullScreenContentCallback = FullScreenContentCallback(
//             onAdShowedFullScreenContent: (ad) => debugPrint('Ad showed full screen'),
//             onAdFailedToShowFullScreenContent: (ad, error) {
//               debugPrint('Ad failed to show: $error');
//               ad.dispose();
//               _loadAd();
//             },
//             onAdDismissedFullScreenContent: (ad) {
//               debugPrint('Ad dismissed');
//               ad.dispose();
//               _loadAd();
//             },
//           );
//         },
//         onAdFailedToLoad: (error) {
//           debugPrint('Ad failed to load: $error');
//           Future.delayed(const Duration(seconds: 5), _loadAd); // Add delay to prevent rapid retry loops
//         },
//       ),
//     );
//   }

//   void _showAd() async {
//     if (_rewardedAd == null || _isOnCooldown || _adsWatched >= 16) {
//       debugPrint('Cannot show ad: ${_rewardedAd == null ? 'No ad' : ''} ${_isOnCooldown ? 'Cooldown' : ''} ${ _adsWatched >= 16 ? 'Max ads' : ''}');
//       ScaffoldMessenger.of(context).showSnackBar(
//         SnackBar(
//           content: Text(_adsWatched >= 16 ? 'No ads left for today!' : 'Please wait ${_formatCooldown()} before watching another ad'),
//         ),
//       );
//       return;
//     }

//     debugPrint('Showing ad');
//     _rewardedAd!.show(
//       onUserEarnedReward: (ad, reward) async {
//         debugPrint('Reward earned! Type: ${reward.type}, Amount: ${reward.amount}');
//         double baseReward = 0.006;
//         _adsWatched++;
//         if (_adsWatched % 10 == 0) baseReward += 1.0;
//         final userId = Supabase.instance.client.auth.currentUser?.id;
//         if (userId == null) return;

//         try {
//           debugPrint('Inserting ad event');
//           await Supabase.instance.client.from('ad_events').insert({
//             'user_id': userId,
//             'status': 'success',
//             'reward': baseReward,
//             'timestamp': DateTime.now().toIso8601String(),
//             'ip_address': 'dummy',
//           });
//           debugPrint('Ad event inserted');

//           debugPrint('Fetching current balance');
//           final currentResponse = await Supabase.instance.client
//               .from('user_balances')
//               .select('balance, transaction_history')
//               .eq('user_id', userId)
//               .maybeSingle();

//           final newHistoryEntry = {
//             'type': 'ad_reward',
//             'amount': baseReward,
//             'date': DateTime.now().toIso8601String(),
//           };

//           double newBalance;
//           if (currentResponse == null) {
//             debugPrint('No balance row - inserting new');
//             await Supabase.instance.client.from('user_balances').insert({
//               'user_id': userId,
//               'balance': baseReward,
//               'transaction_history': jsonEncode([newHistoryEntry]),
//             });
//             newBalance = baseReward;
//           } else {
//             debugPrint('Updating existing balance');
//             double currentBalance = currentResponse['balance'] ?? 0.0;
//             dynamic historyData = currentResponse['transaction_history'];
//             List<dynamic> history;
//             if (historyData is List) {
//               history = historyData;
//             } else if (historyData is String) {
//               history = jsonDecode(historyData);
//             } else {
//               history = [];
//             }
//             history.add(newHistoryEntry);
//             await Supabase.instance.client.from('user_balances').update({
//               'balance': currentBalance + baseReward,
//               'transaction_history': jsonEncode(history),
//             }).eq('user_id', userId);
//             newBalance = currentBalance + baseReward;
//           }
//           debugPrint('Balance updated');

//           Provider.of<AppState>(context, listen: false).updateBalance(newBalance);

//           await _loadAdsWatched();
//           setState(() {
//             _isOnCooldown = true;
//             _remainingCooldown = const Duration(seconds: 30); // Set to 30 seconds
//             _lastReward = baseReward;
//           });
//           _startCooldownTimer();
//           _showRewardModal();
//         } catch (e) {
//           debugPrint('Error updating balance: $e');
//           if (mounted) {
//             ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Failed to update balance: $e')));
//           }
//         }
//       },
//     );
//     _rewardedAd = null;
//     _loadAd();
//   }

//   void _startCooldownTimer() {
//     _cooldownTimer?.cancel(); // Cancel any existing timer
//     _cooldownTimer = Timer.periodic(const Duration(seconds: 1), (timer) {
//       if (_remainingCooldown.inSeconds <= 0) {
//         timer.cancel();
//         setState(() {
//           _isOnCooldown = false;
//           _remainingCooldown = Duration.zero;
//         });
//       } else {
//         setState(() {
//           _remainingCooldown = _remainingCooldown - const Duration(seconds: 1);
//         });
//       }
//     });
//   }

//   String _formatCooldown() {
//     final minutes = _remainingCooldown.inMinutes;
//     final seconds = _remainingCooldown.inSeconds % 60;
//     return '$minutes:${seconds.toString().padLeft(2, '0')}';
//   }

//   void _showRewardModal() {
//     showDialog(
//       context: context,
//       builder: (context) => AlertDialog(
//         backgroundColor: const Color(0xFF1A1A1A),
//         shape: RoundedRectangleBorder(
//           borderRadius: BorderRadius.circular(12),
//           side: BorderSide(color: const Color(0xFFFFD700).withOpacity(0.2)),
//         ),
//         content: Column(
//           mainAxisSize: MainAxisSize.min,
//           children: [
//             Container(
//               width: 64,
//               height: 64,
//               decoration: const BoxDecoration(
//                 color: Color(0xFFFFD700),
//                 shape: BoxShape.circle,
//               ),
//               child: const Icon(
//                 Icons.card_giftcard,
//                 size: 32,
//                 color: Colors.black,
//               ),
//             ),
//             const SizedBox(height: 16),
//             const Text(
//               'Reward Earned!',
//               style: TextStyle(
//                 color: Colors.white,
//                 fontSize: 20,
//                 fontWeight: FontWeight.bold,
//               ),
//             ),
//             const SizedBox(height: 8),
//             Text(
//               '+${_lastReward.toStringAsFixed(4)} REGT',
//               style: const TextStyle(
//                 color: Color(0xFFFFD700),
//                 fontSize: 24,
//                 fontWeight: FontWeight.bold,
//               ),
//             ),
//           ],
//         ),
//         actions: [
//           ElevatedButton(
//             onPressed: () => Navigator.pop(context),
//             style: ElevatedButton.styleFrom(
//               backgroundColor: const Color(0xFFFFD700),
//               foregroundColor: Colors.black,
//             ),
//             child: const Text('Awesome!'),
//           ),
//         ],
//       ),
//     );
//   }

//   @override
//   void dispose() {
//     _cooldownTimer?.cancel();
//     _rewardedAd?.dispose();
//     super.dispose();
//   }

//   @override
//   Widget build(BuildContext context) {
//     final appState = Provider.of<AppState>(context);
//     final balance = appState.balance;
//     final usdRate = 0.1; // Assuming same as home
//     final adsLeft = 16 - _adsWatched;

//     final sampleAds = [
//       {
//         'title': 'Fashion Forward',
//         'description': 'Discover the latest fashion trends for 2024',
//         'category': 'Fashion',
//       },
//       {
//         'title': 'Tech Revolution',
//         'description': 'Experience the future of technology today',
//         'category': 'Technology',
//       },
//       {
//         'title': 'Health & Fitness',
//         'description': 'Transform your lifestyle with our fitness program',
//         'category': 'Health',
//       },
//       {
//         'title': 'Travel Paradise',
//         'description': 'Explore exotic destinations around the world',
//         'category': 'Travel',
//       },
//       {
//         'title': 'Gourmet Delights',
//         'description': 'Culinary experiences that will amaze you',
//         'category': 'Food',
//       },
//       {
//         'title': 'Smart Home',
//         'description': 'Make your home intelligent and efficient',
//         'category': 'Technology',
//       },
//     ];

//     return Scaffold(
//       backgroundColor: Colors.black,
//       body: Column(
//         children: [
//           // Header
//           Padding(
//             padding: const EdgeInsets.symmetric(horizontal: 16.0, vertical: 8.0),
//             child: Row(
//               mainAxisAlignment: MainAxisAlignment.spaceBetween,
//               children: [
//                 Row(
//                   children: [
//                     Container(
//                       width: 32,
//                       height: 32,
//                       decoration: const BoxDecoration(
//                         color: Color(0xFFFFD700),
//                         shape: BoxShape.circle,
//                       ),
//                       child: const Center(
//                         child: Text(
//                           'R',
//                           style: TextStyle(
//                             color: Colors.black,
//                             fontWeight: FontWeight.bold,
//                           ),
//                         ),
//                       ),
//                     ),
//                     const SizedBox(width: 8),
//                     const Text(
//                       'REGT Earn',
//                       style: TextStyle(
//                         color: Colors.white,
//                         fontSize: 18,
//                         fontWeight: FontWeight.bold,
//                       ),
//                     ),
//                   ],
//                 ),
//                 Row(
//                   children: [
//                     Text(
//                       '${balance.toStringAsFixed(2)} REGT',
//                       style: const TextStyle(
//                         color: Colors.white,
//                         fontWeight: FontWeight.bold,
//                       ),
//                     ),
//                     const SizedBox(width: 4),
//                     Text(
//                       '\$${ (balance * usdRate).toStringAsFixed(2) }',
//                       style: const TextStyle(color: Colors.grey),
//                     ),
//                   ],
//                 ),
//               ],
//             ),
//           ),
//           // Ads Progress
//           Padding(
//             padding: const EdgeInsets.all(16.0),
//             child: Container(
//               decoration: BoxDecoration(
//                 color: const Color(0xFF1A1A1A),
//                 borderRadius: BorderRadius.circular(8),
//               ),
//               padding: const EdgeInsets.all(16.0),
//               child: Column(
//                 crossAxisAlignment: CrossAxisAlignment.start,
//                 children: [
//                   Row(
//                     mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                     children: [
//                       const Text(
//                         'Watch Ads',
//                         style: TextStyle(color: Colors.white, fontSize: 16),
//                       ),
//                       Text(
//                         '$adsLeft/16 Left',
//                         style: const TextStyle(color: Colors.grey),
//                       ),
//                     ],
//                   ),
//                   const SizedBox(height: 8),
//                   LinearProgressIndicator(
//                     value: _adsWatched / 16,
//                     backgroundColor: Colors.grey[800],
//                     color: const Color(0xFFFFD700),
//                     minHeight: 6,
//                   ),
//                 ],
//               ),
//             ),
//           ),
//           // Ads List
//           Expanded(
//             child: ListView.builder(
//               padding: const EdgeInsets.symmetric(horizontal: 16.0),
//               itemCount: sampleAds.length,
//               itemBuilder: (context, index) {
//                 final ad = sampleAds[index];
//                 return Padding(
//                   padding: const EdgeInsets.only(bottom: 12.0),
//                   child: Container(
//                     decoration: BoxDecoration(
//                       color: const Color(0xFF1A1A1A),
//                       borderRadius: BorderRadius.circular(8),
//                     ),
//                     padding: const EdgeInsets.all(12.0),
//                     child: Row(
//                       children: [
//                         Container(
//                           width: 40,
//                           height: 40,
//                           decoration: BoxDecoration(
//                             color: Colors.grey[800],
//                             shape: BoxShape.circle,
//                           ),
//                           child: const Icon(
//                             Icons.play_arrow,
//                             color: Colors.white,
//                           ),
//                         ),
//                         const SizedBox(width: 12),
//                         Expanded(
//                           child: Column(
//                             crossAxisAlignment: CrossAxisAlignment.start,
//                             children: [
//                               Text(
//                                 ad['title'] as String,
//                                 style: const TextStyle(
//                                   color: Colors.white,
//                                   fontWeight: FontWeight.bold,
//                                 ),
//                               ),
//                               Text(
//                                 ad['description'] as String,
//                                 style: const TextStyle(color: Colors.grey),
//                               ),
//                               const SizedBox(height: 8),
//                               Row(
//                                 children: [
//                                   Container(
//                                     decoration: BoxDecoration(
//                                       color: Colors.grey[800],
//                                       borderRadius: BorderRadius.circular(12),
//                                     ),
//                                     padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
//                                     child: const Row(
//                                       children: [
//                                         Icon(Icons.timer, size: 12, color: Colors.grey),
//                                         SizedBox(width: 4),
//                                         Text(
//                                           '30s',
//                                           style: TextStyle(color: Colors.grey, fontSize: 12),
//                                         ),
//                                       ],
//                                     ),
//                                   ),
//                                   const SizedBox(width: 8),
//                                   const Text(
//                                     '+0.006 REGT',
//                                     style: TextStyle(color: Color(0xFFFFD700), fontSize: 12),
//                                   ),
//                                   const SizedBox(width: 8),
//                                   Container(
//                                     decoration: BoxDecoration(
//                                       color: Colors.grey[800],
//                                       borderRadius: BorderRadius.circular(12),
//                                     ),
//                                     padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
//                                     child: Text(
//                                       ad['category'] as String,
//                                       style: const TextStyle(color: Colors.grey, fontSize: 12),
//                                     ),
//                                   ),
//                                 ],
//                               ),
//                             ],
//                           ),
//                         ),
//                         ElevatedButton(
//                           onPressed: adsLeft > 0 && !_isOnCooldown ? _showAd : null,
//                           style: ElevatedButton.styleFrom(
//                             backgroundColor: const Color(0xFFFFD700),
//                             foregroundColor: Colors.black,
//                             shape: RoundedRectangleBorder(
//                               borderRadius: BorderRadius.circular(8),
//                             ),
//                           ),
//                           child: const Text('Watch'),
//                         ),
//                       ],
//                     ),
//                   ),
//                 );
//               },
//             ),
//           ),
//           // Bonus Info
//           Container(
//             color: Colors.transparent,
//             padding: const EdgeInsets.all(16.0),
//             child: Container(
//               decoration: BoxDecoration(
//                 gradient: LinearGradient(
//                   colors: [const Color(0xFFFFD700).withOpacity(0.1), const Color(0xFFFFA500).withOpacity(0.1)],
//                 ),
//                 border: Border.all(color: const Color(0xFFFFD700).withOpacity(0.2)),
//                 borderRadius: BorderRadius.circular(8),
//               ),
//               padding: const EdgeInsets.all(16.0),
//               child: Row(
//                 children: [
//                   const Icon(Icons.star, color: Color(0xFFFFD700)),
//                   const SizedBox(width: 8),
//                   const Text(
//                     'Bonus Rewards',
//                     style: TextStyle(color: Color(0xFFFFD700), fontWeight: FontWeight.w100),
//                   ),
//                   const SizedBox(width: 8),
//                   Expanded(
//                     child: Text(
//                       'Watch 10 ads to earn a bonus +1 REGT! (${_adsWatched % 10}/10)',
//                       style: const TextStyle(color: Colors.grey),
//                     ),
//                   ),
//                 ],
//               ),
//             ),
//           ),
//         ],
//       ),
//     );
//   }
// }

// import 'dart:async';
// import 'dart:convert';
// import 'dart:io';

// import 'package:flutter/material.dart';
// import 'package:google_mobile_ads/google_mobile_ads.dart' hide AppState;
// import 'package:provider/provider.dart';
// import 'package:supabase_flutter/supabase_flutter.dart';
// import 'package:regt_app/providers/app_state.dart';

// class AdsScreen extends StatefulWidget {
//   const AdsScreen({super.key});

//   @override
//   State<AdsScreen> createState() => _AdsScreenState();
// }

// class _AdsScreenState extends State<AdsScreen> {
//   RewardedAd? _rewardedAd;
//   int _adsWatched = 0;
//   bool _isAdReady = false;
//   bool _isOnCooldown = false;
//   Duration _remainingCooldown = Duration.zero;
//   Timer? _cooldownTimer;
//   double _lastReward = 0.0;

//   String get _adUnitId {
//     if (Platform.isAndroid) {
//       return 'ca-app-pub-3940256099942544/5224354917';  // Test
//     } else {
//       return 'ca-app-pub-3940256099942544/1712485313';  // Test
//     }
//   }

//   @override
//   void initState() {
//     super.initState();
//     _loadAd();
//     _loadAdsWatched();
//   }

//   Future<void> _loadAdsWatched() async {
//     final userId = Supabase.instance.client.auth.currentUser?.id;
//     if (userId == null) return;

//     final today = DateTime.now().subtract(const Duration(days: 1)).toIso8601String();
//     try {
//       final response = await Supabase.instance.client
//           .from('ad_events')
//           .select()
//           .eq('user_id', userId)
//           .eq('status', 'success')
//           .gte('timestamp', today)
//           .count(CountOption.exact);
//       setState(() {
//         _adsWatched = response.count ?? 0;
//       });
//       debugPrint('Loaded ads watched: $_adsWatched');
//     } catch (e) {
//       debugPrint('Error loading ads watched: $e');
//       setState(() {
//         _adsWatched = 0;
//       });
//     }
//   }

//   void _loadAd() {
//     RewardedAd.load(
//       adUnitId: _adUnitId,
//       request: const AdRequest(),
//       rewardedAdLoadCallback: RewardedAdLoadCallback(
//         onAdLoaded: (ad) {
//           debugPrint('Ad loaded');
//           setState(() {
//             _rewardedAd = ad;
//             _isAdReady = true;
//           });
//           ad.fullScreenContentCallback = FullScreenContentCallback(
//             onAdShowedFullScreenContent: (ad) => debugPrint('Ad showed full screen'),
//             onAdFailedToShowFullScreenContent: (ad, error) {
//               debugPrint('Ad failed to show: $error');
//               ad.dispose();
//               _loadAd();
//             },
//             onAdDismissedFullScreenContent: (ad) {
//               debugPrint('Ad dismissed');
//               ad.dispose();
//               _loadAd();
//             },
//           );
//         },
//         onAdFailedToLoad: (error) {
//           debugPrint('Ad failed to load: $error');
//           Future.delayed(const Duration(seconds: 5), _loadAd); // Add delay to prevent rapid retry loops
//         },
//       ),
//     );
//   }

//   void _showAd() async {
//     if (_rewardedAd == null || _isOnCooldown || _adsWatched >= 16) {
//       debugPrint('Cannot show ad: ${_rewardedAd == null ? 'No ad' : ''} ${_isOnCooldown ? 'Cooldown' : ''} ${ _adsWatched >= 16 ? 'Max ads' : ''}');
//       ScaffoldMessenger.of(context).showSnackBar(
//         SnackBar(
//           content: Text(_adsWatched >= 16 ? 'No ads left for today!' : 'Please wait ${_formatCooldown()} before watching another ad'),
//         ),
//       );
//       return;
//     }

//     debugPrint('Showing ad');
//     _rewardedAd!.show(
//       onUserEarnedReward: (ad, reward) async {
//         debugPrint('Reward earned! Type: ${reward.type}, Amount: ${reward.amount}');
//         double baseReward = 0.006;
//         _adsWatched++;
//         if (_adsWatched % 10 == 0) baseReward += 1.0;
//         final userId = Supabase.instance.client.auth.currentUser?.id;
//         if (userId == null) return;

//         try {
//           debugPrint('Inserting ad event');
//           await Supabase.instance.client.from('ad_events').insert({
//             'user_id': userId,
//             'status': 'success',
//             'reward': baseReward,
//             'timestamp': DateTime.now().toIso8601String(),
//             'ip_address': 'dummy',
//           });
//           debugPrint('Ad event inserted');

//           debugPrint('Fetching current balance');
//           final currentResponse = await Supabase.instance.client
//               .from('user_balances')
//               .select('balance, transaction_history')
//               .eq('user_id', userId)
//               .maybeSingle();

//           final newHistoryEntry = {
//             'type': 'ad_reward',
//             'amount': baseReward,
//             'date': DateTime.now().toIso8601String(),
//           };

//           double newBalance;
//           if (currentResponse == null) {
//             debugPrint('No balance row - inserting new');
//             await Supabase.instance.client.from('user_balances').insert({
//               'user_id': userId,
//               'balance': baseReward,
//               'transaction_history': jsonEncode([newHistoryEntry]),
//             });
//             newBalance = baseReward;
//           } else {
//             debugPrint('Updating existing balance');
//             double currentBalance = currentResponse['balance'] ?? 0.0;
//             dynamic historyData = currentResponse['transaction_history'];
//             List<dynamic> history;
//             if (historyData is List) {
//               history = historyData;
//             } else if (historyData is String) {
//               history = jsonDecode(historyData);
//             } else {
//               history = [];
//             }
//             history.add(newHistoryEntry);
//             await Supabase.instance.client.from('user_balances').update({
//               'balance': currentBalance + baseReward,
//               'transaction_history': jsonEncode(history),
//             }).eq('user_id', userId);
//             newBalance = currentBalance + baseReward;
//           }
//           debugPrint('Balance updated');

//           Provider.of<AppState>(context, listen: false).updateBalance(newBalance);

//           await _loadAdsWatched();
//           setState(() {
//             _isOnCooldown = true;
//             _remainingCooldown = const Duration(seconds: 30); // Set to 30 seconds
//             _lastReward = baseReward;
//           });
//           _startCooldownTimer();
//           _showRewardModal();
//         } catch (e) {
//           debugPrint('Error updating balance: $e');
//           if (mounted) {
//             ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Failed to update balance: $e')));
//           }
//         }
//       },
//     );
//     _rewardedAd = null;
//     _loadAd();
//   }

//   void _startCooldownTimer() {
//     _cooldownTimer?.cancel(); // Cancel any existing timer
//     _cooldownTimer = Timer.periodic(const Duration(seconds: 1), (timer) {
//       if (_remainingCooldown.inSeconds <= 0) {
//         timer.cancel();
//         setState(() {
//           _isOnCooldown = false;
//           _remainingCooldown = Duration.zero;
//         });
//       } else {
//         setState(() {
//           _remainingCooldown = _remainingCooldown - const Duration(seconds: 1);
//         });
//       }
//     });
//   }

//   String _formatCooldown() {
//     final minutes = _remainingCooldown.inMinutes;
//     final seconds = _remainingCooldown.inSeconds % 60;
//     return '$minutes:${seconds.toString().padLeft(2, '0')}';
//   }

//   void _showRewardModal() {
//     showDialog(
//       context: context,
//       builder: (context) => AlertDialog(
//         backgroundColor: const Color(0xFF1A1A1A),
//         shape: RoundedRectangleBorder(
//           borderRadius: BorderRadius.circular(12),
//           side: BorderSide(color: const Color(0xFFFFD700).withOpacity(0.2)),
//         ),
//         content: Column(
//           mainAxisSize: MainAxisSize.min,
//           children: [
//             Container(
//               width: 64,
//               height: 64,
//               decoration: const BoxDecoration(
//                 color: Color(0xFFFFD700),
//                 shape: BoxShape.circle,
//               ),
//               child: const Icon(
//                 Icons.card_giftcard,
//                 size: 32,
//                 color: Colors.black,
//               ),
//             ),
//             const SizedBox(height: 16),
//             const Text(
//               'Reward Earned!',
//               style: TextStyle(
//                 color: Colors.white,
//                 fontSize: 20,
//                 fontWeight: FontWeight.bold,
//               ),
//             ),
//             const SizedBox(height: 8),
//             Text(
//               '+${_lastReward.toStringAsFixed(4)} REGT',
//               style: const TextStyle(
//                 color: Color(0xFFFFD700),
//                 fontSize: 24,
//                 fontWeight: FontWeight.bold,
//               ),
//             ),
//           ],
//         ),
//         actions: [
//           ElevatedButton(
//             onPressed: () => Navigator.pop(context),
//             style: ElevatedButton.styleFrom(
//               backgroundColor: const Color(0xFFFFD700),
//               foregroundColor: Colors.black,
//             ),
//             child: const Text('Awesome!'),
//           ),
//         ],
//       ),
//     );
//   }

//   @override
//   void dispose() {
//     _cooldownTimer?.cancel();
//     _rewardedAd?.dispose();
//     super.dispose();
//   }

//   @override
//   Widget build(BuildContext context) {
//     final appState = Provider.of<AppState>(context);
//     final balance = appState.balance;
//     final usdRate = 0.1; // Assuming same as home
//     final adsLeft = 16 - _adsWatched;

//     return Scaffold(
//       backgroundColor: Colors.black,
//       body: Column(
//         children: [
//           // Header
//           Padding(
//             padding: const EdgeInsets.symmetric(horizontal: 16.0, vertical: 8.0),
//             child: Row(
//               mainAxisAlignment: MainAxisAlignment.spaceBetween,
//               children: [
//                 Row(
//                   children: [
//                     Container(
//                       width: 32,
//                       height: 32,
//                       decoration: const BoxDecoration(
//                         color: Color(0xFFFFD700),
//                         shape: BoxShape.circle,
//                       ),
//                       child: const Center(
//                         child: Text(
//                           'R',
//                           style: TextStyle(
//                             color: Colors.black,
//                             fontWeight: FontWeight.bold,
//                           ),
//                         ),
//                       ),
//                     ),
//                     const SizedBox(width: 8),
//                     const Text(
//                       'REGT Earn',
//                       style: TextStyle(
//                         color: Colors.white,
//                         fontSize: 18,
//                         fontWeight: FontWeight.bold,
//                       ),
//                     ),
//                   ],
//                 ),
//                 Row(
//                   children: [
//                     Text(
//                       '${balance.toStringAsFixed(2)} REGT',
//                       style: const TextStyle(
//                         color: Colors.white,
//                         fontWeight: FontWeight.bold,
//                       ),
//                     ),
//                     const SizedBox(width: 4),
//                     Text(
//                       '\$${ (balance * usdRate).toStringAsFixed(2) }',
//                       style: const TextStyle(color: Colors.grey),
//                     ),
//                   ],
//                 ),
//               ],
//             ),
//           ),
//           // Ads Progress
//           Padding(
//             padding: const EdgeInsets.all(16.0),
//             child: Container(
//               decoration: BoxDecoration(
//                 color: const Color(0xFF1A1A1A),
//                 borderRadius: BorderRadius.circular(8),
//               ),
//               padding: const EdgeInsets.all(16.0),
//               child: Column(
//                 crossAxisAlignment: CrossAxisAlignment.start,
//                 children: [
//                   Row(
//                     mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                     children: [
//                       const Text(
//                         'Watch Ads',
//                         style: TextStyle(color: Colors.white, fontSize: 16),
//                       ),
//                       Text(
//                         '$adsLeft/16 Left',
//                         style: const TextStyle(color: Colors.grey),
//                       ),
//                     ],
//                   ),
//                   const SizedBox(height: 8),
//                   LinearProgressIndicator(
//                     value: _adsWatched / 16,
//                     backgroundColor: Colors.grey[800],
//                     color: const Color(0xFFFFD700),
//                     minHeight: 6,
//                   ),
//                 ],
//               ),
//             ),
//           ),
//           // Main Content
//           Expanded(
//             child: Center(
//               child: Column(
//                 mainAxisAlignment: MainAxisAlignment.center,
//                 children: [
//                   Text(
//                     'Ads Watched: $_adsWatched / 16',
//                     style: const TextStyle(color: Colors.white, fontSize: 18),
//                   ),
//                   const SizedBox(height: 16),
//                   Text(
//                     _isOnCooldown ? 'Cooldown: ${_formatCooldown()}' : 'Ready to watch ad!',
//                     style: const TextStyle(color: Colors.white, fontSize: 16),
//                   ),
//                   const SizedBox(height: 16),
//                   ElevatedButton(
//                     onPressed: _isAdReady && !_isOnCooldown && adsLeft > 0 ? _showAd : null,
//                     style: ElevatedButton.styleFrom(
//                       backgroundColor: _isOnCooldown || adsLeft <= 0 ? Colors.grey : const Color(0xFFFFD700),
//                       foregroundColor: Colors.black,
//                       minimumSize: const Size(200, 50),
//                       shape: RoundedRectangleBorder(
//                         borderRadius: BorderRadius.circular(8),
//                       ),
//                     ),
//                     child: Text(
//                       _isOnCooldown ? 'Wait: ${_formatCooldown()}' : (adsLeft <= 0 ? 'No Ads Left' : 'Watch Ad'),
//                     ),
//                   ),
//                 ],
//               ),
//             ),
//           ),
//           // Bonus Info
//           Container(
//             color: Colors.transparent,
//             padding: const EdgeInsets.all(16.0),
//             child: Container(
//               decoration: BoxDecoration(
//                 gradient: LinearGradient(
//                   colors: [const Color(0xFFFFD700).withOpacity(0.1), const Color(0xFFFFA500).withOpacity(0.1)],
//                 ),
//                 border: Border.all(color: const Color(0xFFFFD700).withOpacity(0.2)),
//                 borderRadius: BorderRadius.circular(8),
//               ),
//               padding: const EdgeInsets.all(16.0),
//               child: Row(
//                 children: [
//                   const Icon(Icons.star, color: Color(0xFFFFD700)),
//                   const SizedBox(width: 8),
//                   const Text(
//                     'Bonus Rewards',
//                     style: TextStyle(color: Color(0xFFFFD700), fontWeight: FontWeight.w100),
//                   ),
//                   const SizedBox(width: 8),
//                   Expanded(
//                     child: Text(
//                       'Watch 10 ads to earn a bonus +1 REGT! (${_adsWatched % 10}/10)',
//                       style: const TextStyle(color: Colors.grey),
//                     ),
//                   ),
//                 ],
//               ),
//             ),
//           ),
//         ],
//       ),
//     );
//   }
// }

//********************************
//

import 'dart:async';
import 'dart:convert';
import 'dart:io';

import 'package:flutter/material.dart';
import 'package:google_mobile_ads/google_mobile_ads.dart' hide AppState;
import 'package:provider/provider.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:regt_app/providers/app_state.dart';

class AdsScreen extends StatefulWidget {
  const AdsScreen({super.key});

  @override
  State<AdsScreen> createState() => _AdsScreenState();
}

class _AdsScreenState extends State<AdsScreen> {
  RewardedAd? _rewardedAd;
  int _adsWatched = 0;
  bool _isAdReady = false;
  bool _isOnCooldown = false;
  Duration _remainingCooldown = Duration.zero;
  Timer? _cooldownTimer;
  double _lastReward = 0.0;

  String get _adUnitId {
    if (Platform.isAndroid) {
      return 'ca-app-pub-3940256099942544/5224354917'; // Test
    } else {
      return 'ca-app-pub-3940256099942544/1712485313'; // Test
    }
  }

  @override
  void initState() {
    super.initState();
    _loadAd();
    _loadAdsWatched();
  }

  Future<void> _loadAdsWatched() async {
    final userId = Supabase.instance.client.auth.currentUser?.id;
    if (userId == null) return;

    final today = DateTime.now()
        .subtract(const Duration(days: 1))
        .toIso8601String();
    try {
      final response = await Supabase.instance.client
          .from('ad_events')
          .select()
          .eq('user_id', userId)
          .eq('status', 'success')
          .gte('timestamp', today)
          .count(CountOption.exact);
      setState(() {
        _adsWatched = response.count;
      });
      debugPrint('Loaded ads watched: $_adsWatched');
    } catch (e) {
      debugPrint('Error loading ads watched: $e');
      setState(() {
        _adsWatched = 0;
      });
    }
  }

  void _loadAd() {
    RewardedAd.load(
      adUnitId: _adUnitId,
      request: const AdRequest(),
      rewardedAdLoadCallback: RewardedAdLoadCallback(
        onAdLoaded: (ad) {
          debugPrint('Ad loaded');
          setState(() {
            _rewardedAd = ad;
            _isAdReady = true;
          });
          ad.fullScreenContentCallback = FullScreenContentCallback(
            onAdShowedFullScreenContent: (ad) =>
                debugPrint('Ad showed full screen'),
            onAdFailedToShowFullScreenContent: (ad, error) {
              debugPrint('Ad failed to show: $error');
              ad.dispose();
              _loadAd();
            },
            onAdDismissedFullScreenContent: (ad) {
              debugPrint('Ad dismissed');
              ad.dispose();
              _loadAd();
            },
          );
        },
        onAdFailedToLoad: (error) {
          debugPrint('Ad failed to load: $error');
          Future.delayed(
            const Duration(seconds: 5),
            _loadAd,
          ); // Add delay to prevent rapid retry loops
        },
      ),
    );
  }

  void _showAd() async {
    if (_rewardedAd == null || _isOnCooldown || _adsWatched >= 16) {
      debugPrint(
        'Cannot show ad: ${_rewardedAd == null ? 'No ad' : ''} ${_isOnCooldown ? 'Cooldown' : ''} ${_adsWatched >= 16 ? 'Max ads' : ''}',
      );
      return;
    }

    debugPrint('Showing ad');
    _rewardedAd!.show(
      onUserEarnedReward: (ad, reward) async {
        debugPrint(
          'Reward earned! Type: ${reward.type}, Amount: ${reward.amount}',
        );
        double baseReward = 0.006;
        _adsWatched++;
        if (_adsWatched % 10 == 0) baseReward += 1.0;
        final userId = Supabase.instance.client.auth.currentUser?.id;
        if (userId == null) return;

        try {
          debugPrint('Inserting ad event');
          await Supabase.instance.client.from('ad_events').insert({
            'user_id': userId,
            'status': 'success',
            'reward': baseReward,
            'timestamp': DateTime.now().toIso8601String(),
            'ip_address': 'dummy',
          });
          debugPrint('Ad event inserted');

          debugPrint('Fetching current balance');
          final currentResponse = await Supabase.instance.client
              .from('profiles')
              .select('balancing, transaction_history')
              .eq('id', userId)
              .maybeSingle();

          final newHistoryEntry = {
            'type': 'ad_reward',
            'amount': baseReward,
            'date': DateTime.now().toIso8601String(),
          };

          double newBalance;
          List<dynamic> history = [];

          if (currentResponse == null) {
            debugPrint('No balance row - inserting new');
            newBalance = baseReward;
            history = [newHistoryEntry];
            await Supabase.instance.client.from('profiles').insert({
              'id': userId,
              'balancing': newBalance,
              'transaction_history': jsonEncode(history),
            });
          } else {
            debugPrint('Updating existing balance');
            newBalance = (currentResponse['balancing'] ?? 0.0) + baseReward;
            dynamic historyData = currentResponse['transaction_history'];
            if (historyData is List) {
              history = historyData;
            } else if (historyData is String) {
              history = jsonDecode(historyData);
            }
            history.add(newHistoryEntry);
            await Supabase.instance.client
                .from('profiles')
                .update({
                  'balancing': newBalance,
                  'transaction_history': jsonEncode(history),
                })
                .eq('id', userId);
          }
          debugPrint('Balance updated');

          Provider.of<AppState>(
            context,
            listen: false,
          ).updateBalance(newBalance);

          await _loadAdsWatched();
          setState(() {
            _isOnCooldown = true;
            _remainingCooldown = const Duration(
              seconds: 30,
            ); // Set to 30 seconds
            _lastReward = baseReward;
          });
          _startCooldownTimer();
          _showRewardModal();
        } catch (e) {
          debugPrint('Error updating balance: $e');
          if (mounted) {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(content: Text('Failed to update balance: $e')),
            );
          }
        }
      },
    );
    _rewardedAd = null;
    _loadAd();
  }

  void _startCooldownTimer() {
    _cooldownTimer?.cancel(); // Cancel any existing timer
    _cooldownTimer = Timer.periodic(const Duration(seconds: 1), (timer) {
      if (_remainingCooldown.inSeconds <= 0) {
        timer.cancel();
        setState(() {
          _isOnCooldown = false;
          _remainingCooldown = Duration.zero;
        });
      } else {
        setState(() {
          _remainingCooldown = _remainingCooldown - const Duration(seconds: 1);
        });
      }
    });
  }

  String _formatCooldown() {
    final minutes = _remainingCooldown.inMinutes;
    final seconds = _remainingCooldown.inSeconds % 60;
    return '$minutes:${seconds.toString().padLeft(2, '0')}';
  }

  String formatNumber(double num) {
    String strNum = num.toString();
    int dotIdx = strNum.indexOf('.');
    if (dotIdx == -1) {
      return '$strNum.0000';
    }
    int endIdx = dotIdx + 5;
    String truncated = endIdx > strNum.length
        ? strNum
        : strNum.substring(0, endIdx);
    List<String> parts = truncated.split('.');
    String integer = parts[0];
    String decimal = parts.length > 1 ? parts[1] : '';
    decimal = decimal.padRight(4, '0');
    return '$integer.$decimal';
  }

  void _showRewardModal() {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: const Color(0xFF1A1A1A),
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(12),
          side: BorderSide(color: const Color(0xFFFFD700).withOpacity(0.2)),
        ),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Container(
              width: 64,
              height: 64,
              decoration: const BoxDecoration(
                color: Color(0xFFFFD700),
                shape: BoxShape.circle,
              ),
              child: const Icon(
                Icons.card_giftcard,
                size: 32,
                color: Colors.black,
              ),
            ),
            const SizedBox(height: 16),
            const Text(
              'Reward Earned!',
              style: TextStyle(
                color: Colors.white,
                fontSize: 20,
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: 8),
            Text(
              '+${_lastReward.toStringAsFixed(4)} REGT',
              style: const TextStyle(
                color: Color(0xFFFFD700),
                fontSize: 24,
                fontWeight: FontWeight.bold,
              ),
            ),
          ],
        ),
        actions: [
          ElevatedButton(
            onPressed: () => Navigator.pop(context),
            style: ElevatedButton.styleFrom(
              backgroundColor: const Color(0xFFFFD700),
              foregroundColor: Colors.black,
            ),
            child: const Text('Awesome!'),
          ),
        ],
      ),
    );
  }

  @override
  void dispose() {
    _cooldownTimer?.cancel();
    _rewardedAd?.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final appState = Provider.of<AppState>(context);
    final balance = appState.balance;
    final usdRate = 0.1; // Assuming same as home
    final adsLeft = 16 - _adsWatched;

    return Column(
      children: [
        // Header
          Padding(
            padding: const EdgeInsets.symmetric(
              horizontal: 16.0,
              vertical: 8.0,
            ),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Row(
                  children: [
                    CircleAvatar(
                      radius: 32,
                      backgroundImage: AssetImage(
                        'assets/images/regt_logo.png',
                      ),
                    ),
                    const SizedBox(width: 8),
                    const Text(
                      ' REGT',
                      style: TextStyle(
                        color: Color(0xFFFFD700),
                        fontSize: 24,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ],
                ),
                Row(
                  children: [
                    Text(
                      '${formatNumber(balance)}  REGT',
                      style: const TextStyle(
                        color: Colors.white,
                        fontSize: 14,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    const SizedBox(width: 4),
                    // Text(
                    //   '\$${formatNumber(_balance * usdRate)}',
                    //   style: const TextStyle(color: Colors.grey),
                    // ),
                  ],
                ),
              ],
            ),
          ),






        
        // Balance Card
        
        
        
        Padding(
          padding: const EdgeInsets.all(16.0),
          child: Container(
            decoration: BoxDecoration(
              gradient: const LinearGradient(
                colors: [Color(0xFF1A1A1A), Color(0xFF2A2A2A)],
                begin: Alignment.centerLeft,
                end: Alignment.centerRight,
              ),
              borderRadius: BorderRadius.circular(12),
              border: Border.all(
                color: const Color(0xFFFFD700).withOpacity(0.2),
              ),
            ),
            child: Padding(
              padding: const EdgeInsets.all(16.0),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          const Text(
                            'Total Balance',
                            style: TextStyle(color: Colors.grey, fontSize: 16),
                          ),
                          Text(
                            '${formatNumber(balance)} REGT',
                            style: const TextStyle(
                              color: Colors.white,
                              fontSize: 32,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                          Text(
                            ' \$${formatNumber(balance * usdRate)} USD',
                            style: const TextStyle(
                              color: Colors.grey,
                              fontSize: 14,
                            ),
                          ),
                        ],
                      ),
                      // IconButton(
                      //   onPressed: _isRefreshing ? null : _loadData,
                      //   icon: _isRefreshing
                      //       ? const SizedBox(
                      //           width: 20,
                      //           height: 20,
                      //           child: CircularProgressIndicator(
                      //             strokeWidth: 2,
                      //             color: Color(0xFFFFD700),
                      //           ),
                      //         )
                      //       : const Icon(
                      //           Icons.refresh,
                      //           color: Color(0xFFFFD700),
                      //         ),
                      // ),
                    ],
                  ),
                  const SizedBox(height: 16),

                  // Row(
                  //   mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                  //   children: [
                  //     SizedBox(
                  //       width:
                  //           120, // Adjust this value to change the button size (e.g., 120 for smaller, 200 for larger)
                  //       height: 120,
                  //       child: ElevatedButton(
                  //         onPressed: () => setState(() => _currentIndex = 1),
                  //         style: ElevatedButton.styleFrom(
                  //           backgroundColor: Colors.blue.withOpacity(0.2),
                  //           side: BorderSide(
                  //             color: Colors.blue.withOpacity(0.3),
                  //           ),
                  //           foregroundColor: Colors.blue[300],
                  //           shape: const CircleBorder(),
                  //         ),
                  //         child: const Column(
                  //           mainAxisAlignment: MainAxisAlignment.center,
                  //           children: [
                  //             Icon(Icons.play_arrow, size: 42),
                  //             SizedBox(height: 4),
                  //             Text('Watch Ads'),
                  //           ],
                  //         ),
                  //       ),
                  //     ),
                  //     SizedBox(
                  //       width:
                  //           120, // Adjust this value to change the button size (e.g., 120 for smaller, 200 for larger)
                  //       height: 120,
                  //       child: ElevatedButton(
                  //         onPressed: () => setState(() => _currentIndex = 2),
                  //         style: ElevatedButton.styleFrom(
                  //           backgroundColor: Colors.green.withOpacity(0.2),
                  //           side: BorderSide(
                  //             color: Colors.green.withOpacity(0.3),
                  //           ),
                  //           foregroundColor: Colors.green[300],
                  //           shape: const CircleBorder(),
                  //         ),
                  //         child: const Column(
                  //           mainAxisAlignment: MainAxisAlignment.center,
                  //           children: [
                  //             Icon(Icons.description, size: 32),
                  //             SizedBox(height: 4),
                  //             Text('Surveys'),
                  //           ],
                  //         ),
                  //       ),
                  //     ),
                  //   ],
                  // ),
                ],
              ),
            ),
          ),
        ),







        // Ads Progress
        Padding(
          padding: const EdgeInsets.all(16.0),
          child: Container(
            decoration: BoxDecoration(
              color: const Color(0xFF1A1A1A),
              borderRadius: BorderRadius.circular(8),
            ),
            padding: const EdgeInsets.all(16.0),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    const Text(
                      'Watch Ads',
                      style: TextStyle(color: Colors.white, fontSize: 16),
                    ),
                    Text(
                      '$adsLeft/16 Left',
                      style: const TextStyle(color: Colors.grey),
                    ),
                  ],
                ),
                const SizedBox(height: 8),
                LinearProgressIndicator(
                  value: _adsWatched / 16,
                  backgroundColor: Colors.grey[800],
                  color: const Color(0xFFFFD700),
                  minHeight: 6,
                ),
              ],
            ),
          ),
        ),
        // Main Content
        Expanded(
          child: Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Text(
                  'Ads Watched: $_adsWatched / 16',
                  style: const TextStyle(color: Colors.white, fontSize: 18),
                ),
                const SizedBox(height: 16),
                Text(
                  _isOnCooldown
                      ? 'Cooldown: ${_formatCooldown()}'
                      : 'Ready to watch ad!',
                  style: const TextStyle(color: Colors.white, fontSize: 16),
                ),
                const SizedBox(height: 16),
                ElevatedButton(
                  onPressed: _isAdReady && !_isOnCooldown && adsLeft > 0
                      ? _showAd
                      : null,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: _isOnCooldown || adsLeft <= 0
                        ? Colors.grey
                        : const Color(0xFFFFD700),
                    foregroundColor: Colors.black,
                    minimumSize: const Size(200, 50),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(8),
                    ),
                  ),
                  child: Text(
                    _isOnCooldown
                        ? 'Wait: ${_formatCooldown()}'
                        : (adsLeft <= 0 ? 'No Ads Left' : 'Watch Ad'),
                  ),
                ),
              ],
            ),
          ),
        ),
        // Bonus Info
        Container(
          color: Colors.transparent,
          padding: const EdgeInsets.all(16.0),
          child: Container(
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [
                  const Color(0xFFFFD700).withOpacity(0.1),
                  const Color(0xFFFFA500).withOpacity(0.1),
                ],
              ),
              border: Border.all(
                color: const Color(0xFFFFD700).withOpacity(0.2),
              ),
              borderRadius: BorderRadius.circular(8),
            ),
            padding: const EdgeInsets.all(16.0),
            child: Row(
              children: [
                const Icon(Icons.star, color: Color(0xFFFFD700)),
                const SizedBox(width: 8),
                const Text(
                  'Bonus Rewards',
                  style: TextStyle(
                    color: Color(0xFFFFD700),
                    fontWeight: FontWeight.w100,
                  ),
                ),
                const SizedBox(width: 8),
                Expanded(
                  child: Text(
                    'Watch 10 ads to earn a bonus +1 REGT! (${_adsWatched % 10}/10)',
                    style: const TextStyle(color: Colors.grey),
                  ),
                ),
              ],
            ),
          ),
        ),
      ],
    );
  }
}


// File: c:\Users\Youssef\Documents\flutter_apps\regt_app\lib\screens\home_screen.dart
// import 'dart:async';
// import 'dart:convert';

// import 'package:flutter/material.dart';
// import 'package:provider/provider.dart';
// import 'package:supabase_flutter/supabase_flutter.dart';
// import 'package:regt_app/providers/app_state.dart';
// import 'ads_screen.dart'; // Assuming this file exists
// // import 'surveys_screen.dart'; // Assuming this file exists
// import 'referrals_screen.dart'; // From previous context
// import 'profile_screen.dart'; // Assuming this file exists
// import 'package:flutter/services.dart';
// import 'package:url_launcher/url_launcher.dart';

// class ReferralStats {
//   int totalReferrals;
//   int activeReferrals;
//   double totalCommissions;
//   double thisMonthCommissions;

//   ReferralStats({
//     required this.totalReferrals,
//     required this.activeReferrals,
//     required this.totalCommissions,
//     required this.thisMonthCommissions,
//   });
// }

// class HomeScreen extends StatefulWidget {
//   const HomeScreen({super.key});

//   @override
//   State<HomeScreen> createState() => _HomeScreenState();
// }

// class _HomeScreenState extends State<HomeScreen> {
//   late SupabaseClient supabase;
//   double _balance = 0.0;
//   List<Map<String, dynamic>> _history = [];
//   Timer? _refreshTimer;
//   bool _isRefreshing = false;
//   int _currentIndex = 0;
//   int _displayedHistoryCount = 10; // Pagination: initial count
//   String _referralLink = '';
//   ReferralStats _stats = ReferralStats(
//     totalReferrals: 0,
//     activeReferrals: 0,
//     totalCommissions: 0,
//     thisMonthCommissions: 0,
//   );

//   @override
//   void initState() {
//     super.initState();
//     supabase = Supabase.instance.client;
//     _generateReferralLink();
//     _loadData();
//     _refreshTimer = Timer.periodic(
//       const Duration(seconds: 10),
//       (timer) => _loadData(),
//     );
//   }

//   void _generateReferralLink() {
//     final userId = supabase.auth.currentUser?.id ?? '';
//     final referralCode = 'REGT${userId.toUpperCase()}';
//     _referralLink = 'https://regtai.com/join?ref=$referralCode';
//   }

//   Future<void> _loadData() async {
//     setState(() {
//       _isRefreshing = true;
//     });

//     final userId = supabase.auth.currentUser?.id;
//     if (userId == null) {
//       setState(() {
//         _isRefreshing = false;
//       });
//       return;
//     }

//     // Print JWT metadata for debug
//     final session = supabase.auth.currentSession;
//     if (session != null) {
//       debugPrint('JWT User Metadata: ${session.user.userMetadata}');
//     }

//     try {
//       final data = await supabase
//           .from('profiles')
//           .select()
//           .eq('id', userId)
//           .maybeSingle();
//       if (data != null) {
//         setState(() {
//           _balance = data['balancing'] ?? 0.0;
//           // Fix: Handle transaction_history as List directly (from JSONB)
//           final historyData = data['transaction_history'];
//           if (historyData is List) {
//             _history = historyData.cast<Map<String, dynamic>>();
//           } else if (historyData is String) {
//             _history = (jsonDecode(historyData) as List)
//                 .cast<Map<String, dynamic>>();
//           } else {
//             _history = [];
//           }
//           // Sort history by date descending (newest first)
//           _history.sort(
//             (a, b) =>
//                 DateTime.parse(
//                   b['date'] ?? DateTime.now().toIso8601String(),
//                 ).compareTo(
//                   DateTime.parse(a['date'] ?? DateTime.now().toIso8601String()),
//                 ),
//           );
//         });
//         Provider.of<AppState>(context, listen: false).updateBalance(_balance);
//       } else {
//         setState(() {
//           _balance = 0.0;
//           _history = [];
//         });
//       }

//       final referralData = await supabase
//           .from('referrals')
//           .select()
//           .eq('referrer_id', userId);
//       double totalComm = 0.0;
//       double monthComm = 0.0;
//       int active = 0;
//       DateTime now = DateTime.now();
//       for (var m in referralData) {
//         bool isActive = m['active_status'] as bool? ?? false;
//         if (isActive) active++;
//         double comm = (m['commission'] as num? ?? 0).toDouble();
//         totalComm += comm;
//         if (m['created_at'] != null) {
//           DateTime join = DateTime.parse(m['created_at']);
//           if (join.month == now.month && join.year == now.year) {
//             monthComm += comm;
//           }
//         }
//       }
//       setState(() {
//         _stats = ReferralStats(
//           totalReferrals: referralData.length,
//           activeReferrals: active,
//           totalCommissions: totalComm,
//           thisMonthCommissions: monthComm,
//         );
//       });
//     } catch (e) {
//       debugPrint('Error loading balance: $e');
//     } finally {
//       setState(() {
//         _isRefreshing = false;
//       });
//     }
//   }

//   void _loadMoreHistory() {
//     setState(() {
//       _displayedHistoryCount += 10;
//     });
//   }

//   @override
//   void dispose() {
//     _refreshTimer?.cancel();
//     super.dispose();
//   }

//   String formatNumber(double num) {
//     String strNum = num.toString();
//     int dotIdx = strNum.indexOf('.');
//     if (dotIdx == -1) {
//       return '$strNum.0000';
//     }
//     int endIdx = dotIdx + 5;
//     String truncated = endIdx > strNum.length
//         ? strNum
//         : strNum.substring(0, endIdx);
//     List<String> parts = truncated.split('.');
//     String integer = parts[0];
//     String decimal = parts.length > 1 ? parts[1] : '';
//     decimal = decimal.padRight(4, '0');
//     return '$integer.$decimal';
//   }

//   String _formatTimeAgo(DateTime date) {
//     final now = DateTime.now();
//     final diff = now.difference(date);
//     if (diff.inMinutes < 60) {
//       return '${diff.inMinutes}m ago';
//     } else if (diff.inHours < 24) {
//       return '${diff.inHours}h ago';
//     } else {
//       return '${diff.inDays}d ago';
//     }
//   }

//   IconData _getTransactionIcon(String type) {
//     final lowerType = type.toLowerCase();
//     if (lowerType.contains('ad')) {
//       return Icons.play_arrow;
//     } else if (lowerType.contains('survey')) {
//       return Icons.description;
//     } else if (lowerType.contains('referral')) {
//       return Icons.trending_up;
//     } else if (lowerType.contains('withdrawal')) {
//       return Icons.trending_down;
//     } else {
//       return Icons.info;
//     }
//   }

//   String _formatDescription(String type) {
//     return type
//         .split('_')
//         .map((word) => word[0].toUpperCase() + word.substring(1))
//         .join(' ');
//   }

//   void _showShareModal() {
//     showDialog(
//       context: context,
//       builder: (BuildContext context) {
//         return AlertDialog(
//           backgroundColor: const Color(0xff1a1a1a),
//           shape: RoundedRectangleBorder(
//             borderRadius: BorderRadius.circular(12),
//           ),
//           title: const Center(
//             child: Text(
//               'Share Your Link',
//               style: TextStyle(
//                 color: Colors.white,
//                 fontSize: 20,
//                 fontWeight: FontWeight.w600,
//               ),
//             ),
//           ),
//           content: Column(
//             mainAxisSize: MainAxisSize.min,
//             children: [
//               ElevatedButton(
//                 onPressed: () {
//                   launchUrl(
//                     Uri.parse(
//                       'https://wa.me/?text=${Uri.encodeComponent('Join REGT Token Earning Platform: $_referralLink')}',
//                     ),
//                   );
//                   Navigator.of(context).pop();
//                 },
//                 style: ElevatedButton.styleFrom(
//                   backgroundColor: Colors.green[600],
//                   minimumSize: const Size(double.infinity, 48),
//                   shape: RoundedRectangleBorder(
//                     borderRadius: BorderRadius.circular(8),
//                   ),
//                 ),
//                 child: const Row(
//                   mainAxisAlignment: MainAxisAlignment.center,
//                   children: [
//                     Icon(Icons.link, color: Colors.white),
//                     SizedBox(width: 8),
//                     Text('WhatsApp', style: TextStyle(color: Colors.white)),
//                   ],
//                 ),
//               ),
//               const SizedBox(height: 8),
//               ElevatedButton(
//                 onPressed: () {
//                   launchUrl(
//                     Uri.parse(
//                       'https://t.me/share/url?url=${Uri.encodeComponent(_referralLink)}&text=${Uri.encodeComponent('Join REGT Token Earning Platform')}',
//                     ),
//                   );
//                   Navigator.of(context).pop();
//                 },
//                 style: ElevatedButton.styleFrom(
//                   backgroundColor: Colors.blue[600],
//                   minimumSize: const Size(double.infinity, 48),
//                   shape: RoundedRectangleBorder(
//                     borderRadius: BorderRadius.circular(8),
//                   ),
//                 ),
//                 child: const Row(
//                   mainAxisAlignment: MainAxisAlignment.center,
//                   children: [
//                     Icon(Icons.link, color: Colors.white),
//                     SizedBox(width: 8),
//                     Text('Telegram', style: TextStyle(color: Colors.white)),
//                   ],
//                 ),
//               ),
//               const SizedBox(height: 8),
//               ElevatedButton(
//                 onPressed: () {
//                   launchUrl(
//                     Uri.parse(
//                       'mailto:?subject=Join REGT Token Earning Platform&body=${Uri.encodeComponent(_referralLink)}',
//                     ),
//                   );
//                   Navigator.of(context).pop();
//                 },
//                 style: ElevatedButton.styleFrom(
//                   backgroundColor: Colors.grey[600],
//                   minimumSize: const Size(double.infinity, 48),
//                   shape: RoundedRectangleBorder(
//                     borderRadius: BorderRadius.circular(8),
//                   ),
//                 ),
//                 child: const Row(
//                   mainAxisAlignment: MainAxisAlignment.center,
//                   children: [
//                     Icon(Icons.link, color: Colors.white),
//                     SizedBox(width: 8),
//                     Text('Email', style: TextStyle(color: Colors.white)),
//                   ],
//                 ),
//               ),
//             ],
//           ),
//           actions: [
//             TextButton(
//               onPressed: () => Navigator.of(context).pop(),
//               child: const Text('Close', style: TextStyle(color: Colors.grey)),
//             ),
//           ],
//         );
//       },
//     );
//   }

//   Widget _buildHomeContent() {
//     final usdRate = 0.1;
//     return RefreshIndicator(
//       onRefresh: _loadData,
//       child: ListView(
//         children: [
//           // Header
//           Padding(
//             padding: const EdgeInsets.symmetric(
//               horizontal: 16.0,
//               vertical: 8.0,
//             ),
//             child: Row(
//               mainAxisAlignment: MainAxisAlignment.spaceBetween,
//               children: [

//                 Row(
//                   children: [
//                     CircleAvatar(
//                       radius: 32,
//                       backgroundImage: AssetImage(
//                         'assets/images/regt_logo.png',
//                       ),
//                     ),
//                     const SizedBox(width: 8),
//                     const Text(
//                       ' REGT',
//                       style: TextStyle(
//                         color: Color(0xFFFFD700),
//                         fontSize: 24,
//                         fontWeight: FontWeight.bold,
//                       ),
//                     ),
//                   ],
//                 ),
//                 Row(
//                   children: [
//                     Text(
//                       '${formatNumber(_balance)}  REGT',
//                       style: const TextStyle(
//                         color: Colors.white,
//                         fontSize: 14,
//                         fontWeight: FontWeight.bold,
//                       ),
//                     ),
//                     const SizedBox(width: 4),
//                     // Text(
//                     //   '\$${formatNumber(_balance * usdRate)}',
//                     //   style: const TextStyle(color: Colors.grey),
//                     // ),
//                   ],
//                 ),
//               ],
//             ),
//           ),
//           // Balance Card
//           Padding(
//             padding: const EdgeInsets.all(16.0),
//             child: Container(
//               decoration: BoxDecoration(
//                 gradient: const LinearGradient(
//                   colors: [Color(0xFF1A1A1A), Color(0xFF2A2A2A)],
//                   begin: Alignment.centerLeft,
//                   end: Alignment.centerRight,
//                 ),
//                 borderRadius: BorderRadius.circular(12),
//                 border: Border.all(
//                   color: const Color(0xFFFFD700).withOpacity(0.2),
//                 ),
//               ),
//               child: Padding(
//                 padding: const EdgeInsets.all(16.0),
//                 child: Column(
//                   crossAxisAlignment: CrossAxisAlignment.start,
//                   children: [
//                     Row(
//                       mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                       children: [
//                         Column(
//                           crossAxisAlignment: CrossAxisAlignment.start,
//                           children: [
//                             const Text(
//                               'Total Balance',
//                               style: TextStyle(
//                                 color: Colors.grey,
//                                 fontSize: 16,
//                               ),
//                             ),
//                             Text(
//                               '${formatNumber(_balance)} REGT',
//                               style: const TextStyle(
//                                 color: Colors.white,
//                                 fontSize: 32,
//                                 fontWeight: FontWeight.bold,
//                               ),
//                             ),
//                             Text(
//                               ' \$${formatNumber(_balance * usdRate)} USD',
//                               style: const TextStyle(
//                                 color: Colors.grey,
//                                 fontSize: 14,
//                               ),
//                             ),
//                           ],
//                         ),
//                         IconButton(
//                           onPressed: _isRefreshing ? null : _loadData,
//                           icon: _isRefreshing
//                               ? const SizedBox(
//                                   width: 20,
//                                   height: 20,
//                                   child: CircularProgressIndicator(
//                                     strokeWidth: 2,
//                                     color: Color(0xFFFFD700),
//                                   ),
//                                 )
//                               : const Icon(
//                                   Icons.refresh,
//                                   color: Color(0xFFFFD700),
//                                 ),
//                         ),
//                       ],
//                     ),
//                     const SizedBox(height: 16),

//                     Row(
//                       mainAxisAlignment: MainAxisAlignment.spaceEvenly,
//                       children: [
//                         SizedBox(
//                           width:
//                               120, // Adjust this value to change the button size (e.g., 120 for smaller, 200 for larger)
//                           height: 120,
//                           child: ElevatedButton(
//                             onPressed: () => setState(() => _currentIndex = 1),
//                             style: ElevatedButton.styleFrom(
//                               backgroundColor: Colors.blue.withOpacity(0.2),
//                               side: BorderSide(
//                                 color: Colors.blue.withOpacity(0.3),
//                               ),
//                               foregroundColor: Colors.blue[300],
//                               shape: const CircleBorder(),
//                             ),
//                             child: const Column(
//                               mainAxisAlignment: MainAxisAlignment.center,
//                               children: [
//                                 Icon(Icons.play_arrow, size: 42),
//                                 SizedBox(height: 4),
//                                 Text('Watch Ads'),
//                               ],
//                             ),
//                           ),
//                         ),
//                         SizedBox(
//                           width:
//                               120, // Adjust this value to change the button size (e.g., 120 for smaller, 200 for larger)
//                           height: 120,
//                           child: ElevatedButton(
//                             onPressed: () => setState(() => _currentIndex = 2),
//                             style: ElevatedButton.styleFrom(
//                               backgroundColor: Colors.green.withOpacity(0.2),
//                               side: BorderSide(
//                                 color: Colors.green.withOpacity(0.3),
//                               ),
//                               foregroundColor: Colors.green[300],
//                               shape: const CircleBorder(),
//                             ),
//                             child: const Column(
//                               mainAxisAlignment: MainAxisAlignment.center,
//                               children: [
//                                 Icon(Icons.description, size: 32),
//                                 SizedBox(height: 4),
//                                 Text('Surveys'),
//                               ],
//                             ),
//                           ),
//                         ),
//                       ],
//                     ),
//                   ],
//                 ),
//               ),
//             ),
//           ),
//           // Quick Stats
//           Padding(
//             padding: const EdgeInsets.symmetric(horizontal: 16.0),
//             child: Row(
//               mainAxisAlignment: MainAxisAlignment.spaceAround,
//               children: [
//                 _buildStatCard('12', 'Ads Today'),
//                 _buildStatCard('2', 'Surveys'),
//                 _buildStatCard(_stats.totalReferrals.toString(), 'Referrals'),
//               ],
//             ),
//           ),
//           // Referral Link Card
//           Padding(
//             padding: const EdgeInsets.all(16),
//             child: Container(
//               padding: const EdgeInsets.all(16),
//               decoration: BoxDecoration(
//                 gradient: const LinearGradient(
//                   begin: Alignment.centerLeft,
//                   end: Alignment.centerRight,
//                   colors: [Color(0xff1a1a1a), Color(0xff2a2a2a)],
//                 ),
//                 borderRadius: BorderRadius.circular(12),
//                 border: Border.all(
//                   color: const Color(0xffFFD700).withOpacity(0.2),
//                 ),
//               ),
//               child: Column(
//                 crossAxisAlignment: CrossAxisAlignment.start,
//                 children: [
//                   const Row(
//                     children: [
//                       Icon(Icons.share, color: Color(0xffFFD700), size: 20),
//                       SizedBox(width: 8),
//                       Text(
//                         'Referral Link',
//                         style: TextStyle(
//                           color: Colors.white,
//                           fontSize: 16,
//                           fontWeight: FontWeight.w600,
//                         ),
//                       ),
//                     ],
//                   ),
//                   const SizedBox(height: 12),
//                   // Container(
//                   //   width: double.infinity,
//                   //   padding: const EdgeInsets.all(12),
//                   //   decoration: BoxDecoration(color: const Color(0xff0a0a0a), borderRadius: BorderRadius.circular(8)),
//                   //   child: Text(_referralLink, style: const TextStyle(color: Color(0xffFFD700), fontFamily: 'Courier', fontSize: 12), softWrap: true),
//                   // ),
//                   const SizedBox(height: 16),
//                   Row(
//                     children: [
//                       Expanded(
//                         child: ElevatedButton(
//                           onPressed: () async {
//                             await Clipboard.setData(
//                               ClipboardData(text: _referralLink),
//                             );
//                             if (context.mounted) {
//                               ScaffoldMessenger.of(context).showSnackBar(
//                                 const SnackBar(
//                                   content: Text(
//                                     'Referral link copied to clipboard!',
//                                   ),
//                                 ),
//                               );
//                             }
//                           },
//                           style: ElevatedButton.styleFrom(
//                             backgroundColor: const Color(0xff2a2a2a),
//                             side: const BorderSide(color: Color(0xff808080)),
//                             shape: RoundedRectangleBorder(
//                               borderRadius: BorderRadius.circular(8),
//                             ),
//                           ),
//                           child: const Row(
//                             mainAxisAlignment: MainAxisAlignment.center,
//                             children: [
//                               Icon(Icons.copy, color: Colors.white, size: 16),
//                               SizedBox(width: 8),
//                               Text(
//                                 'Copy Link',
//                                 style: TextStyle(color: Colors.white),
//                               ),
//                             ],
//                           ),
//                         ),
//                       ),
//                       const SizedBox(width: 8),
//                       Expanded(
//                         child: ElevatedButton(
//                           onPressed: _showShareModal,
//                           style: ElevatedButton.styleFrom(
//                             backgroundColor: const Color(0xffFFD700),
//                             shape: RoundedRectangleBorder(
//                               borderRadius: BorderRadius.circular(8),
//                             ),
//                           ),
//                           child: const Row(
//                             mainAxisAlignment: MainAxisAlignment.center,
//                             children: [
//                               Icon(Icons.share, color: Colors.black, size: 16),
//                               SizedBox(width: 8),
//                               Text(
//                                 'Share',
//                                 style: TextStyle(color: Colors.black),
//                               ),
//                             ],
//                           ),
//                         ),
//                       ),
//                     ],
//                   ),
//                 ],
//               ),
//             ),
//           ),
//           // Commission Earnings Card
//           Padding(
//             padding: const EdgeInsets.symmetric(horizontal: 16),
//             child: Container(
//               padding: const EdgeInsets.all(16),
//               decoration: BoxDecoration(
//                 color: const Color(0xff1a1a1a),
//                 borderRadius: BorderRadius.circular(12),
//                 border: Border.all(color: const Color(0xff808080)),
//               ),
//               child: Column(
//                 crossAxisAlignment: CrossAxisAlignment.start,
//                 children: [
//                   Row(
//                     mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                     children: [
//                       const Row(
//                         children: [
//                           Icon(
//                             Icons.card_giftcard,
//                             color: Color(0xffFFD700),
//                             size: 20,
//                           ),
//                           SizedBox(width: 8),
//                           Text(
//                             'Commission Earnings',
//                             style: TextStyle(
//                               color: Colors.white,
//                               fontSize: 16,
//                               fontWeight: FontWeight.w600,
//                             ),
//                           ),
//                         ],
//                       ),
//                       Icon(
//                         Icons.trending_up,
//                         color: Colors.green[400],
//                         size: 20,
//                       ),
//                     ],
//                   ),
//                   const SizedBox(height: 12),
//                   Row(
//                     children: [
//                       Expanded(
//                         child: Column(
//                           crossAxisAlignment: CrossAxisAlignment.start,
//                           children: [
//                             Text(
//                               '${_stats.totalCommissions.toStringAsFixed(2)} REGT',
//                               style: const TextStyle(
//                                 color: Color(0xffFFD700),
//                                 fontSize: 24,
//                                 fontWeight: FontWeight.bold,
//                               ),
//                             ),
//                             const Text(
//                               'Total Earned',
//                               style: TextStyle(
//                                 color: Color(0xff808080),
//                                 fontSize: 12,
//                               ),
//                             ),
//                           ],
//                         ),
//                       ),
//                       Expanded(
//                         child: Column(
//                           crossAxisAlignment: CrossAxisAlignment.start,
//                           children: [
//                             Text(
//                               '${_stats.thisMonthCommissions.toStringAsFixed(2)} REGT',
//                               style: TextStyle(
//                                 color: Colors.green[400],
//                                 fontSize: 20,
//                                 fontWeight: FontWeight.bold,
//                               ),
//                             ),
//                             const Text(
//                               'This Month',
//                               style: TextStyle(
//                                 color: Color(0xff808080),
//                                 fontSize: 12,
//                               ),
//                             ),
//                           ],
//                         ),
//                       ),
//                     ],
//                   ),
//                 ],
//               ),
//             ),
//           ),

//           // Recent Activity Header
//           Padding(
//             padding: const EdgeInsets.fromLTRB(16.0, 16.0, 16.0, 8.0),
//             child: Row(
//               mainAxisAlignment: MainAxisAlignment.spaceBetween,
//               children: [
//                 const Text(
//                   'Recent Activity',
//                   style: TextStyle(
//                     color: Colors.white,
//                     fontSize: 18,
//                     fontWeight: FontWeight.w100,
//                   ),
//                 ),
//                 ElevatedButton(
//                   onPressed: () => Navigator.pushNamed(context, '/withdrawal'),
//                   style: ElevatedButton.styleFrom(
//                     backgroundColor: const Color(0xFFFFD700),
//                     foregroundColor: Colors.black,
//                     shape: RoundedRectangleBorder(
//                       borderRadius: BorderRadius.circular(8),
//                     ),
//                   ),
//                   child: const Row(
//                     children: [
//                       Icon(Icons.arrow_forward, size: 16),
//                       SizedBox(width: 4),
//                       Text('Withdraw'),
//                     ],
//                   ),
//                 ),
//               ],
//             ),
//           ),
//           // Transaction List
//           ListView.builder(
//             shrinkWrap: true,
//             physics: const NeverScrollableScrollPhysics(),
//             itemCount: _history.length > _displayedHistoryCount
//                 ? _displayedHistoryCount
//                 : _history.length,
//             itemBuilder: (context, index) {
//               final item = _history[index];
//               final type = item['type'] as String? ?? 'unknown';
//               final amount = (item['amount'] as num?)?.toDouble() ?? 0.0;
//               final dateStr =
//                   item['date'] as String? ?? DateTime.now().toIso8601String();
//               final date = DateTime.parse(dateStr);
//               final timeAgo = _formatTimeAgo(date);
//               final description = _formatDescription(type);
//               final icon = _getTransactionIcon(type);
//               final amountColor = amount >= 0
//                   ? Colors.green[400]
//                   : Colors.red[400];
//               final sign = amount > 0 ? '+' : (amount < 0 ? '-' : '');

//               return Padding(
//                 padding: const EdgeInsets.only(
//                   bottom: 8.0,
//                   left: 16.0,
//                   right: 16.0,
//                 ),
//                 child: Container(
//                   decoration: BoxDecoration(
//                     color: const Color(0xFF1A1A1A),
//                     borderRadius: BorderRadius.circular(8),
//                   ),
//                   child: ListTile(
//                     leading: CircleAvatar(
//                       backgroundColor: Colors.grey[800],
//                       child: Icon(icon, color: amountColor, size: 16),
//                     ),
//                     title: Text(
//                       description,
//                       style: const TextStyle(color: Colors.white, fontSize: 14),
//                     ),
//                     subtitle: Text(
//                       timeAgo,
//                       style: const TextStyle(color: Colors.grey, fontSize: 12),
//                     ),
//                     trailing: Text(
//                       '$sign${formatNumber(amount.abs())} REGT',
//                       style: TextStyle(
//                         color: amountColor,
//                         fontWeight: FontWeight.bold,
//                         fontSize: 14,
//                       ),
//                     ),
//                   ),
//                 ),
//               );
//             },
//           ),
//           if (_displayedHistoryCount < _history.length)
//             Padding(
//               padding: const EdgeInsets.all(16.0),
//               child: ElevatedButton(
//                 onPressed: _loadMoreHistory,
//                 style: ElevatedButton.styleFrom(
//                   backgroundColor: const Color(0xFFFFD700),
//                   foregroundColor: Colors.black,
//                 ),
//                 child: const Text('Load More'),
//               ),
//             ),
//           const SizedBox(height: 80), // Padding for bottom nav
//         ],
//       ),
//     );
//   }

//   @override
//   Widget build(BuildContext context) {
//     return Scaffold(
//       backgroundColor: Colors.black,
//       body: IndexedStack(
//         index: _currentIndex,
//         children: [
//           _buildHomeContent(),
//           const AdsScreen(),
//           // const SurveysScreen(),
//           const ReferralsScreen(),
//           const ProfileScreen(),
//         ],
//       ),
//       bottomNavigationBar: BottomNavigationBar(
//         backgroundColor: Colors.black,
//         selectedItemColor: const Color(0xFFFFD700),
//         unselectedItemColor: Colors.white,
//         type: BottomNavigationBarType.fixed,
//         currentIndex: _currentIndex,
//         items: const [
//           BottomNavigationBarItem(icon: Icon(Icons.home), label: 'Home'),
//           BottomNavigationBarItem(icon: Icon(Icons.play_arrow), label: 'Ads'),
//           // BottomNavigationBarItem(icon: Icon(Icons.description), label: 'Surveys'),
//           BottomNavigationBarItem(icon: Icon(Icons.people), label: 'Referrals'),
//           BottomNavigationBarItem(icon: Icon(Icons.person), label: 'Profile'),
//         ],
//         onTap: (index) {
//           setState(() {
//             _currentIndex = index;
//           });
//         },
//       ),
//     );
//   }

//   Widget _buildStatCard(String value, String label) {
//     return Expanded(
//       child: Container(
//         margin: const EdgeInsets.symmetric(horizontal: 4.0),
//         padding: const EdgeInsets.all(12.0),
//         decoration: BoxDecoration(
//           color: const Color(0xFF1A1A1A),
//           borderRadius: BorderRadius.circular(8),
//           border: Border.all(color: Colors.grey[800]!),
//         ),
//         child: Column(
//           children: [
//             Text(
//               value,
//               style: const TextStyle(
//                 color: Color(0xFFFFD700),
//                 fontWeight: FontWeight.bold,
//                 fontSize: 16,
//               ),
//             ),
//             Text(
//               label,
//               style: const TextStyle(color: Colors.grey, fontSize: 12),
//             ),
//           ],
//         ),
//       ),
//     );
//   }
// }

import 'dart:async';
import 'dart:convert';

import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:regt_app/providers/app_state.dart';
import 'ads_screen.dart'; // Assuming this file exists
// import 'surveys_screen.dart'; // Assuming this file exists
import 'referrals_screen.dart'; // From previous context
import 'profile_screen.dart'; // Assuming this file exists
import 'package:flutter/services.dart';
import 'package:url_launcher/url_launcher.dart';

class ReferralStats {
  int totalReferrals;
  int activeReferrals;
  double totalCommissions;
  double thisMonthCommissions;

  ReferralStats({
    required this.totalReferrals,
    required this.activeReferrals,
    required this.totalCommissions,
    required this.thisMonthCommissions,
  });
}

class HomeScreen extends StatefulWidget {
  const HomeScreen({super.key});

  @override
  State<HomeScreen> createState() => _HomeScreenState();
}

class _HomeScreenState extends State<HomeScreen> {
  late SupabaseClient supabase;
  double _balance = 0.0;
  List<Map<String, dynamic>> _history = [];
  List<Map<String, dynamic>> _withdrawals = [];
  Timer? _refreshTimer;
  bool _isRefreshing = false;
  int _currentIndex = 0;
  int _displayedHistoryCount = 10; // Pagination: initial count
  String _referralLink = '';
  ReferralStats _stats = ReferralStats(
    totalReferrals: 0,
    activeReferrals: 0,
    totalCommissions: 0,
    thisMonthCommissions: 0,
  );

  @override
  void initState() {
    super.initState();
    supabase = Supabase.instance.client;
    _generateReferralLink();
    _loadData();
    _refreshTimer = Timer.periodic(
      const Duration(seconds: 10),
      (timer) => _loadData(),
    );
    supabase.auth.onAuthStateChange.listen((data) {
      if (data.event == AuthChangeEvent.signedIn) {
        _loadData(); // Refresh balance after confirmation
      }
    });
  }

  void _generateReferralLink() {
    final userId = supabase.auth.currentUser?.id ?? '';
    final referralCode = 'REGT${userId.toUpperCase()}';
    _referralLink = 'https://regtai.com/join?ref=$referralCode';
  }

  Future<void> _loadData() async {
    setState(() {
      _isRefreshing = true;
    });

    final userId = supabase.auth.currentUser?.id;
    if (userId == null) {
      setState(() {
        _isRefreshing = false;
      });
      return;
    }

    // Print JWT metadata for debug
    final session = supabase.auth.currentSession;
    if (session != null) {
      debugPrint('JWT User Metadata: ${session.user.userMetadata}');
    }

    try {
      final data = await supabase
          .from('profiles')
          .select()
          .eq('id', userId)
          .maybeSingle();
      if (data != null) {
        setState(() {
          _balance = data['balancing'] ?? 0.0;
          // Fix: Handle transaction_history as List directly (from JSONB)
          final historyData = data['transaction_history'];
          if (historyData is List) {
            _history = historyData.cast<Map<String, dynamic>>();
          } else if (historyData is String) {
            _history = (jsonDecode(historyData) as List)
                .cast<Map<String, dynamic>>();
          } else {
            _history = [];
          }
          // Sort history by date descending (newest first)
          _history.sort(
            (a, b) =>
                DateTime.parse(
                  b['date'] ?? DateTime.now().toIso8601String(),
                ).compareTo(
                  DateTime.parse(a['date'] ?? DateTime.now().toIso8601String()),
                ),
          );
        });
        Provider.of<AppState>(context, listen: false).updateBalance(_balance);
      } else {
        setState(() {
          _balance = 0.0;
          _history = [];
        });
      }

      final referralData = await supabase
          .from('referrals')
          .select()
          .eq('referrer_id', userId);
      double totalComm = 0.0;
      double monthComm = 0.0;
      int active = 0;
      DateTime now = DateTime.now();
      for (var m in referralData) {
        bool isActive = m['active_status'] as bool? ?? false;
        if (isActive) active++;
        double comm = (m['commission'] as num? ?? 0).toDouble();
        totalComm += comm;
        if (m['created_at'] != null) {
          DateTime join = DateTime.parse(m['created_at']);
          if (join.month == now.month && join.year == now.year) {
            monthComm += comm;
          }
        }
      }
      setState(() {
        _stats = ReferralStats(
          totalReferrals: referralData.length,
          activeReferrals: active,
          totalCommissions: totalComm,
          thisMonthCommissions: monthComm,
        );
      });

      // Fetch all withdrawals for the user, then filter to pending in code
      final withdrawalsData = await supabase
          .from('withdraw_requests')
          .select()
          .eq('user_id', userId);
      debugPrint('Withdrawals fetched: ${withdrawalsData.length}'); // Debug log
      setState(() {
        _withdrawals = withdrawalsData
            .where(
              (wd) => (wd['status'] as String?)?.toLowerCase() == 'pending',
            )
            .cast<Map<String, dynamic>>()
            .toList();
        // Sort by request_date descending
        _withdrawals.sort((a, b) {
          try {
            return DateTime.parse(
              b['request_date'] ?? DateTime.now().toIso8601String(),
            ).compareTo(
              DateTime.parse(
                a['request_date'] ?? DateTime.now().toIso8601String(),
              ),
            );
          } catch (e) {
            return 0; // Graceful if parse fails
          }
        });
      });
    } catch (e) {
      debugPrint('Error loading data: $e');
    } finally {
      setState(() {
        _isRefreshing = false;
      });
    }
  }

  void _loadMoreHistory() {
    setState(() {
      _displayedHistoryCount += 10;
    });
  }

  @override
  void dispose() {
    _refreshTimer?.cancel();
    super.dispose();
  }

  String formatNumber(double num) {
    String strNum = num.toString();
    int dotIdx = strNum.indexOf('.');
    if (dotIdx == -1) {
      return '$strNum.0000';
    }
    int endIdx = dotIdx + 5;
    String truncated = endIdx > strNum.length
        ? strNum
        : strNum.substring(0, endIdx);
    List<String> parts = truncated.split('.');
    String integer = parts[0];
    String decimal = parts.length > 1 ? parts[1] : '';
    decimal = decimal.padRight(4, '0');
    return '$integer.$decimal';
  }

  String _formatTimeAgo(DateTime date) {
    final now = DateTime.now();
    final diff = now.difference(date);
    if (diff.inMinutes < 60) {
      return '${diff.inMinutes}m ago';
    } else if (diff.inHours < 24) {
      return '${diff.inHours}h ago';
    } else {
      return '${diff.inDays}d ago';
    }
  }

  IconData _getTransactionIcon(String type) {
    final lowerType = type.toLowerCase();
    if (lowerType.contains('ad')) {
      return Icons.play_arrow;
    } else if (lowerType.contains('survey')) {
      return Icons.description;
    } else if (lowerType.contains('referral')) {
      return Icons.trending_up;
    } else if (lowerType.contains('withdrawal')) {
      return Icons.trending_down;
    } else {
      return Icons.info;
    }
  }

  String _formatDescription(String type) {
    return type
        .split('_')
        .map((word) => word[0].toUpperCase() + word.substring(1))
        .join(' ');
  }

  void _showShareModal() {
    showDialog(
      context: context,
      builder: (BuildContext context) {
        return AlertDialog(
          backgroundColor: const Color(0xff1a1a1a),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(12),
          ),
          title: const Center(
            child: Text(
              'Share Your Link',
              style: TextStyle(
                color: Colors.white,
                fontSize: 20,
                fontWeight: FontWeight.w600,
              ),
            ),
          ),
          content: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              ElevatedButton(
                onPressed: () {
                  launchUrl(
                    Uri.parse(
                      'https://wa.me/?text=${Uri.encodeComponent('Join REGT Token Earning Platform: $_referralLink')}',
                    ),
                  );
                  Navigator.of(context).pop();
                },
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.green[600],
                  minimumSize: const Size(double.infinity, 48),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(8),
                  ),
                ),
                child: const Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    Icon(Icons.link, color: Colors.white),
                    SizedBox(width: 8),
                    Text('WhatsApp', style: TextStyle(color: Colors.white)),
                  ],
                ),
              ),
              const SizedBox(height: 8),
              ElevatedButton(
                onPressed: () {
                  launchUrl(
                    Uri.parse(
                      'https://t.me/share/url?url=${Uri.encodeComponent(_referralLink)}&text=${Uri.encodeComponent('Join REGT Token Earning Platform')}',
                    ),
                  );
                  Navigator.of(context).pop();
                },
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.blue[600],
                  minimumSize: const Size(double.infinity, 48),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(8),
                  ),
                ),
                child: const Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    Icon(Icons.link, color: Colors.white),
                    SizedBox(width: 8),
                    Text('Telegram', style: TextStyle(color: Colors.white)),
                  ],
                ),
              ),
              const SizedBox(height: 8),
              ElevatedButton(
                onPressed: () {
                  launchUrl(
                    Uri.parse(
                      'mailto:?subject=Join REGT Token Earning Platform&body=${Uri.encodeComponent(_referralLink)}',
                    ),
                  );
                  Navigator.of(context).pop();
                },
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.grey[600],
                  minimumSize: const Size(double.infinity, 48),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(8),
                  ),
                ),
                child: const Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    Icon(Icons.link, color: Colors.white),
                    SizedBox(width: 8),
                    Text('Email', style: TextStyle(color: Colors.white)),
                  ],
                ),
              ),
            ],
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.of(context).pop(),
              child: const Text('Close', style: TextStyle(color: Colors.grey)),
            ),
          ],
        );
      },
    );
  }

  Widget _buildHomeContent() {
    final usdRate = 0.1;
    return RefreshIndicator(
      onRefresh: _loadData,
      child: ListView(
        children: [
          // Header
          Padding(
            padding: const EdgeInsets.symmetric(
              horizontal: 16.0,
              vertical: 8.0,
            ),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Row(
                  children: [
                    CircleAvatar(
                      radius: 32,
                      backgroundImage: AssetImage(
                        'assets/images/regt_logo.png',
                      ),
                    ),
                    const SizedBox(width: 8),
                    const Text(
                      ' REGT',
                      style: TextStyle(
                        color: Color(0xFFFFD700),
                        fontSize: 24,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ],
                ),
                Row(
                  children: [
                    Text(
                      '${formatNumber(_balance)}  REGT',
                      style: const TextStyle(
                        color: Colors.white,
                        fontSize: 14,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    const SizedBox(width: 4),
                    // Text(
                    //   '\$${formatNumber(_balance * usdRate)}',
                    //   style: const TextStyle(color: Colors.grey),
                    // ),
                  ],
                ),
              ],
            ),
          ),
          // Balance Card
          Padding(
            padding: const EdgeInsets.all(16.0),
            child: Container(
              decoration: BoxDecoration(
                gradient: const LinearGradient(
                  colors: [Color(0xFF1A1A1A), Color(0xFF2A2A2A)],
                  begin: Alignment.centerLeft,
                  end: Alignment.centerRight,
                ),
                borderRadius: BorderRadius.circular(12),
                border: Border.all(
                  color: const Color(0xFFFFD700).withOpacity(0.2),
                ),
              ),
              child: Padding(
                padding: const EdgeInsets.all(16.0),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            const Text(
                              'Total Balance',
                              style: TextStyle(
                                color: Colors.grey,
                                fontSize: 16,
                              ),
                            ),
                            Text(
                              '${formatNumber(_balance)} REGT',
                              style: const TextStyle(
                                color: Colors.white,
                                fontSize: 32,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                            Text(
                              ' \$${formatNumber(_balance * usdRate)} USD',
                              style: const TextStyle(
                                color: Colors.grey,
                                fontSize: 14,
                              ),
                            ),
                          ],
                        ),
                        IconButton(
                          onPressed: _isRefreshing ? null : _loadData,
                          icon: _isRefreshing
                              ? const SizedBox(
                                  width: 20,
                                  height: 20,
                                  child: CircularProgressIndicator(
                                    strokeWidth: 2,
                                    color: Color(0xFFFFD700),
                                  ),
                                )
                              : const Icon(
                                  Icons.refresh,
                                  color: Color(0xFFFFD700),
                                ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 16),

                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                      children: [
                        SizedBox(
                          width:
                              120, // Adjust this value to change the button size (e.g., 120 for smaller, 200 for larger)
                          height: 120,
                          child: ElevatedButton(
                            onPressed: () => setState(() => _currentIndex = 1),
                            style: ElevatedButton.styleFrom(
                              backgroundColor: Colors.blue.withOpacity(0.2),
                              side: BorderSide(
                                color: Colors.blue.withOpacity(0.3),
                              ),
                              foregroundColor: Colors.blue[300],
                              shape: const CircleBorder(),
                            ),
                            child: const Column(
                              mainAxisAlignment: MainAxisAlignment.center,
                              children: [
                                Icon(Icons.play_arrow, size: 42),
                                SizedBox(height: 4),
                                Text('Ads'),
                              ],
                            ),
                          ),
                        ),
                        SizedBox(
                          width:
                              120, // Adjust this value to change the button size (e.g., 120 for smaller, 200 for larger)
                          height: 120,
                          child: ElevatedButton(
                            onPressed: () => setState(() => _currentIndex = 2),
                            style: ElevatedButton.styleFrom(
                              backgroundColor: Colors.green.withOpacity(0.2),
                              side: BorderSide(
                                color: Colors.green.withOpacity(0.3),
                              ),
                              foregroundColor: Colors.green[300],
                              shape: const CircleBorder(),
                            ),
                            child: const Column(
                              mainAxisAlignment: MainAxisAlignment.center,
                              children: [
                                Icon(Icons.description, size: 32),
                                SizedBox(height: 4),
                                Text('Surveys'),
                              ],
                            ),
                          ),
                        ),
                      ],
                    ),
                  ],
                ),
              ),
            ),
          ),
          // Quick Stats
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 16.0),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceAround,
              children: [
                _buildStatCard('12', 'Ads Today'),
                _buildStatCard('2', 'Surveys'),
                _buildStatCard(_stats.totalReferrals.toString(), 'Referrals'),
              ],
            ),
          ),
          // Referral Link Card
          Padding(
            padding: const EdgeInsets.all(16),
            child: Container(
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                gradient: const LinearGradient(
                  begin: Alignment.centerLeft,
                  end: Alignment.centerRight,
                  colors: [Color(0xff1a1a1a), Color(0xff2a2a2a)],
                ),
                borderRadius: BorderRadius.circular(12),
                border: Border.all(
                  color: const Color(0xffFFD700).withOpacity(0.2),
                ),
              ),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const Row(
                    children: [
                      Icon(Icons.share, color: Color(0xffFFD700), size: 20),
                      SizedBox(width: 8),
                      Text(
                        'Referral Link',
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: 16,
                          fontWeight: FontWeight.w600,
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 12),
                  // Container(
                  //   width: double.infinity,
                  //   padding: const EdgeInsets.all(12),
                  //   decoration: BoxDecoration(color: const Color(0xff0a0a0a), borderRadius: BorderRadius.circular(8)),
                  //   child: Text(_referralLink, style: const TextStyle(color: Color(0xffFFD700), fontFamily: 'Courier', fontSize: 12), softWrap: true),
                  // ),
                  const SizedBox(height: 16),
                  Row(
                    children: [
                      Expanded(
                        child: ElevatedButton(
                          onPressed: () async {
                            await Clipboard.setData(
                              ClipboardData(text: _referralLink),
                            );
                            if (context.mounted) {
                              ScaffoldMessenger.of(context).showSnackBar(
                                const SnackBar(
                                  content: Text(
                                    'Referral link copied to clipboard!',
                                  ),
                                ),
                              );
                            }
                          },
                          style: ElevatedButton.styleFrom(
                            backgroundColor: const Color(0xff2a2a2a),
                            side: const BorderSide(color: Color(0xff808080)),
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(8),
                            ),
                          ),
                          child: const Row(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              Icon(Icons.copy, color: Colors.white, size: 16),
                              SizedBox(width: 8),
                              Text(
                                'Copy Link',
                                style: TextStyle(color: Colors.white),
                              ),
                            ],
                          ),
                        ),
                      ),
                      const SizedBox(width: 8),
                      Expanded(
                        child: ElevatedButton(
                          onPressed: _showShareModal,
                          style: ElevatedButton.styleFrom(
                            backgroundColor: const Color(0xffFFD700),
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(8),
                            ),
                          ),
                          child: const Row(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              Icon(Icons.share, color: Colors.black, size: 16),
                              SizedBox(width: 8),
                              Text(
                                'Share',
                                style: TextStyle(color: Colors.black),
                              ),
                            ],
                          ),
                        ),
                      ),
                    ],
                  ),
                ],
              ),
            ),
          ),
          // Commission Earnings Card
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 16),
            child: Container(
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: const Color(0xff1a1a1a),
                borderRadius: BorderRadius.circular(12),
                border: Border.all(color: const Color(0xff808080)),
              ),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      const Row(
                        children: [
                          Icon(
                            Icons.card_giftcard,
                            color: Color(0xffFFD700),
                            size: 20,
                          ),
                          SizedBox(width: 8),
                          Text(
                            'Commission Earnings',
                            style: TextStyle(
                              color: Colors.white,
                              fontSize: 16,
                              fontWeight: FontWeight.w600,
                            ),
                          ),
                        ],
                      ),
                      Icon(
                        Icons.trending_up,
                        color: Colors.green[400],
                        size: 20,
                      ),
                    ],
                  ),
                  const SizedBox(height: 12),
                  Row(
                    children: [
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              '${_stats.totalCommissions.toStringAsFixed(2)} REGT',
                              style: const TextStyle(
                                color: Color(0xffFFD700),
                                fontSize: 24,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                            const Text(
                              'Total Earned',
                              style: TextStyle(
                                color: Color(0xff808080),
                                fontSize: 12,
                              ),
                            ),
                          ],
                        ),
                      ),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              '${_stats.thisMonthCommissions.toStringAsFixed(2)} REGT',
                              style: TextStyle(
                                color: Colors.green[400],
                                fontSize: 20,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                            const Text(
                              'This Month',
                              style: TextStyle(
                                color: Color(0xff808080),
                                fontSize: 12,
                              ),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                ],
              ),
            ),
          ),
          // Pending Withdrawals Header
          Padding(
            padding: const EdgeInsets.fromLTRB(16.0, 16.0, 16.0, 8.0),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                const Text(
                  'Pending Withdrawals',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 18,
                    fontWeight: FontWeight.w100,
                  ),
                ),
                ElevatedButton(
                  onPressed: () => Navigator.pushNamed(context, '/withdrawal'),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: const Color(0xFFFFD700),
                    foregroundColor: Colors.black,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(8),
                    ),
                  ),
                  child: const Row(
                    children: [
                      Icon(Icons.arrow_forward, size: 16),
                      SizedBox(width: 4),
                      Text('Withdraw'),
                    ],
                  ),
                ),
              ],
            ),
          ),
          // Pending Withdrawals List or Empty Message
          if (_withdrawals.isEmpty)
            const Padding(
              padding: EdgeInsets.symmetric(horizontal: 16.0),
              child: Text(
                'No pending withdrawals',
                style: TextStyle(color: Colors.grey, fontSize: 14),
              ),
            )
          else
            ListView.builder(
              shrinkWrap: true,
              physics: const NeverScrollableScrollPhysics(),
              itemCount: _withdrawals.length,
              itemBuilder: (context, index) {
                final item = _withdrawals[index];
                final amount = item['amount'] as num? ?? 0;
                String method = item['method'] as String? ?? 'Unknown';
                String status = item['status'] as String? ?? 'pending';
                final requestDate =
                    item['request_date'] as String? ??
                    DateTime.now().toIso8601String().split('T')[0];
                final dateParts = requestDate.split('-');
                final formattedDate = dateParts.length == 3
                    ? '${dateParts[1]}/${dateParts[2]}/${dateParts[0]}'
                    : requestDate;
                // Capitalize status and method for display
                status = '${status[0].toUpperCase()}${status.substring(1)}';
                method = method
                    .split(' ')
                    .map(
                      (word) => '${word[0].toUpperCase()}${word.substring(1)}',
                    )
                    .join(' ');

                return Padding(
                  padding: const EdgeInsets.only(
                    bottom: 8.0,
                    left: 16.0,
                    right: 16.0,
                  ),
                  child: Container(
                    decoration: BoxDecoration(
                      color: const Color(0xFF1A1A1A),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Padding(
                      padding: const EdgeInsets.all(12.0),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Row(
                            mainAxisAlignment: MainAxisAlignment.spaceBetween,
                            children: [
                              Text(
                                '$amount REGT',
                                style: const TextStyle(
                                  color: Colors.white,
                                  fontSize: 16,
                                  fontWeight: FontWeight.bold,
                                ),
                              ),
                              Container(
                                padding: const EdgeInsets.symmetric(
                                  horizontal: 8,
                                  vertical: 4,
                                ),
                                decoration: BoxDecoration(
                                  color: const Color(0xFFFFD700),
                                  borderRadius: BorderRadius.circular(12),
                                ),
                                child: Text(
                                  status,
                                  style: const TextStyle(
                                    color: Colors.black,
                                    fontSize: 12,
                                  ),
                                ),
                              ),
                            ],
                          ),
                          const SizedBox(height: 4),
                          Row(
                            mainAxisAlignment: MainAxisAlignment.spaceBetween,
                            children: [
                              Text(
                                method,
                                style: const TextStyle(
                                  color: Colors.grey,
                                  fontSize: 14,
                                ),
                              ),
                              Text(
                                formattedDate,
                                style: const TextStyle(
                                  color: Colors.grey,
                                  fontSize: 14,
                                ),
                              ),
                            ],
                          ),
                        ],
                      ),
                    ),
                  ),
                );
              },
            ),
          // Recent Activity Header
          Padding(
            padding: const EdgeInsets.fromLTRB(16.0, 16.0, 16.0, 8.0),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                const Text(
                  'Recent Activity',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 18,
                    fontWeight: FontWeight.w100,
                  ),
                ),
                // ElevatedButton(
                //   onPressed: () => Navigator.pushNamed(context, '/withdrawal'),
                //   style: ElevatedButton.styleFrom(
                //     backgroundColor: const Color(0xFFFFD700),
                //     foregroundColor: Colors.black,
                //     shape: RoundedRectangleBorder(
                //       borderRadius: BorderRadius.circular(8),
                //     ),
                //   ),
                //   child: const Row(
                //     children: [
                //       Icon(Icons.arrow_forward, size: 16),
                //       SizedBox(width: 4),
                //       Text('Withdraw'),
                //     ],
                //   ),
                // ),
              ],
            ),
          ),
          // Transaction List
          ListView.builder(
            shrinkWrap: true,
            physics: const NeverScrollableScrollPhysics(),
            itemCount: _history.length > _displayedHistoryCount
                ? _displayedHistoryCount
                : _history.length,
            itemBuilder: (context, index) {
              final item = _history[index];
              final type = item['type'] as String? ?? 'unknown';
              final amount = (item['amount'] as num?)?.toDouble() ?? 0.0;
              final dateStr =
                  item['date'] as String? ?? DateTime.now().toIso8601String();
              final date = DateTime.parse(dateStr);
              final timeAgo = _formatTimeAgo(date);
              final description = _formatDescription(type);
              final icon = _getTransactionIcon(type);
              final amountColor = amount >= 0
                  ? Colors.green[400]
                  : Colors.red[400];
              final sign = amount > 0 ? '+' : (amount < 0 ? '-' : '');

              return Padding(
                padding: const EdgeInsets.only(
                  bottom: 8.0,
                  left: 16.0,
                  right: 16.0,
                ),
                child: Container(
                  decoration: BoxDecoration(
                    color: const Color(0xFF1A1A1A),
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: ListTile(
                    leading: CircleAvatar(
                      backgroundColor: Colors.grey[800],
                      child: Icon(icon, color: amountColor, size: 16),
                    ),
                    title: Text(
                      description,
                      style: const TextStyle(color: Colors.white, fontSize: 14),
                    ),
                    subtitle: Text(
                      timeAgo,
                      style: const TextStyle(color: Colors.grey, fontSize: 12),
                    ),
                    trailing: Text(
                      '$sign${formatNumber(amount.abs())} REGT',
                      style: TextStyle(
                        color: amountColor,
                        fontWeight: FontWeight.bold,
                        fontSize: 14,
                      ),
                    ),
                  ),
                ),
              );
            },
          ),
          if (_displayedHistoryCount < _history.length)
            Padding(
              padding: const EdgeInsets.all(16.0),
              child: ElevatedButton(
                onPressed: _loadMoreHistory,
                style: ElevatedButton.styleFrom(
                  backgroundColor: const Color(0xFFFFD700),
                  foregroundColor: Colors.black,
                ),
                child: const Text('Load More'),
              ),
            ),
          const SizedBox(height: 80), // Padding for bottom nav
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.black,
      body: IndexedStack(
        index: _currentIndex,
        children: [
          _buildHomeContent(),
          const AdsScreen(),
          // const SurveysScreen(),
          const ReferralsScreen(),
          const ProfileScreen(),
        ],
      ),
      bottomNavigationBar: BottomNavigationBar(
        backgroundColor: Colors.black,
        selectedItemColor: const Color(0xFFFFD700),
        unselectedItemColor: Colors.white,
        type: BottomNavigationBarType.fixed,
        currentIndex: _currentIndex,
        items: const [
          BottomNavigationBarItem(icon: Icon(Icons.home), label: 'Home'),
          BottomNavigationBarItem(icon: Icon(Icons.play_arrow), label: 'Ads'),
          // BottomNavigationBarItem(icon: Icon(Icons.description), label: 'Surveys'),
          BottomNavigationBarItem(icon: Icon(Icons.people), label: 'Referrals'),
          BottomNavigationBarItem(icon: Icon(Icons.person), label: 'Profile'),
        ],
        onTap: (index) {
          setState(() {
            _currentIndex = index;
          });
        },
      ),
    );
  }

  Widget _buildStatCard(String value, String label) {
    return Expanded(
      child: Container(
        margin: const EdgeInsets.symmetric(horizontal: 4.0),
        padding: const EdgeInsets.all(12.0),
        decoration: BoxDecoration(
          color: const Color(0xFF1A1A1A),
          borderRadius: BorderRadius.circular(8),
          border: Border.all(color: Colors.grey[800]!),
        ),
        child: Column(
          children: [
            Text(
              value,
              style: const TextStyle(
                color: Color(0xFFFFD700),
                fontWeight: FontWeight.bold,
                fontSize: 16,
              ),
            ),
            Text(
              label,
              style: const TextStyle(color: Colors.grey, fontSize: 12),
            ),
          ],
        ),
      ),
    );
  }
}


// File: c:\Users\Youssef\Documents\flutter_apps\regt_app\lib\screens\login_screen.dart
// import 'package:flutter/material.dart';
// import 'package:google_sign_in/google_sign_in.dart';
// import 'package:regt_app/providers/app_state.dart';
// import 'package:supabase_flutter/supabase_flutter.dart';
// import 'package:provider/provider.dart';
// import 'package:flutter_secure_storage/flutter_secure_storage.dart';

// class LoginScreen extends StatefulWidget {
//   const LoginScreen({super.key});

//   @override
//   State<LoginScreen> createState() => _LoginScreenState();
// }

// class _LoginScreenState extends State<LoginScreen> {
//   final _emailController = TextEditingController();
//   final _passwordController = TextEditingController();
//   final _storage = FlutterSecureStorage();

//   Future<void> _signUp() async {
//     try {
//       final response = await Supabase.instance.client.auth.signUp(
//         email: _emailController.text,
//         password: _passwordController.text,
//       );
//       if (response.user != null) {
//         final userId = response.user!.id;
//         await Supabase.instance.client.from('profiles').insert({
//           'id': userId,
//           'email': _emailController.text,
//           'language': 'en',
//         });
//         await Supabase.instance.client.from('user_balances').insert({
//           'user_id': userId,
//           'balance': 1.0,
//           'transaction_history': '[{"type": "signup_gift", "amount": 1.0, "date": "${DateTime.now().toIso8601String()}"}]',
//         });
//         _saveSession(response.session!);
//         Navigator.pushReplacementNamed(context, '/home');
//       }
//     } catch (e) {
//       ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('$e')));
//     }
//   }

//   Future<void> _signIn() async {
//     try {
//       final response = await Supabase.instance.client.auth.signInWithPassword(
//         email: _emailController.text,
//         password: _passwordController.text,
//       );
//       if (response.session != null) {
//         _saveSession(response.session!);
//         Navigator.pushReplacementNamed(context, '/home');
//       }
//     } catch (e) {
//       ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('$e')));
//     }
//   }

//   Future<void> _googleSignIn() async {
//     try {
//       final googleSignIn = GoogleSignIn();
//       final googleUser = await googleSignIn.signIn();
//       if (googleUser == null) return;

//       final googleAuth = await googleUser.authentication;
//       final accessToken = googleAuth.accessToken;
//       final idToken = googleAuth.idToken;

//       if (accessToken == null || idToken == null) return;

//       final response = await Supabase.instance.client.auth.signInWithIdToken(
//         provider: OAuthProvider.google,
//         idToken: idToken,
//         accessToken: accessToken,
//       );
//       if (response.session != null) {
//         final userId = response.user!.id;
//         final existingProfile = await Supabase.instance.client.from('profiles').select().eq('id', userId).maybeSingle();
//         if (existingProfile == null) {
//           await Supabase.instance.client.from('profiles').insert({
//             'id': userId,
//             'email': googleUser.email,
//             'google_id': googleUser.id,
//             'language': 'en',
//           });
//           await Supabase.instance.client.from('user_balances').insert({
//             'user_id': userId,
//             'balance': 1.0,
//             'transaction_history': '[{"type": "signup_gift", "amount": 1.0, "date": "${DateTime.now().toIso8601String()}"}]',
//           });
//         }
//         _saveSession(response.session!);
//         Navigator.pushReplacementNamed(context, '/home');
//       }
//     } catch (e) {
//       ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('$e')));
//     }
//   }

//   Future<void> _saveSession(Session session) async {
//     await _storage.write(key: 'access_token', value: session.accessToken);
//     await _storage.write(key: 'refresh_token', value: session.refreshToken ?? '');
//   }

//   @override
//   Widget build(BuildContext context) {
//     return Scaffold(
//       backgroundColor: Colors.black,
//       body: Padding(
//         padding: const EdgeInsets.all(16.0),
//         child: Column(
//           mainAxisAlignment: MainAxisAlignment.center,
//           children: [
//             TextField(
//               controller: _emailController,
//               decoration: const InputDecoration(labelText: 'Email', labelStyle: TextStyle(color: Colors.white)),
//               style: const TextStyle(color: Colors.white),
//             ),
//             TextField(
//               controller: _passwordController,
//               obscureText: true,
//               decoration: const InputDecoration(labelText: 'Password', labelStyle: TextStyle(color: Colors.white)),
//               style: const TextStyle(color: Colors.white),
//             ),
//             ElevatedButton(onPressed: _signIn, child: const Text('Login')),
//             ElevatedButton(onPressed: _signUp, child: const Text('Sign Up')),
//             ElevatedButton(onPressed: _googleSignIn, child: const Text('Google Sign In')),
//           ],
//         ),
//       ),
//     );
//   }
// }

// import 'package:flutter/material.dart';
// import 'package:google_sign_in/google_sign_in.dart';
// import 'package:supabase_flutter/supabase_flutter.dart';
// import 'package:flutter_secure_storage/flutter_secure_storage.dart';

// class LoginScreen extends StatefulWidget {
//   const LoginScreen({super.key});

//   @override
//   State<LoginScreen> createState() => _LoginScreenState();
// }

// class _LoginScreenState extends State<LoginScreen> {
//   final _emailController = TextEditingController();
//   final _passwordController = TextEditingController();
//   final _storage = FlutterSecureStorage();
//   bool _isLoading = false;

//   Future<void> _signUp() async {
//   setState(() {
//     _isLoading = true;
//   });

//   try {
//     final response = await Supabase.instance.client.auth.signUp(
//       email: _emailController.text.trim(),
//       password: _passwordController.text,
//     );

//     if (response.user != null) {
//       if (response.session != null) {
//         // Confirmation is off: Immediate login
//         await _saveSession(response.session!);
//         if (mounted) {
//           ScaffoldMessenger.of(context).showSnackBar(
//             const SnackBar(content: Text('Sign-up successful! Welcome!')),
//           );
//           Navigator.pushReplacementNamed(context, '/home');
//         }
//       } else {
//         // Confirmation is on: User created, but needs email verification
//         if (mounted) {
//           ScaffoldMessenger.of(context).showSnackBar(
//             const SnackBar(content: Text('Sign-up successful! Check your email to confirm.')),
//           );
//           // Optionally navigate to a confirmation screen or back to login
//         }
//       }
//     } else {
//       if (mounted) {
//         ScaffoldMessenger.of(context).showSnackBar(
//           const SnackBar(content: Text('Sign-up failed. Please try again.')),
//         );
//       }
//     }
//   } catch (e) {
//     if (mounted) {
//       ScaffoldMessenger.of(context).showSnackBar(
//         SnackBar(content: Text('Error during sign-up: ${e.toString().split(':').last.trim()}')),
//       );
//     }
//   } finally {
//     if (mounted) {
//       setState(() {
//         _isLoading = false;
//       });
//     }
//   }
// }

//   Future<void> _signIn() async {
//     setState(() {
//       _isLoading = true;
//     });

//     try {
//       final response = await Supabase.instance.client.auth.signInWithPassword(
//         email: _emailController.text.trim(),
//         password: _passwordController.text,
//       );

//       if (response.session != null) {
//         await _saveSession(response.session!);
//         if (mounted) {
//           ScaffoldMessenger.of(context).showSnackBar(
//             const SnackBar(content: Text('Login successful!')),
//           );
//           Navigator.pushReplacementNamed(context, '/home');
//         }
//       } else {
//         if (mounted) {
//           ScaffoldMessenger.of(context).showSnackBar(
//             const SnackBar(content: Text('Login failed. Check your credentials.')),
//           );
//         }
//       }
//     } catch (e) {
//       if (mounted) {
//         ScaffoldMessenger.of(context).showSnackBar(
//           SnackBar(content: Text('Error during login: ${e.toString().split(':').last.trim()}')),
//         );
//       }
//     } finally {
//       if (mounted) {
//         setState(() {
//           _isLoading = false;
//         });
//       }
//     }
//   }

//   Future<void> _googleSignIn() async {
//     setState(() {
//       _isLoading = true;
//     });

//     try {
//       final googleSignIn = GoogleSignIn();
//       final googleUser = await googleSignIn.signIn();
//       if (googleUser == null) {
//         if (mounted) {
//           ScaffoldMessenger.of(context).showSnackBar(
//             const SnackBar(content: Text('Google Sign-In cancelled.')),
//           );
//         }
//         return;
//       }

//       final googleAuth = await googleUser.authentication;
//       final accessToken = googleAuth.accessToken;
//       final idToken = googleAuth.idToken;

//       if (accessToken == null || idToken == null) {
//         if (mounted) {
//           ScaffoldMessenger.of(context).showSnackBar(
//             const SnackBar(content: Text('Failed to retrieve Google authentication tokens.')),
//           );
//         }
//         return;
//       }

//       final response = await Supabase.instance.client.auth.signInWithIdToken(
//         provider: OAuthProvider.google,
//         idToken: idToken,
//         accessToken: accessToken,
//       );

//       if (response.session != null) {
//         // The handle_new_user trigger handles profiles and user_balances for new users
//         await _saveSession(response.session!);
//         if (mounted) {
//           ScaffoldMessenger.of(context).showSnackBar(
//             const SnackBar(content: Text('Google Sign-In successful!')),
//           );
//           Navigator.pushReplacementNamed(context, '/home');
//         }
//       } else {
//         if (mounted) {
//           ScaffoldMessenger.of(context).showSnackBar(
//             const SnackBar(content: Text('Google Sign-In failed. Please try again.')),
//           );
//         }
//       }
//     } catch (e) {
//       if (mounted) {
//         ScaffoldMessenger.of(context).showSnackBar(
//           SnackBar(content: Text('Error during Google Sign-In: ${e.toString().split(':').last.trim()}')),
//         );
//       }
//     } finally {
//       if (mounted) {
//         setState(() {
//           _isLoading = false;
//         });
//       }
//     }
//   }

//   Future<void> _saveSession(Session session) async {
//     await _storage.write(key: 'access_token', value: session.accessToken);
//     await _storage.write(key: 'refresh_token', value: session.refreshToken ?? '');
//   }

//   @override
//   void dispose() {
//     _emailController.dispose();
//     _passwordController.dispose();
//     super.dispose();
//   }

//   @override
//   Widget build(BuildContext context) {
//     return Scaffold(
//       backgroundColor: Colors.black,
//       body: Padding(
//         padding: const EdgeInsets.all(16.0),
//         child: Column(
//           mainAxisAlignment: MainAxisAlignment.center,
//           children: [
//             TextField(
//               controller: _emailController,
//               decoration: const InputDecoration(
//                 labelText: 'Email',
//                 labelStyle: TextStyle(color: Colors.white),
//                 enabledBorder: OutlineInputBorder(
//                   borderSide: BorderSide(color: Colors.white),
//                 ),
//                 focusedBorder: OutlineInputBorder(
//                   borderSide: BorderSide(color: Colors.blue),
//                 ),
//               ),
//               style: const TextStyle(color: Colors.white),
//               keyboardType: TextInputType.emailAddress,
//             ),
//             const SizedBox(height: 16),
//             TextField(
//               controller: _passwordController,
//               obscureText: true,
//               decoration: const InputDecoration(
//                 labelText: 'Password',
//                 labelStyle: TextStyle(color: Colors.white),
//                 enabledBorder: OutlineInputBorder(
//                   borderSide: BorderSide(color: Colors.white),
//                 ),
//                 focusedBorder: OutlineInputBorder(
//                   borderSide: BorderSide(color: Colors.blue),
//                 ),
//               ),
//               style: const TextStyle(color: Colors.white),
//             ),
//             const SizedBox(height: 20),
//             if (_isLoading)
//               const CircularProgressIndicator()
//             else ...[
//               ElevatedButton(
//                 onPressed: _signIn,
//                 style: ElevatedButton.styleFrom(
//                   foregroundColor: Colors.black,
//                   backgroundColor: Colors.white,
//                   minimumSize: const Size(double.infinity, 50),
//                 ),
//                 child: const Text('Login'),
//               ),
//               const SizedBox(height: 10),
//               ElevatedButton(
//                 onPressed: _signUp,
//                 style: ElevatedButton.styleFrom(
//                   foregroundColor: Colors.black,
//                   backgroundColor: Colors.white,
//                   minimumSize: const Size(double.infinity, 50),
//                 ),
//                 child: const Text('Sign Up'),
//               ),
//               const SizedBox(height: 10),
//               ElevatedButton(
//                 onPressed: _googleSignIn,
//                 style: ElevatedButton.styleFrom(
//                   foregroundColor: Colors.black,
//                   backgroundColor: Colors.white,
//                   minimumSize: const Size(double.infinity, 50),
//                 ),
//                 child: const Text('Google Sign In'),
//               ),
//             ],
//           ],
//         ),
//       ),
//     );
//   }
// }

import 'package:flutter/material.dart';
import 'package:google_sign_in/google_sign_in.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:flutter_secure_storage/flutter_secure_storage.dart';

class LoginScreen extends StatefulWidget {
  const LoginScreen({super.key});

  @override
  State<LoginScreen> createState() => _LoginScreenState();
}

class _LoginScreenState extends State<LoginScreen> {
  final _emailController = TextEditingController();
  final _passwordController = TextEditingController();
  final _confirmPasswordController = TextEditingController();
  final _forgotEmailController = TextEditingController();
  final _storage = FlutterSecureStorage();
  bool _isLoading = false;
  bool isLogin = true;
  bool showPassword = false;
  bool showConfirmPassword = false;
  bool showForgotPassword = false;
  String? formError;

  bool validateEmail(String email) {
    final emailRegex = RegExp(r'^[^\s@]+@[^\s@]+\.[^\s@]+$');
    return emailRegex.hasMatch(email);
  }

  Future<void> handleSubmit() async {
    setState(() {
      formError = null;
      _isLoading = true;
    });

    final email = _emailController.text.trim();
    final password = _passwordController.text;
    final confirmPassword = _confirmPasswordController.text;

    if (email.isEmpty ||
        password.isEmpty ||
        (!isLogin && confirmPassword.isEmpty)) {
      setState(() {
        formError = 'Please fill in all fields';
      });
      _isLoading = false;
      return;
    }

    if (!validateEmail(email)) {
      setState(() {
        formError = 'Please enter a valid email address';
      });
      _isLoading = false;
      return;
    }

    if (password.length < 6) {
      setState(() {
        formError = 'Password must be at least 6 characters';
      });
      _isLoading = false;
      return;
    }

    if (!isLogin && password != confirmPassword) {
      setState(() {
        formError = 'Passwords do not match';
      });
      _isLoading = false;
      return;
    }

    if (isLogin) {
      await _signIn();
    } else {
      await _signUp();
    }
  }

  Future<void> _signUp() async {
    try {
      final response = await Supabase.instance.client.auth.signUp(
        email: _emailController.text.trim(),
        password: _passwordController.text,
        // emailRedirectTo:
        //       'com.primesoftworks.regtapp://auth/callback',
      );

      if (response.user != null) {
        if (response.session != null) {
          // Confirmation is off: Immediate login
          await _saveSession(response.session!);
          if (mounted) {
            ScaffoldMessenger.of(context).showSnackBar(
              const SnackBar(content: Text('Sign-up successful! Welcome!')),
            );
            Navigator.pushReplacementNamed(context, '/home');
          }
        } else {
          // Confirmation is on: User created, but needs email verification
          if (mounted) {
            ScaffoldMessenger.of(context).showSnackBar(
              const SnackBar(
                content: Text(
                  'Sign-up successful! Check your email to confirm.',
                ),
              ),
            );
            // Optionally navigate to a confirmation screen or back to login
          }
        }
      } else {
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(content: Text('Sign-up failed. Please try again.')),
          );
        }
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(
              'Error during sign-up: ${e.toString().split(':').last.trim()}',
            ),
          ),
        );
      }
    } finally {
      if (mounted) {
        setState(() {
          _isLoading = false;
        });
      }
    }
  }

  Future<void> _signIn() async {
    try {
      final response = await Supabase.instance.client.auth.signInWithPassword(
        email: _emailController.text.trim(),
        password: _passwordController.text,
      );

      if (response.session != null) {
        await _saveSession(response.session!);
        if (mounted) {
          ScaffoldMessenger.of(
            context,
          ).showSnackBar(const SnackBar(content: Text('Login successful!')));
          Navigator.pushReplacementNamed(context, '/home');
        }
      } else {
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text('Login failed. Check your credentials.'),
            ),
          );
        }
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(
              'Error during login: ${e.toString().split(':').last.trim()}',
            ),
          ),
        );
      }
    } finally {
      if (mounted) {
        setState(() {
          _isLoading = false;
        });
      }
    }
  }

  // Future<void> _googleSignIn() async {
  //   setState(() {
  //     _isLoading = true;
  //   });

  //   try {
  //     final googleSignIn = GoogleSignIn();
  //     final googleUser = await googleSignIn.signIn();
  //     if (googleUser == null) {
  //       if (mounted) {
  //         ScaffoldMessenger.of(context).showSnackBar(
  //           const SnackBar(content: Text('Google Sign-In cancelled.')),
  //         );
  //       }
  //       return;
  //     }

  //     final googleAuth = await googleUser.authentication;
  //     final accessToken = googleAuth.accessToken;
  //     final idToken = googleAuth.idToken;

  //     if (accessToken == null || idToken == null) {
  //       if (mounted) {
  //         ScaffoldMessenger.of(context).showSnackBar(
  //           const SnackBar(
  //             content: Text('Failed to retrieve Google authentication tokens.'),
  //           ),
  //         );
  //       }
  //       return;
  //     }

  //     final response = await Supabase.instance.client.auth.signInWithIdToken(
  //       provider: OAuthProvider.google,
  //       idToken: idToken,
  //       accessToken: accessToken,
  //     );

  //     if (response.session != null) {
  //       // The handle_new_user trigger handles profiles and user_balances for new users
  //       await _saveSession(response.session!);
  //       if (mounted) {
  //         ScaffoldMessenger.of(context).showSnackBar(
  //           const SnackBar(content: Text('Google Sign-In successful!')),
  //         );
  //         Navigator.pushReplacementNamed(context, '/home');
  //       }
  //     } else {
  //       if (mounted) {
  //         ScaffoldMessenger.of(context).showSnackBar(
  //           const SnackBar(
  //             content: Text('Google Sign-In failed. Please try again.'),
  //           ),
  //         );
  //       }
  //     }
  //   } catch (e) {
  //     if (mounted) {
  //       ScaffoldMessenger.of(context).showSnackBar(
  //         SnackBar(
  //           content: Text(
  //             'Error during Google Sign-In: ${e.toString().split(':').last.trim()}',
  //           ),
  //         ),
  //       );
  //     }
  //   } finally {
  //     if (mounted) {
  //       setState(() {
  //         _isLoading = false;
  //       });
  //     }
  //   }
  // }

  Future<void> _googleSignIn() async {
    setState(() {
      _isLoading = true;
    });

    try {
      // Replace with your actual Web Client ID from Google Console
      const webClientId = '204826913831-4e80hmmq6tnr9dv943vqo2bj03ra8b7h.apps.googleusercontent.com';

      final googleSignIn = GoogleSignIn(
        serverClientId: webClientId, // This gets the idToken for Supabase
      );
      final googleUser = await googleSignIn.signIn();
      if (googleUser == null) {
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(content: Text('Google Sign-In cancelled.')),
          );
        }
        return;
      }

      final googleAuth = await googleUser.authentication;
      final accessToken = googleAuth.accessToken;
      final idToken = googleAuth.idToken;

      if (accessToken == null || idToken == null) {
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text('Failed to retrieve Google authentication tokens.'),
            ),
          );
        }
        return;
      }

      final response = await Supabase.instance.client.auth.signInWithIdToken(
        provider: OAuthProvider.google,
        idToken: idToken,
        accessToken: accessToken,
      );

      if (response.session != null) {
        // The handle_new_user trigger handles profiles and user_balances for new users
        await _saveSession(response.session!);
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(content: Text('Google Sign-In successful!')),
          );
          Navigator.pushReplacementNamed(context, '/home');
        }
      } else {
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text('Google Sign-In failed. Please try again.'),
            ),
          );
        }
      }
    } catch (e) {
      print(
        'Detailed Google Sign-In error: $e',
      ); // Add this for console logging
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(
              'Error during Google Sign-In: ${e.toString().split(':').last.trim()}',
            ),
          ),
        );
      }
    } finally {
      if (mounted) {
        setState(() {
          _isLoading = false;
        });
      }
    }
  }

  Future<void> _forgotPassword() async {
    final forgotEmail = _forgotEmailController.text.trim();
    if (forgotEmail.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Please enter your email address')),
      );
      return;
    }
    if (!validateEmail(forgotEmail)) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Please enter a valid email address')),
      );
      return;
    }

    try {
      await Supabase.instance.client.auth.resetPasswordForEmail(forgotEmail);
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Password reset link sent to your email')),
      );
      setState(() {
        showForgotPassword = false;
      });
    } catch (e) {
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text('Error: ${e.toString()}')));
    }
  }

  Future<void> _saveSession(Session session) async {
    await _storage.write(key: 'access_token', value: session.accessToken);
    await _storage.write(
      key: 'refresh_token',
      value: session.refreshToken ?? '',
    );
  }

  @override
  void dispose() {
    _emailController.dispose();
    _passwordController.dispose();
    _confirmPasswordController.dispose();
    _forgotEmailController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    if (showForgotPassword) {
      return Scaffold(
        backgroundColor: Colors.black,
        body: Stack(
          children: [
            Container(
              decoration: const BoxDecoration(
                gradient: LinearGradient(
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                  colors: [Colors.black, Color(0xFF1A1A1A), Colors.black],
                ),
              ),
            ),
            Center(
              child: ConstrainedBox(
                constraints: const BoxConstraints(maxWidth: 400),
                child: Padding(
                  padding: const EdgeInsets.all(24.0),
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Container(
                        width: 64,
                        height: 64,
                        decoration: BoxDecoration(
                          color: const Color(0xFFFFD700),
                          shape: BoxShape.circle,
                        ),
                        child: const Icon(
                          Icons.mail,
                          size: 32,
                          color: Colors.black,
                        ),
                      ),
                      const SizedBox(height: 16),
                      const Text(
                        'Reset Password',
                        style: TextStyle(
                          fontSize: 24,
                          fontWeight: FontWeight.bold,
                          color: Colors.white,
                        ),
                      ),
                      const SizedBox(height: 8),
                      const Text(
                        'Enter your email to receive reset link',
                        style: TextStyle(color: Colors.grey, fontSize: 14),
                      ),
                      const SizedBox(height: 32),
                      TextField(
                        controller: _forgotEmailController,
                        decoration: InputDecoration(
                          prefixIcon: const Icon(
                            Icons.mail,
                            color: Colors.grey,
                          ),
                          hintText: 'Enter your email',
                          hintStyle: const TextStyle(color: Colors.grey),
                          fillColor: const Color(0xFF1A1A1A),
                          filled: true,
                          border: OutlineInputBorder(
                            borderRadius: BorderRadius.circular(8),
                            borderSide: const BorderSide(
                              color: Color(0xFF424242),
                            ),
                          ),
                        ),
                        style: const TextStyle(color: Colors.white),
                        keyboardType: TextInputType.emailAddress,
                      ),
                      const SizedBox(height: 20),
                      ElevatedButton(
                        onPressed: _forgotPassword,
                        style: ElevatedButton.styleFrom(
                          backgroundColor: const Color(0xFFFFD700),
                          foregroundColor: Colors.black,
                          minimumSize: const Size(double.infinity, 50),
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(8),
                          ),
                        ),
                        child: const Text('Send Reset Link'),
                      ),
                      const SizedBox(height: 16),
                      TextButton(
                        onPressed: () => setState(() {
                          showForgotPassword = false;
                        }),
                        child: const Text(
                          'Back to Login',
                          style: TextStyle(color: Colors.grey),
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ),
          ],
        ),
      );
    }

    return Scaffold(
      backgroundColor: Colors.black,
      body: Stack(
        children: [
          Container(
            decoration: const BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
                colors: [Colors.black, Color(0xFF1A1A1A), Colors.black],
              ),
            ),
          ),
          const Positioned(
            top: 80,
            right: 40,
            child: Opacity(
              opacity: 0.1,
              child: Icon(Icons.public, size: 80, color: Color(0xFFFFD700)),
            ),
          ),
          const Positioned(
            bottom: 128,
            left: 40,
            child: Opacity(
              opacity: 0.1,
              child: Icon(Icons.apartment, size: 64, color: Color(0xFFFFD700)),
            ),
          ),
          Center(
            child: ConstrainedBox(
              constraints: const BoxConstraints(maxWidth: 400),
              child: Padding(
                padding: const EdgeInsets.all(24.0),
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  crossAxisAlignment: CrossAxisAlignment.center,
                  children: [
                    // Container(
                    //   width: 80,
                    //   height: 80,
                    //   decoration: BoxDecoration(
                    //     gradient: const LinearGradient(
                    //       colors: [Color(0xFFFFD700), Color(0xFFFFA500)],
                    //     ),
                    //     shape: BoxShape.circle,
                    //     boxShadow: [
                    //       BoxShadow(
                    //         color: const Color(0xFFFFD700).withOpacity(0.3),
                    //         blurRadius: 20,
                    //         spreadRadius: 5,
                    //       ),
                    //     ],
                    //   ),
                    //   child: Center(
                    //     child: Container(
                    //       width: 56,
                    //       height: 56,
                    //       decoration: const BoxDecoration(
                    //         color: Colors.black,
                    //         shape: BoxShape.circle,
                    //       ),
                    //       child: const Icon(
                    //         Icons.public,
                    //         color: Color(0xFFFFD700),
                    //         size: 28,
                    //       ),
                    //     ),
                    //   ),
                    // ),
                    Container(
                      width: 100,
                      height: 100,
                      decoration: BoxDecoration(
                        gradient: const LinearGradient(
                          colors: [Color(0xFFFFD700), Color(0xFFFFA500)],
                        ),
                        shape: BoxShape.circle,
                        boxShadow: [
                          BoxShadow(
                            color: const Color(0xFFFFD700).withOpacity(0.3),
                            blurRadius: 20,
                            spreadRadius: 5,
                          ),
                        ],
                      ),
                      child: Center(
                        child: CircleAvatar(
                          radius: 50, // Increased for larger inner circle
                          backgroundColor: Colors.black,
                          backgroundImage: AssetImage(
                            'assets/images/regt_logo.png',
                          ),
                        ),
                      ),
                    ),
                    const SizedBox(height: 16),
                    const Text(
                      'REGT',
                      style: TextStyle(
                        fontSize: 32,
                        fontWeight: FontWeight.bold,
                        color: Color(0xFFFFD700),
                      ),
                    ),
                    const SizedBox(height: 8),
                    Text(
                      isLogin
                          ? 'Welcome back! Sign in to continue'
                          : 'Create your account to start earning',
                      style: const TextStyle(color: Colors.grey, fontSize: 14),
                    ),
                    const SizedBox(height: 32),
                    if (formError != null)
                      Container(
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          color: Colors.red.withOpacity(0.1),
                          border: Border.all(
                            color: Colors.red.withOpacity(0.2),
                          ),
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: Text(
                          formError!,
                          style: const TextStyle(
                            color: Colors.red,
                            fontSize: 14,
                          ),
                          textAlign: TextAlign.center,
                        ),
                      ),
                    if (formError != null) const SizedBox(height: 16),
                    TextField(
                      controller: _emailController,
                      decoration: InputDecoration(
                        prefixIcon: const Icon(Icons.mail, color: Colors.grey),
                        hintText: 'Email address',
                        hintStyle: const TextStyle(color: Colors.grey),
                        fillColor: const Color(0xFF1A1A1A),
                        filled: true,
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: const BorderSide(
                            color: Color(0xFF424242),
                          ),
                        ),
                        enabledBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: const BorderSide(
                            color: Color(0xFF424242),
                          ),
                        ),
                        focusedBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: const BorderSide(color: Colors.blue),
                        ),
                      ),
                      style: const TextStyle(color: Colors.white),
                      keyboardType: TextInputType.emailAddress,
                    ),
                    const SizedBox(height: 16),
                    TextField(
                      controller: _passwordController,
                      obscureText: !showPassword,
                      decoration: InputDecoration(
                        prefixIcon: const Icon(Icons.lock, color: Colors.grey),
                        suffixIcon: IconButton(
                          icon: Icon(
                            showPassword
                                ? Icons.visibility_off
                                : Icons.visibility,
                            color: Colors.grey,
                          ),
                          onPressed: () {
                            setState(() {
                              showPassword = !showPassword;
                            });
                          },
                        ),
                        hintText: 'Password',
                        hintStyle: const TextStyle(color: Colors.grey),
                        fillColor: const Color(0xFF1A1A1A),
                        filled: true,
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: const BorderSide(
                            color: Color(0xFF424242),
                          ),
                        ),
                        enabledBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: const BorderSide(
                            color: Color(0xFF424242),
                          ),
                        ),
                        focusedBorder: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(8),
                          borderSide: const BorderSide(color: Colors.blue),
                        ),
                      ),
                      style: const TextStyle(color: Colors.white),
                    ),
                    if (!isLogin) const SizedBox(height: 16),
                    if (!isLogin)
                      TextField(
                        controller: _confirmPasswordController,
                        obscureText: !showConfirmPassword,
                        decoration: InputDecoration(
                          prefixIcon: const Icon(
                            Icons.lock,
                            color: Colors.grey,
                          ),
                          suffixIcon: IconButton(
                            icon: Icon(
                              showConfirmPassword
                                  ? Icons.visibility_off
                                  : Icons.visibility,
                              color: Colors.grey,
                            ),
                            onPressed: () {
                              setState(() {
                                showConfirmPassword = !showConfirmPassword;
                              });
                            },
                          ),
                          hintText: 'Confirm password',
                          hintStyle: const TextStyle(color: Colors.grey),
                          fillColor: const Color(0xFF1A1A1A),
                          filled: true,
                          border: OutlineInputBorder(
                            borderRadius: BorderRadius.circular(8),
                            borderSide: const BorderSide(
                              color: Color(0xFF424242),
                            ),
                          ),
                          enabledBorder: OutlineInputBorder(
                            borderRadius: BorderRadius.circular(8),
                            borderSide: const BorderSide(
                              color: Color(0xFF424242),
                            ),
                          ),
                          focusedBorder: OutlineInputBorder(
                            borderRadius: BorderRadius.circular(8),
                            borderSide: const BorderSide(color: Colors.blue),
                          ),
                        ),
                        style: const TextStyle(color: Colors.white),
                      ),
                    const SizedBox(height: 20),
                    ElevatedButton(
                      onPressed: _isLoading ? null : handleSubmit,
                      style: ElevatedButton.styleFrom(
                        backgroundColor: const Color(0xFFFFD700),
                        foregroundColor: Colors.black,
                        minimumSize: const Size(double.infinity, 50),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(8),
                        ),
                      ),
                      child: _isLoading
                          ? const SizedBox(
                              width: 20,
                              height: 20,
                              child: CircularProgressIndicator(
                                strokeWidth: 2,
                                color: Colors.black,
                              ),
                            )
                          : Text(isLogin ? 'Sign In' : 'Create Account'),
                    ),
                    if (isLogin) const SizedBox(height: 8),
                    if (isLogin)
                      TextButton(
                        onPressed: () {
                          setState(() {
                            showForgotPassword = true;
                          });
                        },
                        child: const Text(
                          'Forgot Password?',
                          style: TextStyle(color: Colors.grey),
                        ),
                      ),
                    const SizedBox(height: 16),
                    ElevatedButton(
                      onPressed: _isLoading ? null : _googleSignIn,
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.white,
                        foregroundColor: Colors.black,
                        minimumSize: const Size(double.infinity, 50),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(8),
                        ),
                      ),
                      child: const Text('Google Sign In'),
                    ),
                    const SizedBox(height: 24),
                    Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Text(
                          isLogin
                              ? "Don't have an account?"
                              : 'Already have an account?',
                          style: const TextStyle(
                            color: Colors.grey,
                            fontSize: 14,
                          ),
                        ),
                        const SizedBox(width: 4),
                        TextButton(
                          onPressed: () {
                            setState(() {
                              isLogin = !isLogin;
                              formError = null;
                              _emailController.clear();
                              _passwordController.clear();
                              _confirmPasswordController.clear();
                            });
                          },
                          child: Text(
                            isLogin ? 'Sign Up' : 'Sign In',
                            style: const TextStyle(
                              color: Color(0xFFFFD700),
                              fontWeight: FontWeight.w100,
                            ),
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 32),
                    const Text(
                      'By continuing, you agree to our Terms of Service',
                      style: TextStyle(color: Color(0xFF9E9E9E), fontSize: 12),
                      textAlign: TextAlign.center,
                    ),
                  ],
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }
}


// File: c:\Users\Youssef\Documents\flutter_apps\regt_app\lib\screens\profile_screen.dart
// import 'package:flutter/material.dart';
// import 'package:supabase_flutter/supabase_flutter.dart';

// class ProfileScreen extends StatefulWidget {
//   const ProfileScreen({super.key});

//   @override
//   State<ProfileScreen> createState() => _ProfileScreenState();
// }

// class _ProfileScreenState extends State<ProfileScreen> {
//   String _language = 'en';
//   List<Map<String, dynamic>> _adLogs = [];
//   List<Map<String, dynamic>> _surveyLogs = [];

//   @override
//   void initState() {
//     super.initState();
//     _loadProfile();
//     _loadLogs();
//   }

//   Future<void> _loadProfile() async {
//     final userId = Supabase.instance.client.auth.currentUser?.id;
//     if (userId == null) return;

//     final data = await Supabase.instance.client.from('profiles').select('language').eq('id', userId).single();
//     setState(() => _language = data['language'] ?? 'en');
//   }

//   Future<void> _loadLogs() async {
//     final userId = Supabase.instance.client.auth.currentUser?.id;
//     if (userId == null) return;

//     _adLogs = await Supabase.instance.client.from('ad_events').select().eq('user_id', userId).order('timestamp', ascending: false);
//     _surveyLogs = await Supabase.instance.client.from('survey_logs').select().eq('user_id', userId).order('timestamp', ascending: false);
//     setState(() {});
//   }

//   Future<void> _updateLanguage(String newLang) async {
//     final userId = Supabase.instance.client.auth.currentUser?.id;
//     if (userId == null) return;

//     await Supabase.instance.client.from('profiles').update({'language': newLang}).eq('id', userId);
//     setState(() => _language = newLang);
//   }

//   @override
//   Widget build(BuildContext context) {
//     return Scaffold(
//       backgroundColor: Colors.black,
//       appBar: AppBar(title: const Text('Profile')),
//       body: ListView(
//         padding: const EdgeInsets.all(16.0),
//         children: [
//           DropdownButton<String>(
//             value: _language,
//             items: ['en', 'ar', 'hi', 'fr'].map((lang) => DropdownMenuItem(value: lang, child: Text(lang))).toList(),
//             onChanged: (val) => _updateLanguage(val!),
//             style: const TextStyle(color: Colors.white),
//           ),
//           const SizedBox(height: 20),
//           const Text('Ad Logs', style: TextStyle(color: Colors.amber, fontSize: 18)),
//           ..._adLogs.map((log) => ListTile(
//             title: Text('Status: ${log['status']} | Reward: ${log['reward']}', style: const TextStyle(color: Colors.white)),
//             subtitle: Text(log['timestamp'], style: const TextStyle(color: Colors.grey)),
//           )),
//           const SizedBox(height: 20),
//           const Text('Survey Logs', style: TextStyle(color: Colors.amber, fontSize: 18)),
//           ..._surveyLogs.map((log) => ListTile(
//             title: Text('Status: ${log['status']} | Reward: ${log['reward']}', style: const TextStyle(color: Colors.white)),
//             subtitle: Text(log['timestamp'], style: const TextStyle(color: Colors.grey)),
//           )),
//           ElevatedButton(
//             onPressed: () async {
//               await Supabase.instance.client.auth.signOut();
//               Navigator.pushReplacementNamed(context, '/');
//             },
//             child: const Text('Logout'),
//           ),
//         ],
//       ),
//     );
//   }
// }

// import 'package:flutter/material.dart';
// import 'package:supabase_flutter/supabase_flutter.dart';

// class ProfileScreen extends StatefulWidget {
//   const ProfileScreen({super.key});
//   @override
//   State<ProfileScreen> createState() => _ProfileScreenState();
// }

// class _ProfileScreenState extends State<ProfileScreen> {
//   String _language = 'en';
//   List<Map<String, dynamic>> _adLogs = [];
//   List<Map<String, dynamic>> _surveyLogs = [];
//   @override
//   void initState() {
//     super.initState();
//     _loadProfile();
//     _loadLogs();
//   }

//   Future<void> _loadProfile() async {
//     final userId = Supabase.instance.client.auth.currentUser?.id;
//     if (userId == null) return;
//     final data = await Supabase.instance.client
//         .from('profiles')
//         .select('language')
//         .eq('id', userId)
//         .single();
//     setState(() => _language = data['language'] ?? 'en');
//   }

//   Future<void> _loadLogs() async {
//     final userId = Supabase.instance.client.auth.currentUser?.id;
//     if (userId == null) return;
//     _adLogs = await Supabase.instance.client
//         .from('ad_events')
//         .select()
//         .eq('user_id', userId)
//         .order('timestamp', ascending: false);
//     _surveyLogs = await Supabase.instance.client
//         .from('survey_logs')
//         .select()
//         .eq('user_id', userId)
//         .order('timestamp', ascending: false);
//     setState(() {});
//   }

//   Future<void> _updateLanguage(String newLang) async {
//     final userId = Supabase.instance.client.auth.currentUser?.id;
//     if (userId == null) return;
//     await Supabase.instance.client
//         .from('profiles')
//         .update({'language': newLang})
//         .eq('id', userId);
//     setState(() => _language = newLang);
//   }

//   @override
//   Widget build(BuildContext context) {
//     return ListView(
//       padding: const EdgeInsets.all(16.0),
//       children: [
//         DropdownButton<String>(
//           value: _language,
//           items: ['en', 'ar', 'hi', 'fr']
//               .map((lang) => DropdownMenuItem(value: lang, child: Text(lang)))
//               .toList(),
//           onChanged: (val) => _updateLanguage(val!),
//           style: const TextStyle(color: Colors.white),
//         ),
//         const SizedBox(height: 20),
//         const Text(
//           'Ad Logs',
//           style: TextStyle(color: Color(0xFFFFD700), fontSize: 18),
//         ),
//         ..._adLogs.map(
//           (log) => ListTile(
//             title: Text(
//               'Status: ${log['status']} | Reward: ${log['reward']}',
//               style: const TextStyle(color: Colors.white),
//             ),
//             subtitle: Text(
//               log['timestamp'],
//               style: const TextStyle(color: Colors.grey),
//             ),
//           ),
//         ),
//         const SizedBox(height: 20),
//         const Text(
//           'Survey Logs',
//           style: TextStyle(color: Color(0xFFFFD700), fontSize: 18),
//         ),
//         ..._surveyLogs.map(
//           (log) => ListTile(
//             title: Text(
//               'Status: ${log['status']} | Reward: ${log['reward']}',
//               style: const TextStyle(color: Colors.white),
//             ),
//             subtitle: Text(
//               log['timestamp'],
//               style: const TextStyle(color: Colors.grey),
//             ),
//           ),
//         ),
//         ElevatedButton(
//           onPressed: () async {
//             await Supabase.instance.client.auth.signOut();
//             Navigator.pushReplacementNamed(context, '/');
//           },
//           style: ElevatedButton.styleFrom(
//             backgroundColor: const Color(0xFFFFD700),
//             foregroundColor: Colors.black,
//           ),
//           child: const Text('Logout'),
//         ),
//       ],
//     );
//   }
// }

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:intl/intl.dart';
import 'package:provider/provider.dart';
import 'package:regt_app/providers/app_state.dart'; // Assuming this exists from previous context

class ProfileScreen extends StatefulWidget {
  const ProfileScreen({super.key});

  @override
  State<ProfileScreen> createState() => _ProfileScreenState();
}

class _ProfileScreenState extends State<ProfileScreen> {
  String _language = 'en';
  List<Map<String, dynamic>> _adLogs = [];
  List<Map<String, dynamic>> _surveyLogs = [];
  bool _showActivityLogs = false;
  bool _notificationsEnabled = true;
  bool _emailUpdates = false;
  bool _showLanguageModal = false;
  String? _userId;
  String? _email;
  double _balance = 0.0;

  final List<Map<String, dynamic>> languages = [
    {'code': 'en', 'name': 'English', 'flag': '', 'rtl': false},
    {'code': 'ar', 'name': '', 'flag': '', 'rtl': true},
    {'code': 'hi', 'name': '', 'flag': '', 'rtl': false},
    {'code': 'fr', 'name': 'Franais', 'flag': '', 'rtl': false},
    {'code': 'es', 'name': 'Espaol', 'flag': '', 'rtl': false},
    {'code': 'zh', 'name': '', 'flag': '', 'rtl': false},
  ];

  @override
  void initState() {
    super.initState();
    _loadProfile();
    _loadLogs();
    _loadUserData();
  }

  Future<void> _loadUserData() async {
    final user = Supabase.instance.client.auth.currentUser;
    if (user != null) {
      setState(() {
        _userId = user.id;
        _email = user.email;
      });
      // Balance from provider
      _balance = Provider.of<AppState>(context, listen: false).balance;
    }
  }

  Future<void> _loadProfile() async {
    final userId = Supabase.instance.client.auth.currentUser?.id;
    if (userId == null) return;
    final data = await Supabase.instance.client
        .from('profiles')
        .select('language')
        .eq('id', userId)
        .single();
    setState(() => _language = data['language'] ?? 'en');
  }

  Future<void> _loadLogs() async {
    final userId = Supabase.instance.client.auth.currentUser?.id;
    if (userId == null) return;
    _adLogs = await Supabase.instance.client
        .from('ad_events')
        .select()
        .eq('user_id', userId)
        .order('timestamp', ascending: false);
    _surveyLogs = await Supabase.instance.client
        .from('survey_logs')
        .select()
        .eq('user_id', userId)
        .order('timestamp', ascending: false);
    setState(() {});
  }

  Future<void> _updateLanguage(String newLang) async {
    final userId = Supabase.instance.client.auth.currentUser?.id;
    if (userId == null) return;
    await Supabase.instance.client
        .from('profiles')
        .update({'language': newLang})
        .eq('id', userId);
    setState(() => _language = newLang);
    if (context.mounted) {
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(SnackBar(content: Text('Language changed to $newLang')));
    }
  }

  void _handleLanguageChange(Map<String, dynamic> language) {
    _updateLanguage(language['code']);
    setState(() {
      _showLanguageModal = false;
    });
  }

  String _formatTimeAgo(String timestampStr) {
    final date = DateTime.parse(timestampStr);
    final now = DateTime.now();
    final diff = now.difference(date);
    if (diff.inMinutes < 60) {
      return '${diff.inMinutes}m ago';
    } else if (diff.inHours < 24) {
      return '${diff.inHours}h ago';
    } else {
      return '${diff.inDays}d ago';
    }
  }

  void _handleCopyUserId() {
    if (_userId != null) {
      Clipboard.setData(ClipboardData(text: _userId!));
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('User ID copied to clipboard!')),
      );
    }
  }

  void _handleLogout() {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Logout'),
        content: const Text('Are you sure you want to logout?'),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('Cancel'),
          ),
          TextButton(
            onPressed: () async {
              await Supabase.instance.client.auth.signOut();
              if (context.mounted) {
                Navigator.pushReplacementNamed(context, '/');
              }
            },
            child: const Text('Yes'),
          ),
        ],
      ),
    );
  }

  List<Map<String, dynamic>> get _combinedLogs {
    List<Map<String, dynamic>> combined = [];
    combined.addAll(_adLogs.map((log) => {...log, 'type': 'ad'}));
    combined.addAll(_surveyLogs.map((log) => {...log, 'type': 'survey'}));
    combined.sort(
      (a, b) => DateTime.parse(
        b['timestamp'],
      ).compareTo(DateTime.parse(a['timestamp'])),
    );
    return combined.take(5).toList(); // Limit to 5 like sample
  }

  @override
  Widget build(BuildContext context) {
    final selectedLangName = languages.firstWhere(
      (lang) => lang['code'] == _language,
      orElse: () => languages[0],
    )['name'];
    return Stack(
      children: [
        ListView(
          children: [
            // Profile Header
            Container(
              padding: const EdgeInsets.all(24),
              decoration: const BoxDecoration(
                gradient: LinearGradient(
                  colors: [Color(0xff1a1a1a), Color(0xff2a2a2a)],
                  begin: Alignment.centerLeft,
                  end: Alignment.centerRight,
                ),
                border: Border(bottom: BorderSide(color: Color(0xff808080))),
              ),
              child: Column(
                children: [
                  Row(
                    children: [
                      Stack(
                        children: [
                          Container(
                            width: 80,
                            height: 80,
                            decoration: const BoxDecoration(
                              color: Color(0xffFFD700),
                              shape: BoxShape.circle,
                            ),
                            child: Center(
                              child: Text(
                                _userId?.substring(0, 1).toUpperCase() ?? 'U',
                                style: const TextStyle(
                                  color: Colors.black,
                                  fontSize: 24,
                                  fontWeight: FontWeight.bold,
                                ),
                              ),
                            ),
                          ),
                          Positioned(
                            bottom: -4,
                            right: -4,
                            child: Container(
                              width: 24,
                              height: 24,
                              decoration: BoxDecoration(
                                color: const Color(0xff2a2a2a),
                                shape: BoxShape.circle,
                                border: Border.all(
                                  color: const Color(0xff808080),
                                  width: 2,
                                ),
                              ),
                              child: const Icon(
                                Icons.edit,
                                size: 12,
                                color: Color(0xff808080),
                              ),
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(width: 16),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            const Text(
                              'Welcome back!',
                              style: TextStyle(
                                color: Colors.white,
                                fontSize: 20,
                                fontWeight: FontWeight.w600,
                              ),
                            ),
                            const SizedBox(height: 4),
                            Text(
                              _email ?? '',
                              style: const TextStyle(
                                color: Color(0xff808080),
                                fontSize: 12,
                              ),
                            ),
                            const SizedBox(height: 8),
                            Row(
                              children: [
                                Text(
                                  'ID: ${_userId ?? ''}',
                                  style: const TextStyle(
                                    color: Color(0xff808080),
                                    fontSize: 12,
                                  ),
                                ),
                                const SizedBox(width: 8),
                                IconButton(
                                  onPressed: _handleCopyUserId,
                                  icon: const Icon(
                                    Icons.copy,
                                    size: 16,
                                    color: Color(0xffFFD700),
                                  ),
                                  padding: EdgeInsets.zero,
                                  constraints: const BoxConstraints(),
                                ),
                              ],
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 16),
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceAround,
                    children: [
                      Column(
                        children: [
                          Text(
                            _balance.toStringAsFixed(2),
                            style: const TextStyle(
                              color: Color(0xffFFD700),
                              fontSize: 20,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                          const Text(
                            'REGT Balance',
                            style: TextStyle(
                              color: Color(0xff808080),
                              fontSize: 10,
                            ),
                          ),
                        ],
                      ),
                      Column(
                        children: [
                          const Text(
                            '5',
                            style: TextStyle(
                              color: Colors.greenAccent,
                              fontSize: 20,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                          const Text(
                            'Referrals',
                            style: TextStyle(
                              color: Color(0xff808080),
                              fontSize: 10,
                            ),
                          ),
                        ],
                      ),
                      Column(
                        children: [
                          const Text(
                            '28',
                            style: TextStyle(
                              color: Colors.blueAccent,
                              fontSize: 20,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                          const Text(
                            'Days Active',
                            style: TextStyle(
                              color: Color(0xff808080),
                              fontSize: 10,
                            ),
                          ),
                        ],
                      ),
                    ],
                  ),
                ],
              ),
            ),
            // Settings Sections
            Padding(
              padding: const EdgeInsets.all(16.0),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // Language Settings
                  Container(
                    decoration: BoxDecoration(
                      color: const Color(0xff1a1a1a),
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(color: const Color(0xff808080)),
                    ),
                    child: GestureDetector(
                      onTap: () => setState(() => _showLanguageModal = true),
                      child: Padding(
                        padding: const EdgeInsets.all(16.0),
                        child: Row(
                          children: [
                            const Icon(
                              Icons.language,
                              color: Color(0xffFFD700),
                              size: 20,
                            ),
                            const SizedBox(width: 12),
                            Expanded(
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  const Text(
                                    'Language',
                                    style: TextStyle(
                                      color: Colors.white,
                                      fontSize: 16,
                                      fontWeight: FontWeight.w500,
                                    ),
                                  ),
                                  const SizedBox(height: 4),
                                  Text(
                                    selectedLangName,
                                    style: const TextStyle(
                                      color: Color(0xff808080),
                                      fontSize: 14,
                                    ),
                                  ),
                                ],
                              ),
                            ),
                            const Icon(
                              Icons.chevron_right,
                              color: Color(0xff808080),
                            ),
                          ],
                        ),
                      ),
                    ),
                  ),
                  const SizedBox(height: 16),
                  // Notification Settings
                  Container(
                    decoration: BoxDecoration(
                      color: const Color(0xff1a1a1a),
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(color: const Color(0xff808080)),
                    ),
                    child: Padding(
                      padding: const EdgeInsets.all(16.0),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Row(
                            children: [
                              const Icon(
                                Icons.notifications,
                                color: Color(0xffFFD700),
                                size: 20,
                              ),
                              const SizedBox(width: 12),
                              const Text(
                                'Notifications',
                                style: TextStyle(
                                  color: Colors.white,
                                  fontSize: 16,
                                  fontWeight: FontWeight.w500,
                                ),
                              ),
                            ],
                          ),
                          const SizedBox(height: 16),
                          Row(
                            mainAxisAlignment: MainAxisAlignment.spaceBetween,
                            children: [
                              const Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Text(
                                    'Push Notifications',
                                    style: TextStyle(
                                      color: Colors.white,
                                      fontSize: 14,
                                    ),
                                  ),
                                  Text(
                                    'Receive push notifications',
                                    style: TextStyle(
                                      color: Color(0xff808080),
                                      fontSize: 12,
                                    ),
                                  ),
                                ],
                              ),
                              Switch(
                                value: _notificationsEnabled,
                                onChanged: (val) =>
                                    setState(() => _notificationsEnabled = val),
                                activeColor: const Color(0xffFFD700),
                              ),
                            ],
                          ),
                          const SizedBox(height: 16),
                          Row(
                            mainAxisAlignment: MainAxisAlignment.spaceBetween,
                            children: [
                              const Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Text(
                                    'Email Updates',
                                    style: TextStyle(
                                      color: Colors.white,
                                      fontSize: 14,
                                    ),
                                  ),
                                  Text(
                                    'Receive email notifications',
                                    style: TextStyle(
                                      color: Color(0xff808080),
                                      fontSize: 12,
                                    ),
                                  ),
                                ],
                              ),
                              Switch(
                                value: _emailUpdates,
                                onChanged: (val) =>
                                    setState(() => _emailUpdates = val),
                                activeColor: const Color(0xffFFD700),
                              ),
                            ],
                          ),
                        ],
                      ),
                    ),
                  ),
                  const SizedBox(height: 16),
                  // Security
                  Container(
                    decoration: BoxDecoration(
                      color: const Color(0xff1a1a1a),
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(color: const Color(0xff808080)),
                    ),
                    child: Padding(
                      padding: const EdgeInsets.all(16.0),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Row(
                            children: [
                              const Icon(
                                Icons.security,
                                color: Color(0xffFFD700),
                                size: 20,
                              ),
                              const SizedBox(width: 12),
                              const Text(
                                'Security',
                                style: TextStyle(
                                  color: Colors.white,
                                  fontSize: 16,
                                  fontWeight: FontWeight.w500,
                                ),
                              ),
                            ],
                          ),
                          const SizedBox(height: 12),
                          GestureDetector(
                            onTap: () {}, // Placeholder
                            child: const Padding(
                              padding: EdgeInsets.symmetric(vertical: 8.0),
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Text(
                                    'Change Password',
                                    style: TextStyle(
                                      color: Colors.white,
                                      fontSize: 14,
                                    ),
                                  ),
                                  Text(
                                    'Update your account password',
                                    style: TextStyle(
                                      color: Color(0xff808080),
                                      fontSize: 12,
                                    ),
                                  ),
                                ],
                              ),
                            ),
                          ),
                          GestureDetector(
                            onTap: () {}, // Placeholder
                            child: const Padding(
                              padding: EdgeInsets.symmetric(vertical: 8.0),
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Text(
                                    'Two-Factor Authentication',
                                    style: TextStyle(
                                      color: Colors.white,
                                      fontSize: 14,
                                    ),
                                  ),
                                  Text(
                                    'Add extra security to your account',
                                    style: TextStyle(
                                      color: Color(0xff808080),
                                      fontSize: 12,
                                    ),
                                  ),
                                ],
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                  const SizedBox(height: 16),
                  // Activity Logs
                  Container(
                    decoration: BoxDecoration(
                      color: const Color(0xff1a1a1a),
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(color: const Color(0xff808080)),
                    ),
                    child: Column(
                      children: [
                        GestureDetector(
                          onTap: () => setState(
                            () => _showActivityLogs = !_showActivityLogs,
                          ),
                          child: Padding(
                            padding: const EdgeInsets.all(16.0),
                            child: Row(
                              mainAxisAlignment: MainAxisAlignment.spaceBetween,
                              children: [
                                Row(
                                  children: [
                                    const Icon(
                                      Icons.timeline,
                                      color: Color(0xffFFD700),
                                      size: 20,
                                    ),
                                    const SizedBox(width: 12),
                                    const Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        Text(
                                          'Activity Logs',
                                          style: TextStyle(
                                            color: Colors.white,
                                            fontSize: 16,
                                            fontWeight: FontWeight.w500,
                                          ),
                                        ),
                                        Text(
                                          'View your recent activity',
                                          style: TextStyle(
                                            color: Color(0xff808080),
                                            fontSize: 14,
                                          ),
                                        ),
                                      ],
                                    ),
                                  ],
                                ),
                                Icon(
                                  _showActivityLogs
                                      ? Icons.expand_less
                                      : Icons.expand_more,
                                  color: const Color(0xff808080),
                                ),
                              ],
                            ),
                          ),
                        ),
                        if (_showActivityLogs)
                          Container(
                            decoration: const BoxDecoration(
                              border: Border(
                                top: BorderSide(color: Color(0xff808080)),
                              ),
                            ),
                            constraints: const BoxConstraints(maxHeight: 256),
                            child: ListView.builder(
                              shrinkWrap: true,
                              itemCount: _combinedLogs.length,
                              itemBuilder: (context, index) {
                                final log = _combinedLogs[index];
                                final action = log['type'] == 'ad'
                                    ? 'Ad Watched'
                                    : 'Survey Completed';
                                final details =
                                    'Status: ${log['status']} | Reward: ${log['reward']}';
                                final timeAgo = _formatTimeAgo(
                                  log['timestamp'],
                                );
                                return Container(
                                  padding: const EdgeInsets.all(16),
                                  decoration: BoxDecoration(
                                    border: Border(
                                      bottom: BorderSide(
                                        color: const Color(0xff808080),
                                      ),
                                    ),
                                  ),
                                  child: Row(
                                    mainAxisAlignment:
                                        MainAxisAlignment.spaceBetween,
                                    children: [
                                      Expanded(
                                        child: Column(
                                          crossAxisAlignment:
                                              CrossAxisAlignment.start,
                                          children: [
                                            Text(
                                              action,
                                              style: const TextStyle(
                                                color: Colors.white,
                                                fontSize: 14,
                                                fontWeight: FontWeight.w500,
                                              ),
                                            ),
                                            const SizedBox(height: 4),
                                            Text(
                                              details,
                                              style: const TextStyle(
                                                color: Color(0xff808080),
                                                fontSize: 12,
                                              ),
                                            ),
                                          ],
                                        ),
                                      ),
                                      Text(
                                        timeAgo,
                                        style: const TextStyle(
                                          color: Color(0xff808080),
                                          fontSize: 12,
                                        ),
                                      ),
                                    ],
                                  ),
                                );
                              },
                            ),
                          ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 16),
                  // Support
                  // Container(
                  //   decoration: BoxDecoration(
                  //     color: const Color(0xff1a1a1a),
                  //     borderRadius: BorderRadius.circular(12),
                  //     border: Border.all(color: const Color(0xff808080)),
                  //   ),
                  //   child: Padding(
                  //     padding: const EdgeInsets.all(16.0),
                  //     child: Column(
                  //       crossAxisAlignment: CrossAxisAlignment.start,
                  //       children: [
                  //         const Text('Support', style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.w500)),
                  //         const SizedBox(height: 12),
                  //         GestureDetector(
                  //           onTap: () {}, // Placeholder
                  //           child: const Padding(
                  //             padding: EdgeInsets.symmetric(vertical: 8.0),
                  //             child: Column(
                  //               crossAxisAlignment: CrossAxisAlignment.start,
                  //               children: [
                  //                 Text('Help Center', style: TextStyle(color: Colors.white, fontSize: 14)),
                  //                 Text('Get answers to common questions', style: TextStyle(color: Color(0xff808080), fontSize: 12)),
                  //               ],
                  //             ),
                  //           ),
                  //         ),
                  //         GestureDetector(
                  //           onTap: () {}, // Placeholder
                  //           child: const Padding(
                  //             padding: EdgeInsets.symmetric(vertical: 8.0),
                  //             child: Column(
                  //               crossAxisAlignment: CrossAxisAlignment.start,
                  //               children: [
                  //                 Text('Contact Support', style: TextStyle(color: Colors.white, fontSize: 14)),
                  //                 Text('Get help from our team', style: TextStyle(color: Color(0xff808080), fontSize: 12)),
                  //               ],
                  //             ),
                  //           ),
                  //         ),
                  //         GestureDetector(
                  //           onTap: () {}, // Placeholder
                  //           child: const Padding(
                  //             padding: EdgeInsets.symmetric(vertical: 8.0),
                  //             child: Column(
                  //               crossAxisAlignment: CrossAxisAlignment.start,
                  //               children: [
                  //                 Text('Terms of Service', style: TextStyle(color: Colors.white, fontSize: 14)),
                  //                 Text('Read our terms and conditions', style: TextStyle(color: Color(0xff808080), fontSize: 12)),
                  //               ],
                  //             ),
                  //           ),
                  //         ),
                  //       ],
                  //     ),
                  //   ),
                  // ),
                  Container(
                    decoration: BoxDecoration(
                      color: const Color(0xff1a1a1a),
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(color: const Color(0xff808080)),
                    ),
                    child: Padding(
                      padding: const EdgeInsets.all(16.0),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          const Text(
                            'Support',
                            style: TextStyle(
                              color: Colors.white,
                              fontSize: 16,
                              fontWeight: FontWeight.w500,
                            ),
                          ),
                          const SizedBox(height: 12),
                          GestureDetector(
                            onTap: () {}, // Placeholder
                            child: Row(
                              mainAxisAlignment: MainAxisAlignment.spaceBetween,
                              children: [
                                const Column(
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  children: [
                                    Text(
                                      'Help Center',
                                      style: TextStyle(
                                        color: Colors.white,
                                        fontSize: 14,
                                      ),
                                    ),
                                    Text(
                                      'Get answers to common questions',
                                      style: TextStyle(
                                        color: Color(0xff808080),
                                        fontSize: 12,
                                      ),
                                    ),
                                  ],
                                ),
                                const Icon(
                                  Icons.chevron_right,
                                  color: Color(0xff808080),
                                ),
                              ],
                            ),
                          ),
                          const SizedBox(height: 16),
                          GestureDetector(
                            onTap: () {}, // Placeholder
                            child: Row(
                              mainAxisAlignment: MainAxisAlignment.spaceBetween,
                              children: [
                                const Column(
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  children: [
                                    Text(
                                      'Contact Support',
                                      style: TextStyle(
                                        color: Colors.white,
                                        fontSize: 14,
                                      ),
                                    ),
                                    Text(
                                      'Get help from our team',
                                      style: TextStyle(
                                        color: Color(0xff808080),
                                        fontSize: 12,
                                      ),
                                    ),
                                  ],
                                ),
                                const Icon(
                                  Icons.chevron_right,
                                  color: Color(0xff808080),
                                ),
                              ],
                            ),
                          ),
                          const SizedBox(height: 16),
                          GestureDetector(
                            onTap: () {}, // Placeholder
                            child: Row(
                              mainAxisAlignment: MainAxisAlignment.spaceBetween,
                              children: [
                                const Column(
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  children: [
                                    Text(
                                      'Terms of Service',
                                      style: TextStyle(
                                        color: Colors.white,
                                        fontSize: 14,
                                      ),
                                    ),
                                    Text(
                                      'Read our terms and conditions',
                                      style: TextStyle(
                                        color: Color(0xff808080),
                                        fontSize: 12,
                                      ),
                                    ),
                                  ],
                                ),
                                const Icon(
                                  Icons.chevron_right,
                                  color: Color(0xff808080),
                                ),
                              ],
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                  const SizedBox(height: 16),
                  // Logout
                  ElevatedButton(
                    onPressed: _handleLogout,
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.red[600],
                      minimumSize: const Size(double.infinity, 48),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(8),
                      ),
                    ),
                    child: const Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(Icons.logout, size: 16),
                        SizedBox(width: 8),
                        Text('Logout'),
                      ],
                    ),
                  ),
                  const SizedBox(height: 80), // For bottom nav
                ],
              ),
            ),
          ],
        ),
        if (_showLanguageModal)
          Center(
            child: Container(
              color: Colors.black.withOpacity(0.8),
              child: Center(
                child: Container(
                  constraints: const BoxConstraints(maxWidth: 300),
                  decoration: BoxDecoration(
                    color: const Color(0xff1a1a1a),
                    borderRadius: BorderRadius.circular(12),
                    border: Border.all(
                      color: const Color(0xffFFD700).withOpacity(0.2),
                    ),
                  ),
                  child: Column(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      const Padding(
                        padding: EdgeInsets.all(16.0),
                        child: Text(
                          'Select Language',
                          style: TextStyle(
                            color: Colors.white,
                            fontSize: 18,
                            fontWeight: FontWeight.w600,
                          ),
                        ),
                      ),
                      const Divider(color: Color(0xff808080)),
                      Flexible(
                        child: ListView.builder(
                          shrinkWrap: true,
                          itemCount: languages.length,
                          itemBuilder: (context, index) {
                            final language = languages[index];
                            final isSelected = _language == language['code'];
                            return GestureDetector(
                              onTap: () => _handleLanguageChange(language),
                              child: Container(
                                padding: const EdgeInsets.all(16),
                                decoration: BoxDecoration(
                                  color: isSelected
                                      ? const Color(0xffFFD700).withOpacity(0.1)
                                      : Colors.transparent,
                                  border: isSelected
                                      ? const Border(
                                          right: BorderSide(
                                            color: Color(0xffFFD700),
                                            width: 2,
                                          ),
                                        )
                                      : null,
                                ),
                                child: Row(
                                  children: [
                                    Text(
                                      language['flag'],
                                      style: const TextStyle(fontSize: 24),
                                    ),
                                    const SizedBox(width: 12),
                                    Expanded(
                                      child: Column(
                                        crossAxisAlignment:
                                            CrossAxisAlignment.start,
                                        children: [
                                          Text(
                                            language['name'],
                                            style: const TextStyle(
                                              color: Colors.white,
                                              fontSize: 16,
                                              fontWeight: FontWeight.w500,
                                            ),
                                          ),
                                          if (language['rtl'])
                                            const Text(
                                              'RTL Support',
                                              style: TextStyle(
                                                color: Color(0xff808080),
                                                fontSize: 10,
                                              ),
                                            ),
                                        ],
                                      ),
                                    ),
                                    if (isSelected)
                                      Container(
                                        width: 8,
                                        height: 8,
                                        decoration: const BoxDecoration(
                                          color: Color(0xffFFD700),
                                          shape: BoxShape.circle,
                                        ),
                                      ),
                                  ],
                                ),
                              ),
                            );
                          },
                        ),
                      ),
                      const Divider(color: Color(0xff808080)),
                      TextButton(
                        onPressed: () =>
                            setState(() => _showLanguageModal = false),
                        child: const Text(
                          'Cancel',
                          style: TextStyle(color: Color(0xff808080)),
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ),
          ),
      ],
    );
  }
}


// File: c:\Users\Youssef\Documents\flutter_apps\regt_app\lib\screens\referrals_screen.dart
// import 'package:flutter/material.dart';
// import 'package:share_plus/share_plus.dart';
// import 'package:supabase_flutter/supabase_flutter.dart';

// class ReferralsScreen extends StatefulWidget {
//   const ReferralsScreen({super.key});

//   @override
//   State<ReferralsScreen> createState() => _ReferralsScreenState();
// }

// class _ReferralsScreenState extends State<ReferralsScreen> {
//   String _referralLink = '';
//   List<Map<String, dynamic>> _team = [];

//   @override
//   void initState() {
//     super.initState();
//     _generateReferralLink();
//     _loadTeam();
//   }

//   void _generateReferralLink() {
//     final userId = Supabase.instance.client.auth.currentUser?.id;
//     _referralLink = 'https://yourapp.com/refer?ref=$userId';  // Set up deep linking in app
//   }

//   Future<void> _loadTeam() async {
//     final userId = Supabase.instance.client.auth.currentUser?.id;
//     if (userId == null) return;

//     final data = await Supabase.instance.client.from('referrals').select('*, profiles!referred_id (username, country)').eq('referrer_id', userId);
//     setState(() => _team = data);
//   }

//   @override
//   Widget build(BuildContext context) {
//     return Scaffold(
//       backgroundColor: Colors.black,
//       appBar: AppBar(title: const Text('Referrals')),
//       body: Column(
//         children: [
//           ElevatedButton(
//             onPressed: () => Share.share(_referralLink),
//             child: const Text('Share Referral Link'),
//           ),
//           Expanded(
//             child: ListView.builder(
//               itemCount: _team.length,
//               itemBuilder: (context, index) {
//                 final member = _team[index];
//                 return ListTile(
//                   title: Text(member['profiles']['username'] ?? 'Unknown', style: const TextStyle(color: Colors.white)),
//                   subtitle: Text('Status: ${member['active_status'] ? 'Active' : 'Inactive'}', style: const TextStyle(color: Colors.grey)),
//                 );
//               },
//             ),
//           ),
//         ],
//       ),
//     );
//   }
// }










// import 'package:flutter/material.dart';
// import 'package:share_plus/share_plus.dart';
// import 'package:supabase_flutter/supabase_flutter.dart';
// import 'package:flutter/services.dart';
// import 'package:url_launcher/url_launcher.dart';
// import 'package:intl/intl.dart';

// class ReferralStats {
//   int totalReferrals;
//   int activeReferrals;
//   double totalCommissions;
//   double thisMonthCommissions;

//   ReferralStats({
//     required this.totalReferrals,
//     required this.activeReferrals,
//     required this.totalCommissions,
//     required this.thisMonthCommissions,
//   });
// }

// class ReferralsScreen extends StatefulWidget {
//   const ReferralsScreen({super.key});

//   @override
//   State<ReferralsScreen> createState() => _ReferralsScreenState();
// }

// class _ReferralsScreenState extends State<ReferralsScreen> {
//   String _referralLink = '';
//   List<Map<String, dynamic>> _team = [];
//   ReferralStats _stats = ReferralStats(totalReferrals: 0, activeReferrals: 0, totalCommissions: 0, thisMonthCommissions: 0);
//   String? _expandedMember;

//   @override
//   void initState() {
//     super.initState();
//     _generateReferralLink();
//     _loadTeam();
//   }

//   void _generateReferralLink() {
//     final userId = Supabase.instance.client.auth.currentUser?.id ?? '';
//     final referralCode = 'REGT${userId.toUpperCase()}';
//     _referralLink = 'https://regtai.com/join?ref=$referralCode';
//   }

//   Future<void> _loadTeam() async {
//     final userId = Supabase.instance.client.auth.currentUser?.id;
//     if (userId == null) return;

//     final data = await Supabase.instance.client.from('referrals').select('*, profiles!referred_id (username, country)').eq('referrer_id', userId);

//     double totalComm = 0;
//     double monthComm = 0;
//     int active = 0;
//     DateTime now = DateTime.now();

//     for (var m in data) {
//       bool isActive = m['active_status'] as bool? ?? false;
//       if (isActive) active++;
//       double comm = (m['commission'] as num? ?? 0).toDouble();
//       totalComm += comm;
//       if (m['created_at'] != null) {
//         DateTime join = DateTime.parse(m['created_at']);
//         if (join.month == now.month && join.year == now.year) {
//           monthComm += comm;
//         }
//       }
//     }

//     setState(() {
//       _team = data;
//       _stats = ReferralStats(
//         totalReferrals: data.length,
//         activeReferrals: active,
//         totalCommissions: totalComm,
//         thisMonthCommissions: monthComm,
//       );
//     });
//   }

//   void _showShareModal() {
//     showDialog(
//       context: context,
//       builder: (BuildContext context) {
//         return AlertDialog(
//           backgroundColor: const Color(0xff1a1a1a),
//           shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
//           title: const Center(child: Text('Share Your Link', style: TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w600))),
//           content: Column(
//             mainAxisSize: MainAxisSize.min,
//             children: [
//               ElevatedButton(
//                 onPressed: () {
//                   launchUrl(Uri.parse('https://wa.me/?text=${Uri.encodeComponent('Join REGT Token Earning Platform: $_referralLink')}'));
//                   Navigator.of(context).pop();
//                 },
//                 style: ElevatedButton.styleFrom(
//                   backgroundColor: Colors.green[600],
//                   minimumSize: const Size(double.infinity, 48),
//                   shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
//                 ),
//                 child: const Row(
//                   mainAxisAlignment: MainAxisAlignment.center,
//                   children: [
//                     Icon(Icons.link, color: Colors.white),
//                     SizedBox(width: 8),
//                     Text('WhatsApp', style: TextStyle(color: Colors.white)),
//                   ],
//                 ),
//               ),
//               const SizedBox(height: 8),
//               ElevatedButton(
//                 onPressed: () {
//                   launchUrl(Uri.parse('https://t.me/share/url?url=${Uri.encodeComponent(_referralLink)}&text=${Uri.encodeComponent('Join REGT Token Earning Platform')}'));
//                   Navigator.of(context).pop();
//                 },
//                 style: ElevatedButton.styleFrom(
//                   backgroundColor: Colors.blue[600],
//                   minimumSize: const Size(double.infinity, 48),
//                   shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
//                 ),
//                 child: const Row(
//                   mainAxisAlignment: MainAxisAlignment.center,
//                   children: [
//                     Icon(Icons.link, color: Colors.white),
//                     SizedBox(width: 8),
//                     Text('Telegram', style: TextStyle(color: Colors.white)),
//                   ],
//                 ),
//               ),
//               const SizedBox(height: 8),
//               ElevatedButton(
//                 onPressed: () {
//                   launchUrl(Uri.parse('mailto:?subject=Join REGT Token Earning Platform&body=${Uri.encodeComponent(_referralLink)}'));
//                   Navigator.of(context).pop();
//                 },
//                 style: ElevatedButton.styleFrom(
//                   backgroundColor: Colors.grey[600],
//                   minimumSize: const Size(double.infinity, 48),
//                   shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
//                 ),
//                 child: const Row(
//                   mainAxisAlignment: MainAxisAlignment.center,
//                   children: [
//                     Icon(Icons.link, color: Colors.white),
//                     SizedBox(width: 8),
//                     Text('Email', style: TextStyle(color: Colors.white)),
//                   ],
//                 ),
//               ),
//             ],
//           ),
//           actions: [
//             TextButton(
//               onPressed: () => Navigator.of(context).pop(),
//               child: const Text('Close', style: TextStyle(color: Colors.grey)),
//             ),
//           ],
//         );
//       },
//     );
//   }

//   @override
//   Widget build(BuildContext context) {
//     return Scaffold(
//       backgroundColor: Colors.black,
//       body: ListView(
//         children: [
//           Container(
//             padding: const EdgeInsets.all(16),
//             decoration: const BoxDecoration(
//               color: Color(0xff1a1a1a),
//               border: Border(bottom: BorderSide(color: Color(0xff808080))),
//             ),
//             child: Column(
//               crossAxisAlignment: CrossAxisAlignment.start,
//               children: [
//                 const Text('Referral Program', style: TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w600)),
//                 const SizedBox(height: 16),
//                 Row(
//                   children: [
//                     Expanded(
//                       child: Container(
//                         decoration: BoxDecoration(color: const Color(0xff2a2a2a), borderRadius: BorderRadius.circular(8)),
//                         padding: const EdgeInsets.all(12),
//                         child: Column(
//                           children: [
//                             Text(_stats.totalReferrals.toString(), style: const TextStyle(color: Color(0xffFFD700), fontSize: 20, fontWeight: FontWeight.bold)),
//                             const Text('Total Referrals', style: TextStyle(color: Color(0xff808080), fontSize: 12)),
//                           ],
//                         ),
//                       ),
//                     ),
//                     const SizedBox(width: 12),
//                     Expanded(
//                       child: Container(
//                         decoration: BoxDecoration(color: const Color(0xff2a2a2a), borderRadius: BorderRadius.circular(8)),
//                         padding: const EdgeInsets.all(12),
//                         child: Column(
//                           children: [
//                             Text(_stats.activeReferrals.toString(), style: TextStyle(color: Colors.green[400], fontSize: 20, fontWeight: FontWeight.bold)),
//                             const Text('Active Members', style: TextStyle(color: Color(0xff808080), fontSize: 12)),
//                           ],
//                         ),
//                       ),
//                     ),
//                   ],
//                 ),
//               ],
//             ),
//           ),
//           Padding(
//             padding: const EdgeInsets.all(16),
//             child: Container(
//               padding: const EdgeInsets.all(16),
//               decoration: BoxDecoration(
//                 gradient: const LinearGradient(begin: Alignment.centerLeft, end: Alignment.centerRight, colors: [Color(0xff1a1a1a), Color(0xff2a2a2a)]),
//                 borderRadius: BorderRadius.circular(12),
//                 border: Border.all(color: const Color(0xffFFD700).withOpacity(0.2)),
//               ),
//               child: Column(
//                 crossAxisAlignment: CrossAxisAlignment.start,
//                 children: [
//                   const Row(
//                     children: [
//                       Icon(Icons.share, color: Color(0xffFFD700), size: 20),
//                       SizedBox(width: 8),
//                       Text('Your Referral Link', style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.w600)),
//                     ],
//                   ),
//                   const SizedBox(height: 12),
//                   Container(
//                     width: double.infinity,
//                     padding: const EdgeInsets.all(12),
//                     decoration: BoxDecoration(color: const Color(0xff0a0a0a), borderRadius: BorderRadius.circular(8)),
//                     child: Text(_referralLink, style: const TextStyle(color: Color(0xffFFD700), fontFamily: 'Courier', fontSize: 12), softWrap: true),
//                   ),
//                   const SizedBox(height: 16),
//                   Row(
//                     children: [
//                       Expanded(
//                         child: ElevatedButton(
//                           onPressed: () async {
//                             await Clipboard.setData(ClipboardData(text: _referralLink));
//                             if (context.mounted) {
//                               ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Referral link copied to clipboard!')));
//                             }
//                           },
//                           style: ElevatedButton.styleFrom(
//                             backgroundColor: const Color(0xff2a2a2a),
//                             side: const BorderSide(color: Color(0xff808080)),
//                             shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
//                           ),
//                           child: const Row(
//                             mainAxisAlignment: MainAxisAlignment.center,
//                             children: [
//                               Icon(Icons.copy, color: Colors.white, size: 16),
//                               SizedBox(width: 8),
//                               Text('Copy Link', style: TextStyle(color: Colors.white)),
//                             ],
//                           ),
//                         ),
//                       ),
//                       const SizedBox(width: 8),
//                       Expanded(
//                         child: ElevatedButton(
//                           onPressed: _showShareModal,
//                           style: ElevatedButton.styleFrom(
//                             backgroundColor: const Color(0xffFFD700),
//                             shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
//                           ),
//                           child: const Row(
//                             mainAxisAlignment: MainAxisAlignment.center,
//                             children: [
//                               Icon(Icons.share, color: Colors.black, size: 16),
//                               SizedBox(width: 8),
//                               Text('Share', style: TextStyle(color: Colors.black)),
//                             ],
//                           ),
//                         ),
//                       ),
//                     ],
//                   ),
//                 ],
//               ),
//             ),
//           ),
//           Padding(
//             padding: const EdgeInsets.symmetric(horizontal: 16),
//             child: Container(
//               padding: const EdgeInsets.all(16),
//               decoration: BoxDecoration(
//                 color: const Color(0xff1a1a1a),
//                 borderRadius: BorderRadius.circular(12),
//                 border: Border.all(color: const Color(0xff808080)),
//               ),
//               child: Column(
//                 crossAxisAlignment: CrossAxisAlignment.start,
//                 children: [
//                   Row(
//                     mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                     children: [
//                       const Row(
//                         children: [
//                           Icon(Icons.card_giftcard, color: Color(0xffFFD700), size: 20),
//                           SizedBox(width: 8),
//                           Text('Commission Earnings', style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.w600)),
//                         ],
//                       ),
//                       Icon(Icons.trending_up, color: Colors.green[400], size: 20),
//                     ],
//                   ),
//                   const SizedBox(height: 12),
//                   Row(
//                     children: [
//                       Expanded(
//                         child: Column(
//                           crossAxisAlignment: CrossAxisAlignment.start,
//                           children: [
//                             Text('${_stats.totalCommissions.toStringAsFixed(2)} REGT', style: const TextStyle(color: Color(0xffFFD700), fontSize: 24, fontWeight: FontWeight.bold)),
//                             const Text('Total Earned', style: TextStyle(color: Color(0xff808080), fontSize: 12)),
//                           ],
//                         ),
//                       ),
//                       Expanded(
//                         child: Column(
//                           crossAxisAlignment: CrossAxisAlignment.start,
//                           children: [
//                             Text('${_stats.thisMonthCommissions.toStringAsFixed(2)} REGT', style: TextStyle(color: Colors.green[400], fontSize: 20, fontWeight: FontWeight.bold)),
//                             const Text('This Month', style: TextStyle(color: Color(0xff808080), fontSize: 12)),
//                           ],
//                         ),
//                       ),
//                     ],
//                   ),
//                 ],
//               ),
//             ),
//           ),
//           Padding(
//             padding: const EdgeInsets.all(16),
//             child: Container(
//               padding: const EdgeInsets.all(16),
//               decoration: BoxDecoration(
//                 gradient: LinearGradient(colors: [Colors.blue[600]!.withOpacity(0.1), Colors.purple[600]!.withOpacity(0.1)]),
//                 border: Border.all(color: Colors.blue[600]!.withOpacity(0.2)),
//                 borderRadius: BorderRadius.circular(12),
//               ),
//               child: const Column(
//                 crossAxisAlignment: CrossAxisAlignment.start,
//                 children: [
//                   Row(
//                     children: [
//                       Icon(Icons.check_circle, color: Colors.blueAccent, size: 20),
//                       SizedBox(width: 8),
//                       Text('How It Works', style: TextStyle(color: Colors.blueAccent, fontSize: 16, fontWeight: FontWeight.w100)),
//                     ],
//                   ),
//                   SizedBox(height: 8),
//                   Text(' Earn 10% commission on referral earnings', style: TextStyle(color: Colors.grey, fontSize: 12)),
//                   Text(' Get bonus rewards for active referrals', style: TextStyle(color: Colors.grey, fontSize: 12)),
//                   Text(' Track performance in real-time', style: TextStyle(color: Colors.grey, fontSize: 12)),
//                   Text(' Instant payouts to your balance', style: TextStyle(color: Colors.grey, fontSize: 12)),
//                 ],
//               ),
//             ),
//           ),
//           Padding(
//             padding: const EdgeInsets.symmetric(horizontal: 16),
//             child: Row(
//               children: [
//                 const Icon(Icons.people, color: Color(0xffFFD700), size: 20),
//                 const SizedBox(width: 8),
//                 Text('Your Team (${_team.length})', style: const TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.w600)),
//               ],
//             ),
//           ),
//           const SizedBox(height: 8),
//           ..._team.map((member) {
//             String id = member['id'].toString();
//             bool isExpanded = _expandedMember == id;
//             String name = member['profiles']['username'] ?? 'Unknown';
//             String subtitle = member['profiles']['country'] ?? '';
//             bool status = member['active_status'] as bool? ?? false;
//             double commission = (member['commission'] as num? ?? 0).toDouble();
//             double earnings = (member['earnings'] as num? ?? 0).toDouble();
//             int level = member['level'] as int? ?? 1;
//             DateTime? joinDate;
//             if (member['created_at'] != null) {
//               joinDate = DateTime.parse(member['created_at']);
//             }

//             return Padding(
//               padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),
//               child: GestureDetector(
//                 onTap: () {
//                   setState(() {
//                     _expandedMember = isExpanded ? null : id;
//                   });
//                 },
//                 child: Container(
//                   padding: const EdgeInsets.all(16),
//                   decoration: BoxDecoration(
//                     color: const Color(0xff1a1a1a),
//                     borderRadius: BorderRadius.circular(12),
//                     border: Border.all(color: isExpanded ? const Color(0xffFFD700).withOpacity(0.5) : const Color(0xff808080)),
//                   ),
//                   child: Column(
//                     children: [
//                       Row(
//                         mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                         children: [
//                           Row(
//                             children: [
//                               Container(
//                                 width: 40,
//                                 height: 40,
//                                 decoration: const BoxDecoration(
//                                   color: Color(0xffFFD700),
//                                   shape: BoxShape.circle,
//                                 ),
//                                 child: Center(
//                                   child: Text(
//                                     name.split(' ').map((n) => n[0]).join().toUpperCase(),
//                                     style: const TextStyle(color: Colors.black, fontSize: 12, fontWeight: FontWeight.bold),
//                                   ),
//                                 ),
//                               ),
//                               const SizedBox(width: 12),
//                               Column(
//                                 crossAxisAlignment: CrossAxisAlignment.start,
//                                 children: [
//                                   Text(name, style: const TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.w100)),
//                                   Text(subtitle, style: const TextStyle(color: Colors.grey, fontSize: 12)),
//                                   Row(
//                                     children: [
//                                       Container(
//                                         width: 8,
//                                         height: 8,
//                                         decoration: BoxDecoration(
//                                           color: status ? Colors.green[400] : Colors.red[400],
//                                           shape: BoxShape.circle,
//                                         ),
//                                       ),
//                                       const SizedBox(width: 4),
//                                       Text(
//                                         status ? 'active' : 'inactive',
//                                         style: TextStyle(color: status ? Colors.green[400] : Colors.red[400], fontSize: 12),
//                                       ),
//                                     ],
//                                   ),
//                                 ],
//                               ),
//                             ],
//                           ),
//                           Column(
//                             crossAxisAlignment: CrossAxisAlignment.end,
//                             children: [
//                               Text('+${commission.toStringAsFixed(2)} REGT', style: const TextStyle(color: Color(0xffFFD700), fontSize: 14, fontWeight: FontWeight.w600)),
//                               const Text('Commission', style: TextStyle(color: Colors.grey, fontSize: 12)),
//                             ],
//                           ),
//                         ],
//                       ),
//                       if (isExpanded && joinDate != null)
//                         Column(
//                           children: [
//                             const SizedBox(height: 16),
//                             const Divider(color: Colors.grey),
//                             const SizedBox(height: 16),
//                             Row(
//                               mainAxisAlignment: MainAxisAlignment.spaceAround,
//                               children: [
//                                 Column(
//                                   crossAxisAlignment: CrossAxisAlignment.start,
//                                   children: [
//                                     const Text('Joined:', style: TextStyle(color: Colors.grey, fontSize: 12)),
//                                     Text(DateFormat('MMM d, yyyy').format(joinDate), style: const TextStyle(color: Colors.white, fontSize: 12)),
//                                   ],
//                                 ),
//                                 Column(
//                                   crossAxisAlignment: CrossAxisAlignment.start,
//                                   children: [
//                                     const Text('Level:', style: TextStyle(color: Colors.grey, fontSize: 12)),
//                                     Text(level.toString(), style: const TextStyle(color: Colors.white, fontSize: 12)),
//                                   ],
//                                 ),
//                               ],
//                             ),
//                             const SizedBox(height: 8),
//                             Row(
//                               mainAxisAlignment: MainAxisAlignment.spaceAround,
//                               children: [
//                                 Column(
//                                   crossAxisAlignment: CrossAxisAlignment.start,
//                                   children: [
//                                     const Text('Their Earnings:', style: TextStyle(color: Colors.grey, fontSize: 12)),
//                                     Text('${earnings.toStringAsFixed(2)} REGT', style: const TextStyle(color: Colors.white, fontSize: 12)),
//                                   ],
//                                 ),
//                                 Column(
//                                   crossAxisAlignment: CrossAxisAlignment.start,
//                                   children: [
//                                     const Text('Your Commission:', style: TextStyle(color: Colors.grey, fontSize: 12)),
//                                     Text('${commission.toStringAsFixed(2)} REGT', style: const TextStyle(color: Color(0xffFFD700), fontSize: 12)),
//                                   ],
//                                 ),
//                               ],
//                             ),
//                           ],
//                         ),
//                     ],
//                   ),
//                 ),
//               ),
//             );
//           }),
//           const SizedBox(height: 16),
//         ],
//       ),
//     );
//   }
// }




import 'package:flutter/material.dart';
import 'package:share_plus/share_plus.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:flutter/services.dart';
import 'package:url_launcher/url_launcher.dart';
import 'package:intl/intl.dart';

class ReferralStats {
  int totalReferrals;
  int activeReferrals;
  double totalCommissions;
  double thisMonthCommissions;

  ReferralStats({
    required this.totalReferrals,
    required this.activeReferrals,
    required this.totalCommissions,
    required this.thisMonthCommissions,
  });
}

class ReferralsScreen extends StatefulWidget {
  const ReferralsScreen({super.key});

  @override
  State<ReferralsScreen> createState() => _ReferralsScreenState();
}

class _ReferralsScreenState extends State<ReferralsScreen> {
  String _referralLink = '';
  List<Map<String, dynamic>> _team = [];
  ReferralStats _stats = ReferralStats(totalReferrals: 0, activeReferrals: 0, totalCommissions: 0, thisMonthCommissions: 0);
  String? _expandedMember;

  @override
  void initState() {
    super.initState();
    _generateReferralLink();
    _loadTeam();
  }

  void _generateReferralLink() {
    final userId = Supabase.instance.client.auth.currentUser?.id ?? '';
    final referralCode = 'REGT${userId.toUpperCase()}';
    _referralLink = 'https://regtai.com/join?ref=$referralCode';
  }

  Future<void> _loadTeam() async {
    final userId = Supabase.instance.client.auth.currentUser?.id;
    if (userId == null) return;

    final data = await Supabase.instance.client.from('referrals').select('*, profiles!referred_id (username, country)').eq('referrer_id', userId);

    double totalComm = 0;
    double monthComm = 0;
    int active = 0;
    DateTime now = DateTime.now();

    for (var m in data) {
      bool isActive = m['active_status'] as bool? ?? false;
      if (isActive) active++;
      double comm = (m['commission'] as num? ?? 0).toDouble();
      totalComm += comm;
      if (m['created_at'] != null) {
        DateTime join = DateTime.parse(m['created_at']);
        if (join.month == now.month && join.year == now.year) {
          monthComm += comm;
        }
      }
    }

    setState(() {
      _team = data;
      _stats = ReferralStats(
        totalReferrals: data.length,
        activeReferrals: active,
        totalCommissions: totalComm,
        thisMonthCommissions: monthComm,
      );
    });
  }

  void _showShareModal() {
    showDialog(
      context: context,
      builder: (BuildContext context) {
        return AlertDialog(
          backgroundColor: const Color(0xff1a1a1a),
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
          title: const Center(child: Text('Share Your Link', style: TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w600))),
          content: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              ElevatedButton(
                onPressed: () {
                  launchUrl(Uri.parse('https://wa.me/?text=${Uri.encodeComponent('Join REGT Token Earning Platform: $_referralLink')}'));
                  Navigator.of(context).pop();
                },
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.green[600],
                  minimumSize: const Size(double.infinity, 48),
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                ),
                child: const Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    Icon(Icons.link, color: Colors.white),
                    SizedBox(width: 8),
                    Text('WhatsApp', style: TextStyle(color: Colors.white)),
                  ],
                ),
              ),
              const SizedBox(height: 8),
              ElevatedButton(
                onPressed: () {
                  launchUrl(Uri.parse('https://t.me/share/url?url=${Uri.encodeComponent(_referralLink)}&text=${Uri.encodeComponent('Join REGT Token Earning Platform')}'));
                  Navigator.of(context).pop();
                },
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.blue[600],
                  minimumSize: const Size(double.infinity, 48),
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                ),
                child: const Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    Icon(Icons.link, color: Colors.white),
                    SizedBox(width: 8),
                    Text('Telegram', style: TextStyle(color: Colors.white)),
                  ],
                ),
              ),
              const SizedBox(height: 8),
              ElevatedButton(
                onPressed: () {
                  launchUrl(Uri.parse('mailto:?subject=Join REGT Token Earning Platform&body=${Uri.encodeComponent(_referralLink)}'));
                  Navigator.of(context).pop();
                },
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.grey[600],
                  minimumSize: const Size(double.infinity, 48),
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                ),
                child: const Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    Icon(Icons.link, color: Colors.white),
                    SizedBox(width: 8),
                    Text('Email', style: TextStyle(color: Colors.white)),
                  ],
                ),
              ),
            ],
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.of(context).pop(),
              child: const Text('Close', style: TextStyle(color: Colors.grey)),
            ),
          ],
        );
      },
    );
  }

  @override
  Widget build(BuildContext context) {
    return ListView(
      children: [
        Container(
          padding: const EdgeInsets.all(16),
          decoration: const BoxDecoration(
            color: Color(0xff1a1a1a),
            border: Border(bottom: BorderSide(color: Color(0xff808080))),
          ),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text('Referral Program', style: TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w600)),
              const SizedBox(height: 16),
              Row(
                children: [
                  Expanded(
                    child: Container(
                      decoration: BoxDecoration(color: const Color(0xff2a2a2a), borderRadius: BorderRadius.circular(8)),
                      padding: const EdgeInsets.all(12),
                      child: Column(
                        children: [
                          Text(_stats.totalReferrals.toString(), style: const TextStyle(color: Color(0xffFFD700), fontSize: 20, fontWeight: FontWeight.bold)),
                          const Text('Total Referrals', style: TextStyle(color: Color(0xff808080), fontSize: 12)),
                        ],
                      ),
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Container(
                      decoration: BoxDecoration(color: const Color(0xff2a2a2a), borderRadius: BorderRadius.circular(8)),
                      padding: const EdgeInsets.all(12),
                      child: Column(
                        children: [
                          Text(_stats.activeReferrals.toString(), style: TextStyle(color: Colors.green[400], fontSize: 20, fontWeight: FontWeight.bold)),
                          const Text('Active Members', style: TextStyle(color: Color(0xff808080), fontSize: 12)),
                        ],
                      ),
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
        Padding(
          padding: const EdgeInsets.all(16),
          child: Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              gradient: const LinearGradient(begin: Alignment.centerLeft, end: Alignment.centerRight, colors: [Color(0xff1a1a1a), Color(0xff2a2a2a)]),
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: const Color(0xffFFD700).withOpacity(0.2)),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Row(
                  children: [
                    Icon(Icons.share, color: Color(0xffFFD700), size: 20),
                    SizedBox(width: 8),
                    Text('Your Referral Link', style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.w600)),
                  ],
                ),
                const SizedBox(height: 12),
                Container(
                  width: double.infinity,
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(color: const Color(0xff0a0a0a), borderRadius: BorderRadius.circular(8)),
                  child: Text(_referralLink, style: const TextStyle(color: Color(0xffFFD700), fontFamily: 'Courier', fontSize: 12), softWrap: true),
                ),
                const SizedBox(height: 16),
                Row(
                  children: [
                    Expanded(
                      child: ElevatedButton(
                        onPressed: () async {
                          await Clipboard.setData(ClipboardData(text: _referralLink));
                          if (context.mounted) {
                            ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Referral link copied to clipboard!')));
                          }
                        },
                        style: ElevatedButton.styleFrom(
                          backgroundColor: const Color(0xff2a2a2a),
                          side: const BorderSide(color: Color(0xff808080)),
                          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                        ),
                        child: const Row(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            Icon(Icons.copy, color: Colors.white, size: 16),
                            SizedBox(width: 8),
                            Text('Copy Link', style: TextStyle(color: Colors.white)),
                          ],
                        ),
                      ),
                    ),
                    const SizedBox(width: 8),
                    Expanded(
                      child: ElevatedButton(
                        onPressed: _showShareModal,
                        style: ElevatedButton.styleFrom(
                          backgroundColor: const Color(0xffFFD700),
                          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                        ),
                        child: const Row(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            Icon(Icons.share, color: Colors.black, size: 16),
                            SizedBox(width: 8),
                            Text('Share', style: TextStyle(color: Colors.black)),
                          ],
                        ),
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),
        ),
        Padding(
          padding: const EdgeInsets.symmetric(horizontal: 16),
          child: Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: const Color(0xff1a1a1a),
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: const Color(0xff808080)),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    const Row(
                      children: [
                        Icon(Icons.card_giftcard, color: Color(0xffFFD700), size: 20),
                        SizedBox(width: 8),
                        Text('Commission Earnings', style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.w600)),
                      ],
                    ),
                    Icon(Icons.trending_up, color: Colors.green[400], size: 20),
                  ],
                ),
                const SizedBox(height: 12),
                Row(
                  children: [
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text('${_stats.totalCommissions.toStringAsFixed(2)} REGT', style: const TextStyle(color: Color(0xffFFD700), fontSize: 24, fontWeight: FontWeight.bold)),
                          const Text('Total Earned', style: TextStyle(color: Color(0xff808080), fontSize: 12)),
                        ],
                      ),
                    ),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text('${_stats.thisMonthCommissions.toStringAsFixed(2)} REGT', style: TextStyle(color: Colors.green[400], fontSize: 20, fontWeight: FontWeight.bold)),
                          const Text('This Month', style: TextStyle(color: Color(0xff808080), fontSize: 12)),
                        ],
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),
        ),
        Padding(
          padding: const EdgeInsets.all(16),
          child: Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              gradient: LinearGradient(colors: [Colors.blue[600]!.withOpacity(0.1), Colors.purple[600]!.withOpacity(0.1)]),
              border: Border.all(color: Colors.blue[600]!.withOpacity(0.2)),
              borderRadius: BorderRadius.circular(12),
            ),
            child: const Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Icon(Icons.check_circle, color: Colors.blueAccent, size: 20),
                    SizedBox(width: 8),
                    Text('How It Works', style: TextStyle(color: Colors.blueAccent, fontSize: 16, fontWeight: FontWeight.w100)),
                  ],
                ),
                SizedBox(height: 8),
                Text(' Earn 5% commission on referral earnings', style: TextStyle(color: Colors.grey, fontSize: 12)),
                Text(' Get bonus rewards for active referrals', style: TextStyle(color: Colors.grey, fontSize: 12)),
                Text(' Track performance in real-time', style: TextStyle(color: Colors.grey, fontSize: 12)),
                Text(' Instant payouts to your balance', style: TextStyle(color: Colors.grey, fontSize: 12)),
              ],
            ),
          ),
        ),
        Padding(
          padding: const EdgeInsets.symmetric(horizontal: 16),
          child: Row(
            children: [
              const Icon(Icons.people, color: Color(0xffFFD700), size: 20),
              const SizedBox(width: 8),
              Text('Your Team (${_team.length})', style: const TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.w600)),
            ],
          ),
        ),
        const SizedBox(height: 8),
        ..._team.map((member) {
          String id = member['id'].toString();
          bool isExpanded = _expandedMember == id;
          String name = member['profiles']['username'] ?? 'Unknown';
          String subtitle = member['profiles']['country'] ?? '';
          bool status = member['active_status'] as bool? ?? false;
          double commission = (member['commission'] as num? ?? 0).toDouble();
          double earnings = (member['earnings'] as num? ?? 0).toDouble();
          int level = member['level'] as int? ?? 1;
          DateTime? joinDate;
          if (member['created_at'] != null) {
            joinDate = DateTime.parse(member['created_at']);
          }

          return Padding(
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),
            child: GestureDetector(
              onTap: () {
                setState(() {
                  _expandedMember = isExpanded ? null : id;
                });
              },
              child: Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: const Color(0xff1a1a1a),
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(color: isExpanded ? const Color(0xffFFD700).withOpacity(0.5) : const Color(0xff808080)),
                ),
                child: Column(
                  children: [
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        Row(
                          children: [
                            Container(
                              width: 40,
                              height: 40,
                              decoration: const BoxDecoration(
                                color: Color(0xffFFD700),
                                shape: BoxShape.circle,
                              ),
                              child: Center(
                                child: Text(
                                  name.split(' ').map((n) => n[0]).join().toUpperCase(),
                                  style: const TextStyle(color: Colors.black, fontSize: 12, fontWeight: FontWeight.bold),
                                ),
                              ),
                            ),
                            const SizedBox(width: 12),
                            Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(name, style: const TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.w100)),
                                Text(subtitle, style: const TextStyle(color: Colors.grey, fontSize: 12)),
                                Row(
                                  children: [
                                    Container(
                                      width: 8,
                                      height: 8,
                                      decoration: BoxDecoration(
                                        color: status ? Colors.green[400] : Colors.red[400],
                                        shape: BoxShape.circle,
                                      ),
                                    ),
                                    const SizedBox(width: 4),
                                    Text(
                                      status ? 'active' : 'inactive',
                                      style: TextStyle(color: status ? Colors.green[400] : Colors.red[400], fontSize: 12),
                                    ),
                                  ],
                                ),
                              ],
                            ),
                          ],
                        ),
                        Column(
                          crossAxisAlignment: CrossAxisAlignment.end,
                          children: [
                            Text('+${commission.toStringAsFixed(2)} REGT', style: const TextStyle(color: Color(0xffFFD700), fontSize: 14, fontWeight: FontWeight.w600)),
                            const Text('Commission', style: TextStyle(color: Colors.grey, fontSize: 12)),
                          ],
                        ),
                      ],
                    ),
                    if (isExpanded && joinDate != null)
                      Column(
                        children: [
                          const SizedBox(height: 16),
                          const Divider(color: Colors.grey),
                          const SizedBox(height: 16),
                          Row(
                            mainAxisAlignment: MainAxisAlignment.spaceAround,
                            children: [
                              Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  const Text('Joined:', style: TextStyle(color: Colors.grey, fontSize: 12)),
                                  Text(DateFormat('MMM d, yyyy').format(joinDate), style: const TextStyle(color: Colors.white, fontSize: 12)),
                                ],
                              ),
                              Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  const Text('Level:', style: TextStyle(color: Colors.grey, fontSize: 12)),
                                  Text(level.toString(), style: const TextStyle(color: Colors.white, fontSize: 12)),
                                ],
                              ),
                            ],
                          ),
                          const SizedBox(height: 8),
                          Row(
                            mainAxisAlignment: MainAxisAlignment.spaceAround,
                            children: [
                              Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  const Text('Their Earnings:', style: TextStyle(color: Colors.grey, fontSize: 12)),
                                  Text('${earnings.toStringAsFixed(2)} REGT', style: const TextStyle(color: Colors.white, fontSize: 12)),
                                ],
                              ),
                              Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  const Text('Your Commission:', style: TextStyle(color: Colors.grey, fontSize: 12)),
                                  Text('${commission.toStringAsFixed(2)} REGT', style: const TextStyle(color: Color(0xffFFD700), fontSize: 12)),
                                ],
                              ),
                            ],
                          ),
                        ],
                      ),
                  ],
                ),
              ),
            ),
          );
        }),
        const SizedBox(height: 16),
      ],
    );
  }
}

// File: c:\Users\Youssef\Documents\flutter_apps\regt_app\lib\screens\withdrawal_screen.dart
// import 'package:flutter/material.dart';
// import 'package:supabase_flutter/supabase_flutter.dart';

// class WithdrawalScreen extends StatefulWidget {
//   const WithdrawalScreen({super.key});

//   @override
//   State<WithdrawalScreen> createState() => _WithdrawalScreenState();
// }

// class _WithdrawalScreenState extends State<WithdrawalScreen> {
//   final _amountController = TextEditingController();
//   String _method = 'REGT';
//   final _detailsController = TextEditingController();

//   Future<void> _submitWithdrawal() async {
//     final userId = Supabase.instance.client.auth.currentUser?.id;
//     final amount = double.tryParse(_amountController.text);
//     if (userId == null || amount == null || amount < 100) {
//       ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Invalid amount (min 100 REGT)')));
//       return;
//     }

//     await Supabase.instance.client.from('withdraw_requests').insert({
//       'user_id': userId,
//       'amount': amount,
//       'method': _method,
//       'details': {'info': _detailsController.text},
//       'status': 'pending',
//     });
//     ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Withdrawal requested. Admin will review.')));
//     Navigator.pop(context);
//   }

//   @override
//   Widget build(BuildContext context) {
//     return Scaffold(
//       backgroundColor: Colors.black,
//       appBar: AppBar(title: const Text('Withdrawal')),
//       body: Padding(
//         padding: const EdgeInsets.all(16.0),
//         child: Column(
//           children: [
//             TextField(
//               controller: _amountController,
//               keyboardType: TextInputType.number,
//               decoration: const InputDecoration(labelText: 'Amount (min 100 REGT)', labelStyle: TextStyle(color: Colors.white)),
//               style: const TextStyle(color: Colors.white),
//             ),
//             DropdownButton<String>(
//               value: _method,
//               items: ['REGT', 'USDT', 'BANK'].map((m) => DropdownMenuItem(value: m, child: Text(m))).toList(),
//               onChanged: (val) => setState(() => _method = val!),
//               style: const TextStyle(color: Colors.white),
//             ),
//             TextField(
//               controller: _detailsController,
//               decoration: const InputDecoration(labelText: 'Details (wallet/bank)', labelStyle: TextStyle(color: Colors.white)),
//               style: const TextStyle(color: Colors.white),
//             ),
//             ElevatedButton(onPressed: _submitWithdrawal, child: const Text('Submit Request')),
//           ],
//         ),
//       ),
//     );
//   }
// }











// import 'dart:convert';

// import 'package:flutter/material.dart';
// import 'package:flutter/services.dart';
// import 'package:supabase_flutter/supabase_flutter.dart';
// import 'package:intl/intl.dart';

// class WithdrawalScreen extends StatefulWidget {
//   const WithdrawalScreen({super.key});

//   @override
//   State<WithdrawalScreen> createState() => _WithdrawalScreenState();
// }

// class _WithdrawalScreenState extends State<WithdrawalScreen> {
//   final _amountController = TextEditingController();
//   String _method = '';
//   final _detailsController = TextEditingController();
//   final _walletAddressController = TextEditingController();
//   final _accountNameController = TextEditingController();
//   final _accountNumberController = TextEditingController();
//   final _bankNameController = TextEditingController();
//   final _routingNumberController = TextEditingController();
//   int _currentStep = 1;
//   bool _loading = false;
//   bool _showSuccess = false;
//   List<Map<String, dynamic>> _pendingRequests = [];
//   double _balance = 0.0; // Placeholder, fetch if needed

//   final minWithdrawal = 100.0;
//   final withdrawalMethods = [
//     {'id': 'regt', 'label': 'REGT Wallet', 'icon': Icons.account_balance_wallet, 'fee': '0 REGT', 'time': '24-48 hours'},
//     {'id': 'usdt', 'label': 'USDT (TRC20)', 'icon': Icons.credit_card, 'fee': '2 USDT', 'time': '1-6 hours'},
//     {'id': 'bank', 'label': 'Bank Transfer', 'icon': Icons.account_balance, 'fee': '5 USD', 'time': '3-5 days'},
//   ];

//   @override
//   void initState() {
//     super.initState();
//     _loadBalance();
//     _loadPending();
//   }

//   Future<void> _loadBalance() async {
//     final userId = Supabase.instance.client.auth.currentUser?.id;
//     if (userId == null) return;
//     final data = await Supabase.instance.client.from('user_balances').select('balance').eq('user_id', userId).maybeSingle();
//     setState(() => _balance = (data?['balance'] as double?) ?? 0.0);
//   }

//   Future<void> _loadPending() async {
//     final userId = Supabase.instance.client.auth.currentUser?.id;
//     if (userId == null) return;
//     final data = await Supabase.instance.client.from('withdraw_requests').select().eq('user_id', userId).order('created_at', ascending: false);
//     setState(() => _pendingRequests = data);
//   }

//   bool _validateStep1() {
//     final amount = double.tryParse(_amountController.text);
//     if (amount == null || amount < minWithdrawal) {
//       ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Minimum withdrawal amount is $minWithdrawal REGT')));
//       return false;
//     }
//     if (amount > _balance) {
//       ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Insufficient balance')));
//       return false;
//     }
//     if (_method.isEmpty) {
//       ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Please select a withdrawal method')));
//       return false;
//     }
//     return true;
//   }

//   bool _validateStep2() {
//     if (_method == 'regt' || _method == 'usdt') {
//       if (_walletAddressController.text.trim().isEmpty) {
//         ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Please enter your wallet address')));
//         return false;
//       }
//     } else if (_method == 'bank') {
//       if (_accountNameController.text.trim().isEmpty ||
//           _accountNumberController.text.trim().isEmpty ||
//           _bankNameController.text.trim().isEmpty) {
//         ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Please fill in all bank details')));
//         return false;
//       }
//     }
//     return true;
//   }

//   void _handleNext() {
//     if (_currentStep == 1 && _validateStep1()) {
//       setState(() => _currentStep = 2);
//     } else if (_currentStep == 2 && _validateStep2()) {
//       setState(() => _currentStep = 3);
//     }
//   }

//   Future<void> _submitWithdrawal() async {
//     setState(() => _loading = true);
//     final userId = Supabase.instance.client.auth.currentUser?.id;
//     final amount = double.tryParse(_amountController.text);
//     if (userId == null || amount == null || amount < minWithdrawal) {
//       setState(() => _loading = false);
//       ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Invalid amount (min 100 REGT)')));
//       return;
//     }

//     Map<String, dynamic> details;
//     if (_method == 'bank') {
//       details = {
//         'accountName': _accountNameController.text,
//         'accountNumber': _accountNumberController.text,
//         'bankName': _bankNameController.text,
//         'routingNumber': _routingNumberController.text,
//       };
//     } else {
//       details = {'info': _walletAddressController.text};
//     }

//     await Supabase.instance.client.from('withdraw_requests').insert({
//       'user_id': userId,
//       'amount': amount,
//       'method': _method.toUpperCase(),
//       'details': details,
//       'status': 'pending',
//     });
//     await _loadPending();
//     setState(() {
//       _loading = false;
//       _showSuccess = true;
//     });
//     ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Withdrawal requested. Admin will review.')));
//   }

//   void _copyToClipboard(String text) {
//     Clipboard.setData(ClipboardData(text: text));
//     ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Copied to clipboard!')));
//   }

//   String _getStatusColor(String status) {
//     switch (status) {
//       case 'pending':
//         return 'amber';
//       case 'processing':
//         return 'blue';
//       case 'completed':
//         return 'green';
//       case 'failed':
//         return 'red';
//       default:
//         return 'grey';
//     }
//   }

//   @override
//   Widget build(BuildContext context) {
//     if (_showSuccess) {
//       return Scaffold(
//         backgroundColor: Colors.black,
//         body: Center(
//           child: Column(
//             mainAxisAlignment: MainAxisAlignment.center,
//             children: [
//               const Icon(Icons.check_circle, size: 80, color: Colors.green),
//               const SizedBox(height: 16),
//               const Text('Withdrawal Submitted!', style: TextStyle(color: Colors.white, fontSize: 24, fontWeight: FontWeight.bold)),
//               const SizedBox(height: 8),
//               const Text('Your withdrawal request has been submitted successfully. You\'ll receive a confirmation email shortly.',
//                   style: TextStyle(color: Color(0xff808080), fontSize: 16), textAlign: TextAlign.center),
//               const SizedBox(height: 24),
//               ElevatedButton(
//                 onPressed: () {
//                   setState(() {
//                     _showSuccess = false;
//                     _currentStep = 1;
//                     _amountController.clear();
//                     _method = '';
//                     _walletAddressController.clear();
//                     _accountNameController.clear();
//                     _accountNumberController.clear();
//                     _bankNameController.clear();
//                     _routingNumberController.clear();
//                   });
//                 },
//                 style: ElevatedButton.styleFrom(
//                   backgroundColor: const Color(0xffFFD700),
//                   foregroundColor: Colors.black,
//                 ),
//                 child: const Text('Make Another Withdrawal'),
//               ),
//             ],
//           ),
//         ),
//       );
//     }

//     return Scaffold(
//       backgroundColor: Colors.black,
//       body: Column(
//         children: [
//           // Header
//           Container(
//             padding: const EdgeInsets.all(16),
//             decoration: const BoxDecoration(
//               color: Color(0xff1a1a1a),
//               border: Border(bottom: BorderSide(color: Color(0xff808080))),
//             ),
//             child: Column(
//               crossAxisAlignment: CrossAxisAlignment.start,
//               children: [
//                 const Text('Withdraw Funds', style: TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w600)),
//                 const SizedBox(height: 16),
//                 Row(
//                   mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                   children: [
//                     ...List.generate(3, (index) {
//                       final step = index + 1;
//                       return Expanded(
//                         child: Row(
//                           children: [
//                             Container(
//                               width: 32,
//                               height: 32,
//                               decoration: BoxDecoration(
//                                 shape: BoxShape.circle,
//                                 color: step <= _currentStep ? const Color(0xffFFD700) : const Color(0xff2a2a2a),
//                               ),
//                               child: Center(
//                                 child: step < _currentStep
//                                     ? const Icon(Icons.check, size: 16, color: Colors.black)
//                                     : Text(step.toString(), style: TextStyle(color: step <= _currentStep ? Colors.black : const Color(0xff808080))),
//                               ),
//                             ),
//                             if (index < 2) const Expanded(child: Divider(color: Color(0xff808080), thickness: 1)),
//                           ],
//                         ),
//                       );
//                     }),
//                   ],
//                 ),
//                 const SizedBox(height: 8),
//                 Text(
//                   'Step $_currentStep: ${_currentStep == 1 ? 'Amount & Method' : _currentStep == 2 ? 'Payment Details' : 'Review & Confirm'}',
//                   style: const TextStyle(color: Color(0xff808080), fontSize: 12),
//                 ),
//               ],
//             ),
//           ),
//           Expanded(
//             child: Padding(
//               padding: const EdgeInsets.all(16.0),
//               child: _currentStep == 1
//                   ? Column(
//                       crossAxisAlignment: CrossAxisAlignment.start,
//                       children: [
//                         Container(
//                           padding: const EdgeInsets.all(16),
//                           decoration: BoxDecoration(
//                             color: const Color(0xff1a1a1a),
//                             borderRadius: BorderRadius.circular(12),
//                             border: Border.all(color: const Color(0xff808080)),
//                           ),
//                           child: Column(
//                             crossAxisAlignment: CrossAxisAlignment.start,
//                             children: [
//                               const Text('Available Balance', style: TextStyle(color: Color(0xff808080), fontSize: 12)),
//                               Text('$_balance REGT', style: const TextStyle(color: Colors.white, fontSize: 24, fontWeight: FontWeight.bold)),
//                             ],
//                           ),
//                         ),
//                         const SizedBox(height: 16),
//                         TextField(
//                           controller: _amountController,
//                           keyboardType: TextInputType.number,
//                           decoration: InputDecoration(
//                             labelText: 'Withdrawal Amount',
//                             labelStyle: const TextStyle(color: Color(0xff808080)),
//                             hintText: 'Minimum $minWithdrawal REGT',
//                             hintStyle: const TextStyle(color: Color(0xff808080)),
//                             border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
//                           ),
//                           style: const TextStyle(color: Colors.white),
//                         ),
//                         const SizedBox(height: 16),
//                         const Text('Withdrawal Method', style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.w500)),
//                         const SizedBox(height: 8),
//                         ...withdrawalMethods.map((m) => GestureDetector(
//                               onTap: () => setState(() => _method = m['id'] as String),
//                               child: Container(
//                                 margin: const EdgeInsets.only(bottom: 8),
//                                 padding: const EdgeInsets.all(16),
//                                 decoration: BoxDecoration(
//                                   color: _method == (m['id'] as String) ? const Color(0xffFFD700).withOpacity(0.1) : const Color(0xff1a1a1a),
//                                   borderRadius: BorderRadius.circular(12),
//                                   border: Border.all(color: _method == (m['id'] as String) ? const Color(0xffFFD700) : const Color(0xff808080)),
//                                 ),
//                                 child: Row(
//                                   children: [
//                                     Icon(m['icon'] as IconData, color: const Color(0xffFFD700)),
//                                     const SizedBox(width: 12),
//                                     Expanded(
//                                       child: Column(
//                                         crossAxisAlignment: CrossAxisAlignment.start,
//                                         children: [
//                                           Text(m['label'] as String, style: const TextStyle(color: Colors.white, fontSize: 16)),
//                                           Text('Fee: ${m['fee']}  Time: ${m['time']}', style: const TextStyle(color: Color(0xff808080), fontSize: 12)),
//                                         ],
//                                       ),
//                                     ),
//                                     if (_method == (m['id'] as String)) const Icon(Icons.check_circle, color: Color(0xffFFD700)),
//                                   ],
//                                 ),
//                               ),
//                             )),
//                       ],
//                     )
//                   : _currentStep == 2
//                       ? Column(
//                           crossAxisAlignment: CrossAxisAlignment.start,
//                           children: [
//                             const Text('Payment Details', style: TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w600)),
//                             const SizedBox(height: 16),
//                             if (_method == 'regt' || _method == 'usdt')
//                               TextField(
//                                 controller: _walletAddressController,
//                                 decoration: InputDecoration(
//                                   labelText: 'Wallet Address',
//                                   labelStyle: const TextStyle(color: Color(0xff808080)),
//                                   border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
//                                 ),
//                                 style: const TextStyle(color: Colors.white),
//                               )
//                             else
//                               Column(
//                                 children: [
//                                   TextField(
//                                     controller: _accountNameController,
//                                     decoration: InputDecoration(
//                                       labelText: 'Account Name',
//                                       labelStyle: const TextStyle(color: Color(0xff808080)),
//                                       border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
//                                     ),
//                                     style: const TextStyle(color: Colors.white),
//                                   ),
//                                   const SizedBox(height: 8),
//                                   TextField(
//                                     controller: _accountNumberController,
//                                     decoration: InputDecoration(
//                                       labelText: 'Account Number',
//                                       labelStyle: const TextStyle(color: Color(0xff808080)),
//                                       border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
//                                     ),
//                                     style: const TextStyle(color: Colors.white),
//                                   ),
//                                   const SizedBox(height: 8),
//                                   TextField(
//                                     controller: _bankNameController,
//                                     decoration: InputDecoration(
//                                       labelText: 'Bank Name',
//                                       labelStyle: const TextStyle(color: Color(0xff808080)),
//                                       border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
//                                     ),
//                                     style: const TextStyle(color: Colors.white),
//                                   ),
//                                   const SizedBox(height: 8),
//                                   TextField(
//                                     controller: _routingNumberController,
//                                     decoration: InputDecoration(
//                                       labelText: 'Routing Number (optional)',
//                                       labelStyle: const TextStyle(color: Color(0xff808080)),
//                                       border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
//                                     ),
//                                     style: const TextStyle(color: Colors.white),
//                                   ),
//                                 ],
//                               ),
//                           ],
//                         )
//                       : Column(
//                           crossAxisAlignment: CrossAxisAlignment.start,
//                           children: [
//                             const Text('Review Withdrawal', style: TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w600)),
//                             const SizedBox(height: 16),
//                             Container(
//                               padding: const EdgeInsets.all(16),
//                               decoration: BoxDecoration(
//                                 color: const Color(0xff1a1a1a),
//                                 borderRadius: BorderRadius.circular(12),
//                                 border: Border.all(color: const Color(0xff808080)),
//                               ),
//                               child: Column(
//                                 crossAxisAlignment: CrossAxisAlignment.start,
//                                 children: [
//                                   Row(
//                                     mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                                     children: [
//                                       const Text('Amount', style: TextStyle(color: Color(0xff808080))),
//                                       Text('${_amountController.text} REGT', style: const TextStyle(color: Colors.white)),
//                                     ],
//                                   ),
//                                   const SizedBox(height: 8),
//                                   Row(
//                                     mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                                     children: [
//                                       const Text('Method', style: TextStyle(color: Color(0xff808080))),
//                                       Text(withdrawalMethods.firstWhere((m) => m['id'] == _method)['label'] as String, style: const TextStyle(color: Colors.white)),
//                                     ],
//                                   ),
//                                   const SizedBox(height: 8),
//                                   if (_method != 'bank')
//                                     Row(
//                                       mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                                       children: [
//                                         const Text('Address', style: TextStyle(color: Color(0xff808080))),
//                                         Row(
//                                           children: [
//                                             Text(
//                                               '${_walletAddressController.text.substring(0, 10)}...${_walletAddressController.text.substring(_walletAddressController.text.length - 6)}',
//                                               style: const TextStyle(color: Colors.white),
//                                             ),
//                                             IconButton(
//                                               onPressed: () => _copyToClipboard(_walletAddressController.text),
//                                               icon: const Icon(Icons.copy, size: 16, color: Color(0xff808080)),
//                                             ),
//                                           ],
//                                         ),
//                                       ],
//                                     )
//                                   else
//                                     Column(
//                                       crossAxisAlignment: CrossAxisAlignment.start,
//                                       children: [
//                                         Row(
//                                           mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                                           children: [
//                                             const Text('Account Name', style: TextStyle(color: Color(0xff808080))),
//                                             Text(_accountNameController.text, style: const TextStyle(color: Colors.white)),
//                                           ],
//                                         ),
//                                         const SizedBox(height: 8),
//                                         Row(
//                                           mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                                           children: [
//                                             const Text('Account Number', style: TextStyle(color: Color(0xff808080))),
//                                             Text(_accountNumberController.text, style: const TextStyle(color: Colors.white)),
//                                           ],
//                                         ),
//                                         const SizedBox(height: 8),
//                                         Row(
//                                           mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                                           children: [
//                                             const Text('Bank Name', style: TextStyle(color: Color(0xff808080))),
//                                             Text(_bankNameController.text, style: const TextStyle(color: Colors.white)),
//                                           ],
//                                         ),
//                                       ],
//                                     ),
//                                 ],
//                               ),
//                             ),
//                           ],
//                         ),
//             ),
//           ),
//           Padding(
//             padding: const EdgeInsets.all(16.0),
//             child: Row(
//               children: [
//                 if (_currentStep > 1)
//                   Expanded(
//                     child: OutlinedButton(
//                       onPressed: () => setState(() => _currentStep--),
//                       style: OutlinedButton.styleFrom(
//                         side: const BorderSide(color: Color(0xff808080)),
//                         foregroundColor: Color(0xff808080),
//                       ),
//                       child: const Text('Back'),
//                     ),
//                   ),
//                 if (_currentStep > 1) const SizedBox(width: 8),
//                 Expanded(
//                   child: ElevatedButton(
//                     onPressed: _loading ? null : (_currentStep == 3 ? _submitWithdrawal : _handleNext),
//                     style: ElevatedButton.styleFrom(
//                       backgroundColor: const Color(0xffFFD700),
//                       foregroundColor: Colors.black,
//                     ),
//                     child: _loading ? const CircularProgressIndicator(color: Colors.black) : Text(_currentStep == 3 ? 'Submit Withdrawal' : 'Continue'),
//                   ),
//                 ),
//               ],
//             ),
//           ),
//           if (_pendingRequests.isNotEmpty)
//             Container(
//               padding: const EdgeInsets.all(16),
//               decoration: const BoxDecoration(
//                 border: Border(top: BorderSide(color: Color(0xff808080))),
//               ),
//               child: Column(
//                 crossAxisAlignment: CrossAxisAlignment.start,
//                 children: [
//                   const Text('Pending Withdrawals', style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.w600)),
//                   const SizedBox(height: 8),
//                   ..._pendingRequests.map((request) => Container(
//                         margin: const EdgeInsets.only(bottom: 8),
//                         padding: const EdgeInsets.all(16),
//                         decoration: BoxDecoration(
//                           color: const Color(0xff1a1a1a),
//                           borderRadius: BorderRadius.circular(12),
//                           border: Border.all(color: const Color(0xff808080)),
//                         ),
//                         child: Row(
//                           mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                           children: [
//                             Column(
//                               crossAxisAlignment: CrossAxisAlignment.start,
//                               children: [
//                                 Text('${request['amount']} REGT', style: const TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.w500)),
//                                 Text(request['method'], style: const TextStyle(color: Color(0xff808080), fontSize: 12)),
//                               ],
//                             ),
//                             Column(
//                               crossAxisAlignment: CrossAxisAlignment.end,
//                               children: [
//                                 Text(request['status'].toString().capitalize(), style: TextStyle(color: Colors.amber, fontSize: 12, fontWeight: FontWeight.w500)),
//                                 Text(DateFormat('MMM d, yyyy').format(DateTime.parse(request['created_at'])), style: const TextStyle(color: Color(0xff808080), fontSize: 10)),
//                               ],
//                             ),
//                           ],
//                         ),
//                       )),
//                 ],
//               ),
//             ),
//         ],
//       ),
//     );
//   }
// }

// extension StringExtension on String {
//   String capitalize() {
//     return "${this[0].toUpperCase()}${substring(1)}";
//   }
// }









// import 'dart:convert';

// import 'package:flutter/material.dart';
// import 'package:flutter/services.dart';
// import 'package:supabase_flutter/supabase_flutter.dart';
// import 'package:intl/intl.dart';

// class WithdrawalScreen extends StatefulWidget {
//   const WithdrawalScreen({super.key});

//   @override
//   State<WithdrawalScreen> createState() => _WithdrawalScreenState();
// }

// class _WithdrawalScreenState extends State<WithdrawalScreen> {
//   final _amountController = TextEditingController();
//   String _method = '';
//   final _walletAddressController = TextEditingController();
//   final _nameController = TextEditingController();
//   final _bankNameController = TextEditingController();
//   final _countryController = TextEditingController();
//   final _swiftController = TextEditingController();
//   final _ibanController = TextEditingController();
//   int _currentStep = 1;
//   bool _loading = false;
//   bool _showSuccess = false;
//   List<Map<String, dynamic>> _pendingRequests = [];
//   double _balance = 0.0; // Placeholder, fetch if needed

//   final minWithdrawal = 100.0;
//   final withdrawalMethods = [
//     {'id': 'regt', 'label': 'REGT', 'description': 'crypto-currency wallet __metamask, Trust wallet, etc. (bnb smart chain)', 'icon': Icons.account_balance_wallet, 'fee': '0 REGT', 'time': '24-48 hours'},
//     {'id': 'usdt', 'label': 'USDT', 'description': 'crypto-currency wallet __ (bnb smart chain)', 'icon': Icons.credit_card, 'fee': '2 USDT', 'time': '1-6 hours'},
//     {'id': 'bank', 'label': 'bank transfer', 'description': 'name, bank name, country, swift, IBAN', 'icon': Icons.account_balance, 'fee': '5 USD', 'time': '3-5 days'},
//   ];

//   @override
//   void initState() {
//     super.initState();
//     _loadBalance();
//     _loadPending();
//   }

//   Future<void> _loadBalance() async {
//     final userId = Supabase.instance.client.auth.currentUser?.id;
//     if (userId == null) return;
//     final data = await Supabase.instance.client.from('user_balances').select('balance').eq('user_id', userId).maybeSingle();
//     setState(() => _balance = (data?['balance'] as double?) ?? 0.0);
//   }

//   Future<void> _loadPending() async {
//     final userId = Supabase.instance.client.auth.currentUser?.id;
//     if (userId == null) return;
//     final data = await Supabase.instance.client.from('withdraw_requests').select().eq('user_id', userId).order('created_at', ascending: false);
//     setState(() => _pendingRequests = data);
//   }

//   bool _validateStep1() {
//     final amount = double.tryParse(_amountController.text);
//     if (amount == null || amount < minWithdrawal) {
//       ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Minimum withdrawal amount is $minWithdrawal REGT')));
//       return false;
//     }
//     if (amount > _balance) {
//       ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Insufficient balance')));
//       return false;
//     }
//     if (_method.isEmpty) {
//       ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Please select a withdrawal method')));
//       return false;
//     }
//     return true;
//   }

//   bool _validateStep2() {
//     if (_method == 'regt' || _method == 'usdt') {
//       if (_walletAddressController.text.trim().isEmpty) {
//         ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Please enter your wallet address')));
//         return false;
//       }
//     } else if (_method == 'bank') {
//       if (_nameController.text.trim().isEmpty ||
//           _bankNameController.text.trim().isEmpty ||
//           _countryController.text.trim().isEmpty ||
//           _swiftController.text.trim().isEmpty ||
//           _ibanController.text.trim().isEmpty) {
//         ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Please fill in all bank details')));
//         return false;
//       }
//     }
//     return true;
//   }

//   void _handleNext() {
//     if (_currentStep == 1 && _validateStep1()) {
//       setState(() => _currentStep = 2);
//     } else if (_currentStep == 2 && _validateStep2()) {
//       setState(() => _currentStep = 3);
//     }
//   }

//   Future<void> _submitWithdrawal() async {
//     setState(() => _loading = true);
//     final userId = Supabase.instance.client.auth.currentUser?.id;
//     final amount = double.tryParse(_amountController.text);
//     if (userId == null || amount == null || amount < minWithdrawal) {
//       setState(() => _loading = false);
//       ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Invalid amount (min 100 REGT)')));
//       return;
//     }

//     Map<String, dynamic> details;
//     if (_method == 'bank') {
//       details = {
//         'name': _nameController.text,
//         'bankName': _bankNameController.text,
//         'country': _countryController.text,
//         'swift': _swiftController.text,
//         'iban': _ibanController.text,
//       };
//     } else {
//       details = {'walletAddress': _walletAddressController.text};
//     }

//     await Supabase.instance.client.from('withdraw_requests').insert({
//       'user_id': userId,
//       'amount': amount,
//       'method': _method.toUpperCase(),
//       'details': details,
//       'status': 'pending',
//     });
//     await _loadPending();
//     setState(() {
//       _loading = false;
//       _showSuccess = true;
//     });
//     ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Withdrawal requested. Admin will review.')));
//   }

//   void _copyToClipboard(String text) {
//     Clipboard.setData(ClipboardData(text: text));
//     ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Copied to clipboard!')));
//   }

//   Color _getStatusColor(String status) {
//     switch (status) {
//       case 'pending':
//         return Colors.amber;
//       case 'processing':
//         return Colors.blue;
//       case 'completed':
//         return Colors.green;
//       case 'failed':
//         return Colors.red;
//       default:
//         return Colors.grey;
//     }
//   }

//   @override
//   Widget build(BuildContext context) {
//     if (_showSuccess) {
//       return Scaffold(
//         backgroundColor: Colors.black,
//         body: Center(
//           child: Column(
//             mainAxisAlignment: MainAxisAlignment.center,
//             children: [
//               const Icon(Icons.check_circle, size: 80, color: Colors.green),
//               const SizedBox(height: 16),
//               const Text('Withdrawal Submitted!', style: TextStyle(color: Colors.white, fontSize: 24, fontWeight: FontWeight.bold)),
//               const SizedBox(height: 8),
//               const Text('Your withdrawal request has been submitted successfully. You\'ll receive a confirmation email shortly.',
//                   style: TextStyle(color: Color(0xff808080), fontSize: 16), textAlign: TextAlign.center),
//               const SizedBox(height: 24),
//               ElevatedButton(
//                 onPressed: () {
//                   setState(() {
//                     _showSuccess = false;
//                     _currentStep = 1;
//                     _amountController.clear();
//                     _method = '';
//                     _walletAddressController.clear();
//                     _nameController.clear();
//                     _bankNameController.clear();
//                     _countryController.clear();
//                     _swiftController.clear();
//                     _ibanController.clear();
//                   });
//                 },
//                 style: ElevatedButton.styleFrom(
//                   backgroundColor: const Color(0xffFFD700),
//                   foregroundColor: Colors.black,
//                 ),
//                 child: const Text('Make Another Withdrawal'),
//               ),
//             ],
//           ),
//         ),
//       );
//     }

//     return Scaffold(
//       backgroundColor: Colors.black,
//       body: Column(
//         children: [
//           // Header
//           Container(
//             padding: const EdgeInsets.all(16),
//             decoration: const BoxDecoration(
//               color: Color(0xff1a1a1a),
//               border: Border(bottom: BorderSide(color: Color(0xff808080))),
//             ),
//             child: Column(
//               crossAxisAlignment: CrossAxisAlignment.start,
//               children: [
//                 const Text('Withdraw Funds', style: TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w600)),
//                 const SizedBox(height: 16),
//                 Row(
//                   mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                   children: [
//                     ...List.generate(3, (index) {
//                       final step = index + 1;
//                       return Expanded(
//                         child: Row(
//                           children: [
//                             Container(
//                               width: 32,
//                               height: 32,
//                               decoration: BoxDecoration(
//                                 shape: BoxShape.circle,
//                                 color: step <= _currentStep ? const Color(0xffFFD700) : const Color(0xff2a2a2a),
//                               ),
//                               child: Center(
//                                 child: step < _currentStep
//                                     ? const Icon(Icons.check, size: 16, color: Colors.black)
//                                     : Text(step.toString(), style: TextStyle(color: step <= _currentStep ? Colors.black : const Color(0xff808080))),
//                               ),
//                             ),
//                             if (index < 2) const Expanded(child: Divider(color: Color(0xff808080), thickness: 1)),
//                           ],
//                         ),
//                       );
//                     }),
//                   ],
//                 ),
//                 const SizedBox(height: 8),
//                 Text(
//                   'Step $_currentStep: ${_currentStep == 1 ? 'Amount & Method' : _currentStep == 2 ? 'Payment Details' : 'Review & Confirm'}',
//                   style: const TextStyle(color: Color(0xff808080), fontSize: 12),
//                 ),
//               ],
//             ),
//           ),
//           Expanded(
//             child: Padding(
//               padding: const EdgeInsets.all(16.0),
//               child: _currentStep == 1
//                   ? Column(
//                       crossAxisAlignment: CrossAxisAlignment.start,
//                       children: [
//                         Container(
//                           padding: const EdgeInsets.all(16),
//                           decoration: BoxDecoration(
//                             color: const Color(0xff1a1a1a),
//                             borderRadius: BorderRadius.circular(12),
//                             border: Border.all(color: const Color(0xff808080)),
//                           ),
//                           child: Column(
//                             crossAxisAlignment: CrossAxisAlignment.start,
//                             children: [
//                               const Text('Available Balance', style: TextStyle(color: Color(0xff808080), fontSize: 12)),
//                               Text('$_balance REGT', style: const TextStyle(color: Colors.white, fontSize: 24, fontWeight: FontWeight.bold)),
//                             ],
//                           ),
//                         ),
//                         const SizedBox(height: 16),
//                         TextField(
//                           controller: _amountController,
//                           keyboardType: TextInputType.number,
//                           decoration: InputDecoration(
//                             labelText: 'Withdrawal Amount',
//                             labelStyle: const TextStyle(color: Color(0xff808080)),
//                             hintText: 'Minimum $minWithdrawal REGT',
//                             hintStyle: const TextStyle(color: Color(0xff808080)),
//                             border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
//                           ),
//                           style: const TextStyle(color: Colors.white),
//                         ),
//                         const SizedBox(height: 16),
//                         const Text('Withdrawal Method', style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.w500)),
//                         const SizedBox(height: 8),
//                         ...withdrawalMethods.map((m) => GestureDetector(
//                               onTap: () => setState(() => _method = m['id'] as String),
//                               child: Container(
//                                 margin: const EdgeInsets.only(bottom: 8),
//                                 padding: const EdgeInsets.all(16),
//                                 decoration: BoxDecoration(
//                                   color: _method == (m['id'] as String) ? const Color(0xffFFD700).withOpacity(0.1) : const Color(0xff1a1a1a),
//                                   borderRadius: BorderRadius.circular(12),
//                                   border: Border.all(color: _method == (m['id'] as String) ? const Color(0xffFFD700) : const Color(0xff808080)),
//                                 ),
//                                 child: Row(
//                                   children: [
//                                     Icon(m['icon'] as IconData, color: const Color(0xffFFD700)),
//                                     const SizedBox(width: 12),
//                                     Expanded(
//                                       child: Column(
//                                         crossAxisAlignment: CrossAxisAlignment.start,
//                                         children: [
//                                           Text(m['label'] as String, style: const TextStyle(color: Colors.white, fontSize: 16)),
//                                           Text(m['description'] as String, style: const TextStyle(color: Color(0xff808080), fontSize: 12)),
//                                           Text('Fee: ${m['fee']}  Time: ${m['time']}', style: const TextStyle(color: Color(0xff808080), fontSize: 12)),
//                                         ],
//                                       ),
//                                     ),
//                                     if (_method == (m['id'] as String)) const Icon(Icons.check_circle, color: Color(0xffFFD700)),
//                                   ],
//                                 ),
//                               ),
//                             )),
//                       ],
//                     )
//                   : _currentStep == 2
//                       ? Column(
//                           crossAxisAlignment: CrossAxisAlignment.start,
//                           children: [
//                             const Text('Payment Details', style: TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w600)),
//                             const SizedBox(height: 16),
//                             if (_method == 'regt' || _method == 'usdt')
//                               Column(
//                                 crossAxisAlignment: CrossAxisAlignment.start,
//                                 children: [
//                                   Text(withdrawalMethods.firstWhere((m) => m['id'] == _method)['description'] as String, style: const TextStyle(color: Color(0xff808080), fontSize: 12)),
//                                   const SizedBox(height: 16),
//                                   TextField(
//                                     controller: _walletAddressController,
//                                     decoration: InputDecoration(
//                                       labelText: 'Wallet Address',
//                                       labelStyle: const TextStyle(color: Color(0xff808080)),
//                                       border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
//                                     ),
//                                     style: const TextStyle(color: Colors.white),
//                                   ),
//                                 ],
//                               )
//                             else
//                               Column(
//                                 children: [
//                                   TextField(
//                                     controller: _nameController,
//                                     decoration: InputDecoration(
//                                       labelText: 'Name',
//                                       labelStyle: const TextStyle(color: Color(0xff808080)),
//                                       border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
//                                     ),
//                                     style: const TextStyle(color: Colors.white),
//                                   ),
//                                   const SizedBox(height: 8),
//                                   TextField(
//                                     controller: _bankNameController,
//                                     decoration: InputDecoration(
//                                       labelText: 'Bank Name',
//                                       labelStyle: const TextStyle(color: Color(0xff808080)),
//                                       border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
//                                     ),
//                                     style: const TextStyle(color: Colors.white),
//                                   ),
//                                   const SizedBox(height: 8),
//                                   TextField(
//                                     controller: _countryController,
//                                     decoration: InputDecoration(
//                                       labelText: 'Country',
//                                       labelStyle: const TextStyle(color: Color(0xff808080)),
//                                       border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
//                                     ),
//                                     style: const TextStyle(color: Colors.white),
//                                   ),
//                                   const SizedBox(height: 8),
//                                   TextField(
//                                     controller: _swiftController,
//                                     decoration: InputDecoration(
//                                       labelText: 'SWIFT',
//                                       labelStyle: const TextStyle(color: Color(0xff808080)),
//                                       border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
//                                     ),
//                                     style: const TextStyle(color: Colors.white),
//                                   ),
//                                   const SizedBox(height: 8),
//                                   TextField(
//                                     controller: _ibanController,
//                                     decoration: InputDecoration(
//                                       labelText: 'IBAN',
//                                       labelStyle: const TextStyle(color: Color(0xff808080)),
//                                       border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
//                                     ),
//                                     style: const TextStyle(color: Colors.white),
//                                   ),
//                                 ],
//                               ),
//                           ],
//                         )
//                       : Column(
//                           crossAxisAlignment: CrossAxisAlignment.start,
//                           children: [
//                             const Text('Review Withdrawal', style: TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w600)),
//                             const SizedBox(height: 16),
//                             Container(
//                               padding: const EdgeInsets.all(16),
//                               decoration: BoxDecoration(
//                                 color: const Color(0xff1a1a1a),
//                                 borderRadius: BorderRadius.circular(12),
//                                 border: Border.all(color: const Color(0xff808080)),
//                               ),
//                               child: Column(
//                                 crossAxisAlignment: CrossAxisAlignment.start,
//                                 children: [
//                                   Row(
//                                     mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                                     children: [
//                                       const Text('Amount', style: TextStyle(color: Color(0xff808080))),
//                                       Text('${_amountController.text} REGT', style: const TextStyle(color: Colors.white)),
//                                     ],
//                                   ),
//                                   const SizedBox(height: 8),
//                                   Row(
//                                     mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                                     children: [
//                                       const Text('Method', style: TextStyle(color: Color(0xff808080))),
//                                       Text((withdrawalMethods.firstWhere((m) => m['id'] == _method)['label'] as String), style: const TextStyle(color: Colors.white)),
//                                     ],
//                                   ),
//                                   const SizedBox(height: 8),
//                                   if (_method != 'bank')
//                                     Row(
//                                       mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                                       children: [
//                                         const Text('Address', style: TextStyle(color: Color(0xff808080))),
//                                         Row(
//                                           children: [
//                                             Text(
//                                               '${_walletAddressController.text.substring(0, 10)}...${_walletAddressController.text.substring(_walletAddressController.text.length - 6)}',
//                                               style: const TextStyle(color: Colors.white),
//                                             ),
//                                             IconButton(
//                                               onPressed: () => _copyToClipboard(_walletAddressController.text),
//                                               icon: const Icon(Icons.copy, size: 16, color: Color(0xff808080)),
//                                             ),
//                                           ],
//                                         ),
//                                       ],
//                                     )
//                                   else
//                                     Column(
//                                       crossAxisAlignment: CrossAxisAlignment.start,
//                                       children: [
//                                         Row(
//                                           mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                                           children: [
//                                             const Text('Name', style: TextStyle(color: Color(0xff808080))),
//                                             Text(_nameController.text, style: const TextStyle(color: Colors.white)),
//                                           ],
//                                         ),
//                                         const SizedBox(height: 8),
//                                         Row(
//                                           mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                                           children: [
//                                             const Text('Bank Name', style: TextStyle(color: Color(0xff808080))),
//                                             Text(_bankNameController.text, style: const TextStyle(color: Colors.white)),
//                                           ],
//                                         ),
//                                         const SizedBox(height: 8),
//                                         Row(
//                                           mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                                           children: [
//                                             const Text('Country', style: TextStyle(color: Color(0xff808080))),
//                                             Text(_countryController.text, style: const TextStyle(color: Colors.white)),
//                                           ],
//                                         ),
//                                         const SizedBox(height: 8),
//                                         Row(
//                                           mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                                           children: [
//                                             const Text('SWIFT', style: TextStyle(color: Color(0xff808080))),
//                                             Text(_swiftController.text, style: const TextStyle(color: Colors.white)),
//                                           ],
//                                         ),
//                                         const SizedBox(height: 8),
//                                         Row(
//                                           mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                                           children: [
//                                             const Text('IBAN', style: TextStyle(color: Color(0xff808080))),
//                                             Text(_ibanController.text, style: const TextStyle(color: Colors.white)),
//                                           ],
//                                         ),
//                                       ],
//                                     ),
//                                 ],
//                               ),
//                             ),
//                           ],
//                         ),
//             ),
//           ),
//           Padding(
//             padding: const EdgeInsets.all(16.0),
//             child: Row(
//               children: [
//                 if (_currentStep > 1)
//                   Expanded(
//                     child: OutlinedButton(
//                       onPressed: () => setState(() => _currentStep--),
//                       style: OutlinedButton.styleFrom(
//                         side: const BorderSide(color: Color(0xff808080)),
//                         foregroundColor: Color(0xff808080),
//                       ),
//                       child: const Text('Back'),
//                     ),
//                   ),
//                 if (_currentStep > 1) const SizedBox(width: 8),
//                 Expanded(
//                   child: ElevatedButton(
//                     onPressed: _loading ? null : (_currentStep == 3 ? _submitWithdrawal : _handleNext),
//                     style: ElevatedButton.styleFrom(
//                       backgroundColor: const Color(0xffFFD700),
//                       foregroundColor: Colors.black,
//                     ),
//                     child: _loading ? const CircularProgressIndicator(color: Colors.black) : Text(_currentStep == 3 ? 'Submit Withdrawal' : 'Continue'),
//                   ),
//                 ),
//               ],
//             ),
//           ),
//           if (_pendingRequests.isNotEmpty)
//             Container(
//               padding: const EdgeInsets.all(16),
//               decoration: const BoxDecoration(
//                 border: Border(top: BorderSide(color: Color(0xff808080))),
//               ),
//               child: Column(
//                 crossAxisAlignment: CrossAxisAlignment.start,
//                 children: [
//                   const Text('Pending Withdrawals', style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.w600)),
//                   const SizedBox(height: 8),
//                   ..._pendingRequests.map((request) => Container(
//                         margin: const EdgeInsets.only(bottom: 8),
//                         padding: const EdgeInsets.all(16),
//                         decoration: BoxDecoration(
//                           color: const Color(0xff1a1a1a),
//                           borderRadius: BorderRadius.circular(12),
//                           border: Border.all(color: const Color(0xff808080)),
//                         ),
//                         child: Row(
//                           mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                           children: [
//                             Column(
//                               crossAxisAlignment: CrossAxisAlignment.start,
//                               children: [
//                                 Text('${request['amount']} REGT', style: const TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.w500)),
//                                 Text(request['method'], style: const TextStyle(color: Color(0xff808080), fontSize: 12)),
//                               ],
//                             ),
//                             Column(
//                               crossAxisAlignment: CrossAxisAlignment.end,
//                               children: [
//                                 Text(request['status'].toString().capitalize(), style: TextStyle(color: _getStatusColor(request['status']), fontSize: 12, fontWeight: FontWeight.w500)),
//                                 Text(DateFormat('MMM d, yyyy').format(DateTime.parse(request['created_at'])), style: const TextStyle(color: Color(0xff808080), fontSize: 10)),
//                               ],
//                             ),
//                           ],
//                         ),
//                       )),
//                 ],
//               ),
//             ),
//         ],
//       ),
//     );
//   }
// }

// extension StringExtension on String {
//   String capitalize() {
//     return "${this[0].toUpperCase()}${substring(1)}";
//   }
// }











// import 'dart:convert';

// import 'package:flutter/material.dart';
// import 'package:flutter/services.dart';
// import 'package:supabase_flutter/supabase_flutter.dart';
// import 'package:intl/intl.dart';

// class WithdrawalScreen extends StatefulWidget {
//   const WithdrawalScreen({super.key});

//   @override
//   State<WithdrawalScreen> createState() => _WithdrawalScreenState();
// }

// class _WithdrawalScreenState extends State<WithdrawalScreen> {
//   final _amountController = TextEditingController();
//   String _method = '';
//   final _walletAddressController = TextEditingController();
//   final _nameController = TextEditingController();
//   final _bankNameController = TextEditingController();
//   final _countryController = TextEditingController();
//   final _swiftController = TextEditingController();
//   final _ibanController = TextEditingController();
//   int _currentStep = 1;
//   bool _loading = false;
//   bool _showSuccess = false;
//   List<Map<String, dynamic>> _pendingRequests = [];
//   double _balance = 0.0; // Placeholder, fetch if needed

//   final minWithdrawal = 100.0;
//   final withdrawalMethods = [
//     {'id': 'regt', 'label': 'REGT', 'description': 'crypto-currency wallet __metamask, Trust wallet, etc. (bnb smart chain)', 'icon': Icons.account_balance_wallet, 'fee': '0 REGT', 'time': '24-48 hours'},
//     {'id': 'usdt', 'label': 'USDT', 'description': 'crypto-currency wallet __ (bnb smart chain)', 'icon': Icons.credit_card, 'fee': '2 USDT', 'time': '1-6 hours'},
//     {'id': 'bank', 'label': 'bank transfer', 'description': 'name, bank name, country, swift, IBAN', 'icon': Icons.account_balance, 'fee': '5 USD', 'time': '3-5 days'},
//   ];

//   @override
//   void initState() {
//     super.initState();
//     _loadBalance();
//     _loadPending();
//   }

//   Future<void> _loadBalance() async {
//     final userId = Supabase.instance.client.auth.currentUser?.id;
//     if (userId == null) return;
//     try {
//       final data = await Supabase.instance.client.from('profiles').select('balancing').eq('id', userId).maybeSingle();
//       setState(() => _balance = (data?['balancing'] as double?) ?? 0.0);
//     } catch (e) {
//       debugPrint('Error loading balance: $e');
//     }
//   }

//   Future<void> _loadPending() async {
//     final userId = Supabase.instance.client.auth.currentUser?.id;
//     if (userId == null) return;
//     try {
//       final data = await Supabase.instance.client.from('withdraw_requests').select().eq('user_id', userId).order('created_at', ascending: false);
//       setState(() => _pendingRequests = data);
//     } catch (e) {
//       debugPrint('Error loading pending requests: $e');
//     }
//   }

//   bool _validateStep1() {
//     final amount = double.tryParse(_amountController.text);
//     if (amount == null || amount < minWithdrawal) {
//       ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Minimum withdrawal amount is $minWithdrawal REGT')));
//       return false;
//     }
//     if (amount > _balance) {
//       ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Insufficient balance')));
//       return false;
//     }
//     if (_method.isEmpty) {
//       ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Please select a withdrawal method')));
//       return false;
//     }
//     return true;
//   }

//   bool _validateStep2() {
//     if (_method == 'regt' || _method == 'usdt') {
//       if (_walletAddressController.text.trim().isEmpty) {
//         ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Please enter your wallet address')));
//         return false;
//       }
//     } else if (_method == 'bank') {
//       if (_nameController.text.trim().isEmpty ||
//           _bankNameController.text.trim().isEmpty ||
//           _countryController.text.trim().isEmpty ||
//           _swiftController.text.trim().isEmpty ||
//           _ibanController.text.trim().isEmpty) {
//         ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Please fill in all bank details')));
//         return false;
//       }
//     }
//     return true;
//   }

//   void _handleNext() {
//     if (_currentStep == 1 && _validateStep1()) {
//       setState(() => _currentStep = 2);
//     } else if (_currentStep == 2 && _validateStep2()) {
//       setState(() => _currentStep = 3);
//     }
//   }

//   Future<void> _submitWithdrawal() async {
//     setState(() => _loading = true);
//     final userId = Supabase.instance.client.auth.currentUser?.id;
//     final amount = double.tryParse(_amountController.text);
//     if (userId == null || amount == null || amount < minWithdrawal) {
//       setState(() => _loading = false);
//       ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Invalid amount (min 100 REGT)')));
//       return;
//     }

//     Map<String, dynamic> details;
//     if (_method == 'bank') {
//       details = {
//         'name': _nameController.text,
//         'bankName': _bankNameController.text,
//         'country': _countryController.text,
//         'swift': _swiftController.text,
//         'iban': _ibanController.text,
//       };
//     } else {
//       details = {'walletAddress': _walletAddressController.text};
//     }

//     try {
//       await Supabase.instance.client.from('withdraw_requests').insert({
//         'user_id': userId,
//         'amount': amount,
//         'method': _method.toUpperCase(),
//         'details': details,
//         'status': 'pending',
//       });
//       await _loadPending();
//       setState(() {
//         _loading = false;
//         _showSuccess = true;
//       });
//       ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Withdrawal requested. Admin will review.')));
//     } catch (e) {
//       debugPrint('Insertion error: $e');
//       ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Error submitting request: $e')));
//       setState(() => _loading = false);
//     }
//   }

//   void _copyToClipboard(String text) {
//     Clipboard.setData(ClipboardData(text: text));
//     ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Copied to clipboard!')));
//   }

//   Color _getStatusColor(String status) {
//     switch (status) {
//       case 'pending':
//         return Colors.amber;
//       case 'processing':
//         return Colors.blue;
//       case 'completed':
//         return Colors.green;
//       case 'failed':
//         return Colors.red;
//       default:
//         return Colors.grey;
//     }
//   }

//   @override
//   Widget build(BuildContext context) {
//     if (_showSuccess) {
//       return Scaffold(
//         backgroundColor: Colors.black,
//         body: Center(
//           child: Column(
//             mainAxisAlignment: MainAxisAlignment.center,
//             children: [
//               const Icon(Icons.check_circle, size: 80, color: Colors.green),
//               const SizedBox(height: 16),
//               const Text('Withdrawal Submitted!', style: TextStyle(color: Colors.white, fontSize: 24, fontWeight: FontWeight.bold)),
//               const SizedBox(height: 8),
//               const Text('Your withdrawal request has been submitted successfully. You\'ll receive a confirmation email shortly.',
//                   style: TextStyle(color: Color(0xff808080), fontSize: 16), textAlign: TextAlign.center),
//               const SizedBox(height: 24),
//               ElevatedButton(
//                 onPressed: () {
//                   setState(() {
//                     _showSuccess = false;
//                     _currentStep = 1;
//                     _amountController.clear();
//                     _method = '';
//                     _walletAddressController.clear();
//                     _nameController.clear();
//                     _bankNameController.clear();
//                     _countryController.clear();
//                     _swiftController.clear();
//                     _ibanController.clear();
//                   });
//                 },
//                 style: ElevatedButton.styleFrom(
//                   backgroundColor: const Color(0xffFFD700),
//                   foregroundColor: Colors.black,
//                 ),
//                 child: const Text('Make Another Withdrawal'),
//               ),
//             ],
//           ),
//         ),
//       );
//     }

//     return Scaffold(
//       backgroundColor: Colors.black,
//       body: Column(
//         children: [
//           // Header
//           Container(
//             padding: const EdgeInsets.all(16),
//             decoration: const BoxDecoration(
//               color: Color(0xff1a1a1a),
//               border: Border(bottom: BorderSide(color: Color(0xff808080))),
//             ),
//             child: Column(
//               crossAxisAlignment: CrossAxisAlignment.start,
//               children: [
//                 const Text('Withdraw Funds', style: TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w600)),
//                 const SizedBox(height: 16),
//                 Row(
//                   mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                   children: [
//                     ...List.generate(3, (index) {
//                       final step = index + 1;
//                       return Expanded(
//                         child: Row(
//                           children: [
//                             Container(
//                               width: 32,
//                               height: 32,
//                               decoration: BoxDecoration(
//                                 shape: BoxShape.circle,
//                                 color: step <= _currentStep ? const Color(0xffFFD700) : const Color(0xff2a2a2a),
//                               ),
//                               child: Center(
//                                 child: step < _currentStep
//                                     ? const Icon(Icons.check, size: 16, color: Colors.black)
//                                     : Text(step.toString(), style: TextStyle(color: step <= _currentStep ? Colors.black : const Color(0xff808080))),
//                               ),
//                             ),
//                             if (index < 2) const Expanded(child: Divider(color: Color(0xff808080), thickness: 1)),
//                           ],
//                         ),
//                       );
//                     }),
//                   ],
//                 ),
//                 const SizedBox(height: 8),
//                 Text(
//                   'Step $_currentStep: ${_currentStep == 1 ? 'Amount & Method' : _currentStep == 2 ? 'Payment Details' : 'Review & Confirm'}',
//                   style: const TextStyle(color: Color(0xff808080), fontSize: 12),
//                 ),
//               ],
//             ),
//           ),
//           Expanded(
//             child: Padding(
//               padding: const EdgeInsets.all(16.0),
//               child: _currentStep == 1
//                   ? Column(
//                       crossAxisAlignment: CrossAxisAlignment.start,
//                       children: [
//                         Container(
//                           padding: const EdgeInsets.all(16),
//                           decoration: BoxDecoration(
//                             color: const Color(0xff1a1a1a),
//                             borderRadius: BorderRadius.circular(12),
//                             border: Border.all(color: const Color(0xff808080)),
//                           ),
//                           child: Column(
//                             crossAxisAlignment: CrossAxisAlignment.start,
//                             children: [
//                               const Text('Available Balance', style: TextStyle(color: Color(0xff808080), fontSize: 12)),
//                               Text('$_balance REGT', style: const TextStyle(color: Colors.white, fontSize: 24, fontWeight: FontWeight.bold)),
//                             ],
//                           ),
//                         ),
//                         const SizedBox(height: 16),
//                         TextField(
//                           controller: _amountController,
//                           keyboardType: TextInputType.number,
//                           decoration: InputDecoration(
//                             labelText: 'Withdrawal Amount',
//                             labelStyle: const TextStyle(color: Color(0xff808080)),
//                             hintText: 'Minimum $minWithdrawal REGT',
//                             hintStyle: const TextStyle(color: Color(0xff808080)),
//                             border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
//                           ),
//                           style: const TextStyle(color: Colors.white),
//                         ),
//                         const SizedBox(height: 16),
//                         const Text('Withdrawal Method', style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.w500)),
//                         const SizedBox(height: 8),
//                         ...withdrawalMethods.map((m) => GestureDetector(
//                               onTap: () => setState(() => _method = m['id'] as String),
//                               child: Container(
//                                 margin: const EdgeInsets.only(bottom: 8),
//                                 padding: const EdgeInsets.all(16),
//                                 decoration: BoxDecoration(
//                                   color: _method == (m['id'] as String) ? const Color(0xffFFD700).withOpacity(0.1) : const Color(0xff1a1a1a),
//                                   borderRadius: BorderRadius.circular(12),
//                                   border: Border.all(color: _method == (m['id'] as String) ? const Color(0xffFFD700) : const Color(0xff808080)),
//                                 ),
//                                 child: Row(
//                                   children: [
//                                     Icon(m['icon'] as IconData, color: const Color(0xffFFD700)),
//                                     const SizedBox(width: 12),
//                                     Expanded(
//                                       child: Column(
//                                         crossAxisAlignment: CrossAxisAlignment.start,
//                                         children: [
//                                           Text(m['label'] as String, style: const TextStyle(color: Colors.white, fontSize: 16)),
//                                           Text((m['description'] as String?) ?? '', style: const TextStyle(color: Color(0xff808080), fontSize: 12)),
//                                           Text('Fee: ${(m['fee'] as String?) ?? ''}  Time: ${(m['time'] as String?) ?? ''}', style: const TextStyle(color: Color(0xff808080), fontSize: 12)),
//                                         ],
//                                       ),
//                                     ),
//                                     if (_method == (m['id'] as String)) const Icon(Icons.check_circle, color: Color(0xffFFD700)),
//                                   ],
//                                 ),
//                               ),
//                             )),
//                       ],
//                     )
//                   : _currentStep == 2
//                       ? Column(
//                           crossAxisAlignment: CrossAxisAlignment.start,
//                           children: [
//                             const Text('Payment Details', style: TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w600)),
//                             const SizedBox(height: 16),
//                             if (_method == 'regt' || _method == 'usdt')
//                               Column(
//                                 crossAxisAlignment: CrossAxisAlignment.start,
//                                 children: [
//                                   Text((withdrawalMethods.firstWhere((m) => m['id'] == _method)['description'] as String?) ?? '', style: const TextStyle(color: Color(0xff808080), fontSize: 12)),
//                                   const SizedBox(height: 16),
//                                   TextField(
//                                     controller: _walletAddressController,
//                                     decoration: InputDecoration(
//                                       labelText: 'Wallet Address',
//                                       labelStyle: const TextStyle(color: Color(0xff808080)),
//                                       border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
//                                     ),
//                                     style: const TextStyle(color: Colors.white),
//                                   ),
//                                 ],
//                               )
//                             else
//                               Column(
//                                 children: [
//                                   TextField(
//                                     controller: _nameController,
//                                     decoration: InputDecoration(
//                                       labelText: 'Name',
//                                       labelStyle: const TextStyle(color: Color(0xff808080)),
//                                       border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
//                                     ),
//                                     style: const TextStyle(color: Colors.white),
//                                   ),
//                                   const SizedBox(height: 8),
//                                   TextField(
//                                     controller: _bankNameController,
//                                     decoration: InputDecoration(
//                                       labelText: 'Bank Name',
//                                       labelStyle: const TextStyle(color: Color(0xff808080)),
//                                       border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
//                                     ),
//                                     style: const TextStyle(color: Colors.white),
//                                   ),
//                                   const SizedBox(height: 8),
//                                   TextField(
//                                     controller: _countryController,
//                                     decoration: InputDecoration(
//                                       labelText: 'Country',
//                                       labelStyle: const TextStyle(color: Color(0xff808080)),
//                                       border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
//                                     ),
//                                     style: const TextStyle(color: Colors.white),
//                                   ),
//                                   const SizedBox(height: 8),
//                                   TextField(
//                                     controller: _swiftController,
//                                     decoration: InputDecoration(
//                                       labelText: 'SWIFT',
//                                       labelStyle: const TextStyle(color: Color(0xff808080)),
//                                       border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
//                                     ),
//                                     style: const TextStyle(color: Colors.white),
//                                   ),
//                                   const SizedBox(height: 8),
//                                   TextField(
//                                     controller: _ibanController,
//                                     decoration: InputDecoration(
//                                       labelText: 'IBAN',
//                                       labelStyle: const TextStyle(color: Color(0xff808080)),
//                                       border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
//                                     ),
//                                     style: const TextStyle(color: Colors.white),
//                                   ),
//                                 ],
//                               ),
//                           ],
//                         )
//                   : Column(
//                           crossAxisAlignment: CrossAxisAlignment.start,
//                           children: [
//                             const Text('Review Withdrawal', style: TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w600)),
//                             const SizedBox(height: 16),
//                             Container(
//                               padding: const EdgeInsets.all(16),
//                               decoration: BoxDecoration(
//                                 color: const Color(0xff1a1a1a),
//                                 borderRadius: BorderRadius.circular(12),
//                                 border: Border.all(color: const Color(0xff808080)),
//                               ),
//                               child: Column(
//                                 crossAxisAlignment: CrossAxisAlignment.start,
//                                 children: [
//                                   Row(
//                                     mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                                     children: [
//                                       const Text('Amount', style: TextStyle(color: Color(0xff808080))),
//                                       Text('${_amountController.text} REGT', style: const TextStyle(color: Colors.white)),
//                                     ],
//                                   ),
//                                   const SizedBox(height: 8),
//                                   Row(
//                                     mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                                     children: [
//                                       const Text('Method', style: TextStyle(color: Color(0xff808080))),
//                                       Text((withdrawalMethods.firstWhere((m) => m['id'] == _method)['label']?.toString() ?? ''), style: const TextStyle(color: Colors.white)),
//                                     ],
//                                   ),
//                                   const SizedBox(height: 8),
//                                   if (_method != 'bank')
//                                     Row(
//                                       mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                                       children: [
//                                         const Text('Address', style: TextStyle(color: Color(0xff808080))),
//                                         Row(
//                                           children: [
//                                             Text(
//                                               '${_walletAddressController.text.substring(0, 10)}...${_walletAddressController.text.substring(_walletAddressController.text.length - 6)}',
//                                               style: const TextStyle(color: Colors.white),
//                                             ),
//                                             IconButton(
//                                               onPressed: () => _copyToClipboard(_walletAddressController.text),
//                                               icon: const Icon(Icons.copy, size: 16, color: Color(0xff808080)),
//                                             ),
//                                           ],
//                                         ),
//                                       ],
//                                     )
//                                   else
//                                     Column(
//                                       crossAxisAlignment: CrossAxisAlignment.start,
//                                       children: [
//                                         Row(
//                                           mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                                           children: [
//                                             const Text('Name', style: TextStyle(color: Color(0xff808080))),
//                                             Text(_nameController.text, style: const TextStyle(color: Colors.white)),
//                                           ],
//                                         ),
//                                         const SizedBox(height: 8),
//                                         Row(
//                                           mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                                           children: [
//                                             const Text('Bank Name', style: TextStyle(color: Color(0xff808080))),
//                                             Text(_bankNameController.text, style: const TextStyle(color: Colors.white)),
//                                           ],
//                                         ),
//                                         const SizedBox(height: 8),
//                                         Row(
//                                           mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                                           children: [
//                                             const Text('Country', style: TextStyle(color: Color(0xff808080))),
//                                             Text(_countryController.text, style: const TextStyle(color: Colors.white)),
//                                           ],
//                                         ),
//                                         const SizedBox(height: 8),
//                                         Row(
//                                           mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                                           children: [
//                                             const Text('SWIFT', style: TextStyle(color: Color(0xff808080))),
//                                             Text(_swiftController.text, style: const TextStyle(color: Colors.white)),
//                                           ],
//                                         ),
//                                         const SizedBox(height: 8),
//                                         Row(
//                                           mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                                           children: [
//                                             const Text('IBAN', style: TextStyle(color: Color(0xff808080))),
//                                             Text(_ibanController.text, style: const TextStyle(color: Colors.white)),
//                                           ],
//                                         ),
//                                       ],
//                                     ),
//                                 ],
//                               ),
//                             ),
//                           ],
//                         ),
//             ),
//           ),
//           Padding(
//             padding: const EdgeInsets.all(16.0),
//             child: Row(
//               children: [
//                 if (_currentStep > 1)
//                   Expanded(
//                     child: OutlinedButton(
//                       onPressed: () => setState(() => _currentStep--),
//                       style: OutlinedButton.styleFrom(
//                         side: const BorderSide(color: Color(0xff808080)),
//                         foregroundColor: Color(0xff808080),
//                       ),
//                       child: const Text('Back'),
//                     ),
//                   ),
//                 if (_currentStep > 1) const SizedBox(width: 8),
//                 Expanded(
//                   child: ElevatedButton(
//                     onPressed: _loading ? null : (_currentStep == 3 ? _submitWithdrawal : _handleNext),
//                     style: ElevatedButton.styleFrom(
//                       backgroundColor: const Color(0xffFFD700),
//                       foregroundColor: Colors.black,
//                     ),
//                     child: _loading ? const CircularProgressIndicator(color: Colors.black) : Text(_currentStep == 3 ? 'Submit Withdrawal' : 'Continue'),
//                   ),
//                 ),
//               ],
//             ),
//           ),
//           if (_pendingRequests.isNotEmpty)
//             Container(
//               padding: const EdgeInsets.all(16),
//               decoration: const BoxDecoration(
//                 border: Border(top: BorderSide(color: Color(0xff808080))),
//               ),
//               child: Column(
//                 crossAxisAlignment: CrossAxisAlignment.start,
//                 children: [
//                   const Text('Pending Withdrawals', style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.w600)),
//                   const SizedBox(height: 8),
//                   ..._pendingRequests.map((request) => Container(
//                         margin: const EdgeInsets.only(bottom: 8),
//                         padding: const EdgeInsets.all(16),
//                         decoration: BoxDecoration(
//                           color: const Color(0xff1a1a1a),
//                           borderRadius: BorderRadius.circular(12),
//                           border: Border.all(color: const Color(0xff808080)),
//                         ),
//                         child: Row(
//                           mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                           children: [
//                             Column(
//                               crossAxisAlignment: CrossAxisAlignment.start,
//                               children: [
//                                 Text('${request['amount']} REGT', style: const TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.w500)),
//                                 Text(request['method'], style: const TextStyle(color: Color(0xff808080), fontSize: 12)),
//                               ],
//                             ),
//                             Column(
//                               crossAxisAlignment: CrossAxisAlignment.end,
//                               children: [
//                                 Text(request['status'].toString().capitalize(), style: TextStyle(color: _getStatusColor(request['status']), fontSize: 12, fontWeight: FontWeight.w500)),
//                                 Text(DateFormat('MMM d, yyyy').format(DateTime.parse(request['created_at'])), style: const TextStyle(color: Color(0xff808080), fontSize: 10)),
//                               ],
//                             ),
//                           ],
//                         ),
//                       )),
//                 ],
//               ),
//             ),
//         ],
//       ),
//     );
//   }
// }

// extension StringExtension on String {
//   String capitalize() {
//     return "${this[0].toUpperCase()}${substring(1)}";
//   }
// }











import 'dart:convert';

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:intl/intl.dart';

class WithdrawalScreen extends StatefulWidget {
  const WithdrawalScreen({super.key});

  @override
  State<WithdrawalScreen> createState() => _WithdrawalScreenState();
}

class _WithdrawalScreenState extends State<WithdrawalScreen> {
  final _amountController = TextEditingController();
  String _method = '';
  final _walletAddressController = TextEditingController();
  final _nameController = TextEditingController();
  final _bankNameController = TextEditingController();
  final _countryController = TextEditingController();
  final _swiftController = TextEditingController();
  final _ibanController = TextEditingController();
  int _currentStep = 1;
  bool _loading = false;
  bool _showSuccess = false;
  List<Map<String, dynamic>> _pendingRequests = [];
  double _balance = 0.0; // Placeholder, fetch if needed

  final minWithdrawal = 100.0;
  final withdrawalMethods = [
    {'id': 'regt', 'label': 'REGT', 'description': 'crypto-currency wallet __metamask, Trust wallet, etc. (bnb smart chain)', 'icon': Icons.account_balance_wallet, 'fee': '0 REGT', 'time': '24-48 hours'},
    {'id': 'usdt', 'label': 'USDT', 'description': 'crypto-currency wallet __ (bnb smart chain)', 'icon': Icons.credit_card, 'fee': '2 USDT', 'time': '1-6 hours'},
    {'id': 'bank', 'label': 'bank transfer', 'description': 'name, bank name, country, swift, IBAN', 'icon': Icons.account_balance, 'fee': '5 USD', 'time': '3-5 days'},
  ];

  @override
  void initState() {
    super.initState();
    _loadBalance();
    _loadPending();
  }

  Future<void> _loadBalance() async {
    final userId = Supabase.instance.client.auth.currentUser?.id;
    if (userId == null) return;
    try {
      final data = await Supabase.instance.client.from('profiles').select('balancing').eq('id', userId).maybeSingle();
      setState(() => _balance = (data?['balancing'] as double?) ?? 0.0);
    } catch (e) {
      debugPrint('Error loading balance: $e');
    }
  }

  Future<void> _loadPending() async {
    final userId = Supabase.instance.client.auth.currentUser?.id;
    if (userId == null) return;
    try {
      final data = await Supabase.instance.client.from('withdraw_requests').select().eq('user_id', userId).order('created_at', ascending: false);
      setState(() => _pendingRequests = data);
    } catch (e) {
      debugPrint('Error loading pending requests: $e');
    }
  }

  bool _validateStep1() {
    final amount = double.tryParse(_amountController.text);
    if (amount == null || amount < minWithdrawal) {
      ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Minimum withdrawal amount is $minWithdrawal REGT')));
      return false;
    }
    if (amount > _balance) {
      ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Insufficient balance')));
      return false;
    }
    if (_method.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Please select a withdrawal method')));
      return false;
    }
    return true;
  }

  bool _validateStep2() {
    if (_method == 'regt' || _method == 'usdt') {
      if (_walletAddressController.text.trim().isEmpty) {
        ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Please enter your wallet address')));
        return false;
      }
    } else if (_method == 'bank') {
      if (_nameController.text.trim().isEmpty ||
          _bankNameController.text.trim().isEmpty ||
          _countryController.text.trim().isEmpty ||
          _swiftController.text.trim().isEmpty ||
          _ibanController.text.trim().isEmpty) {
        ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Please fill in all bank details')));
        return false;
      }
    }
    return true;
  }

  void _handleNext() {
    if (_currentStep == 1 && _validateStep1()) {
      setState(() => _currentStep = 2);
    } else if (_currentStep == 2 && _validateStep2()) {
      setState(() => _currentStep = 3);
    }
  }

  Future<void> _submitWithdrawal() async {
    setState(() => _loading = true);
    final userId = Supabase.instance.client.auth.currentUser?.id;
    final amount = double.tryParse(_amountController.text);
    if (userId == null || amount == null || amount < minWithdrawal) {
      setState(() => _loading = false);
      ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Invalid amount (min 100 REGT)')));
      return;
    }

    Map<String, dynamic> details;
    if (_method == 'bank') {
      details = {
        'name': _nameController.text,
        'bankName': _bankNameController.text,
        'country': _countryController.text,
        'swift': _swiftController.text,
        'iban': _ibanController.text,
      };
    } else {
      details = {'walletAddress': _walletAddressController.text};
    }

    try {
      await Supabase.instance.client.from('withdraw_requests').insert({
        'user_id': userId,
        'amount': amount,
        'method': _method.toUpperCase(),
        'details': details,
        'status': 'pending',
        'request_date': DateTime.now().toIso8601String(),
      });
      await _loadPending();
      setState(() {
        _loading = false;
        _showSuccess = true;
      });
      ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Withdrawal requested. Admin will review.')));
    } catch (e) {
      debugPrint('Insertion error: $e');
      ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Error submitting request: $e')));
      setState(() => _loading = false);
    }
  }

  void _copyToClipboard(String text) {
    Clipboard.setData(ClipboardData(text: text));
    ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Copied to clipboard!')));
  }

  Color _getStatusColor(String status) {
    switch (status) {
      case 'pending':
        return Colors.amber;
      case 'processing':
        return Colors.blue;
      case 'completed':
        return Colors.green;
      case 'failed':
        return Colors.red;
      default:
        return Colors.grey;
    }
  }

  @override
  Widget build(BuildContext context) {
    if (_showSuccess) {
      return Scaffold(
        backgroundColor: Colors.black,
        body: Center(
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              const Icon(Icons.check_circle, size: 80, color: Colors.green),
              const SizedBox(height: 16),
              const Text('Withdrawal Submitted!', style: TextStyle(color: Colors.white, fontSize: 24, fontWeight: FontWeight.bold)),
              const SizedBox(height: 8),
              const Text('Your withdrawal request has been submitted successfully. You\'ll receive a confirmation email shortly.',
                  style: TextStyle(color: Color(0xff808080), fontSize: 16), textAlign: TextAlign.center),
              const SizedBox(height: 24),
              ElevatedButton(
                onPressed: () {
                  setState(() {
                    _showSuccess = false;
                    _currentStep = 1;
                    _amountController.clear();
                    _method = '';
                    _walletAddressController.clear();
                    _nameController.clear();
                    _bankNameController.clear();
                    _countryController.clear();
                    _swiftController.clear();
                    _ibanController.clear();
                  });
                },
                style: ElevatedButton.styleFrom(
                  backgroundColor: const Color(0xffFFD700),
                  foregroundColor: Colors.black,
                ),
                child: const Text('Make Another Withdrawal'),
              ),
            ],
          ),
        ),
      );
    }

    return Scaffold(
      backgroundColor: Colors.black,
      body: Column(
        children: [
          // Header
          Container(
            padding: const EdgeInsets.all(16),
            decoration: const BoxDecoration(
              color: Color(0xff1a1a1a),
              border: Border(bottom: BorderSide(color: Color(0xff808080))),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text('Withdraw Funds', style: TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w600)),
                const SizedBox(height: 16),
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    ...List.generate(3, (index) {
                      final step = index + 1;
                      return Expanded(
                        child: Row(
                          children: [
                            Container(
                              width: 32,
                              height: 32,
                              decoration: BoxDecoration(
                                shape: BoxShape.circle,
                                color: step <= _currentStep ? const Color(0xffFFD700) : const Color(0xff2a2a2a),
                              ),
                              child: Center(
                                child: step < _currentStep
                                    ? const Icon(Icons.check, size: 16, color: Colors.black)
                                    : Text(step.toString(), style: TextStyle(color: step <= _currentStep ? Colors.black : const Color(0xff808080))),
                              ),
                            ),
                            if (index < 2) const Expanded(child: Divider(color: Color(0xff808080), thickness: 1)),
                          ],
                        ),
                      );
                    }),
                  ],
                ),
                const SizedBox(height: 8),
                Text(
                  'Step $_currentStep: ${_currentStep == 1 ? 'Amount & Method' : _currentStep == 2 ? 'Payment Details' : 'Review & Confirm'}',
                  style: const TextStyle(color: Color(0xff808080), fontSize: 12),
                ),
              ],
            ),
          ),
          Expanded(
            child: Padding(
              padding: const EdgeInsets.all(16.0),
              child: _currentStep == 1
                  ? Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Container(
                          padding: const EdgeInsets.all(16),
                          decoration: BoxDecoration(
                            color: const Color(0xff1a1a1a),
                            borderRadius: BorderRadius.circular(12),
                            border: Border.all(color: const Color(0xff808080)),
                          ),
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              const Text('Available Balance', style: TextStyle(color: Color(0xff808080), fontSize: 12)),
                              Text('$_balance REGT', style: const TextStyle(color: Colors.white, fontSize: 24, fontWeight: FontWeight.bold)),
                            ],
                          ),
                        ),
                        const SizedBox(height: 16),
                        TextField(
                          controller: _amountController,
                          keyboardType: TextInputType.number,
                          decoration: InputDecoration(
                            labelText: 'Withdrawal Amount',
                            labelStyle: const TextStyle(color: Color(0xff808080)),
                            hintText: 'Minimum $minWithdrawal REGT',
                            hintStyle: const TextStyle(color: Color(0xff808080)),
                            border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
                          ),
                          style: const TextStyle(color: Colors.white),
                        ),
                        const SizedBox(height: 16),
                        const Text('Withdrawal Method', style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.w500)),
                        const SizedBox(height: 8),
                        ...withdrawalMethods.map((m) => GestureDetector(
                              onTap: () => setState(() => _method = m['id'] as String),
                              child: Container(
                                margin: const EdgeInsets.only(bottom: 8),
                                padding: const EdgeInsets.all(16),
                                decoration: BoxDecoration(
                                  color: _method == (m['id'] as String) ? const Color(0xffFFD700).withOpacity(0.1) : const Color(0xff1a1a1a),
                                  borderRadius: BorderRadius.circular(12),
                                  border: Border.all(color: _method == (m['id'] as String) ? const Color(0xffFFD700) : const Color(0xff808080)),
                                ),
                                child: Row(
                                  children: [
                                    Icon(m['icon'] as IconData, color: const Color(0xffFFD700)),
                                    const SizedBox(width: 12),
                                    Expanded(
                                      child: Column(
                                        crossAxisAlignment: CrossAxisAlignment.start,
                                        children: [
                                          Text(m['label'] as String, style: const TextStyle(color: Colors.white, fontSize: 16)),
                                          Text((m['description'] as String?) ?? '', style: const TextStyle(color: Color(0xff808080), fontSize: 12)),
                                          Text('Fee: ${(m['fee'] as String?) ?? ''}  Time: ${(m['time'] as String?) ?? ''}', style: const TextStyle(color: Color(0xff808080), fontSize: 12)),
                                        ],
                                      ),
                                    ),
                                    if (_method == (m['id'] as String)) const Icon(Icons.check_circle, color: Color(0xffFFD700)),
                                  ],
                                ),
                              ),
                            )),
                      ],
                    )
                  : _currentStep == 2
                      ? Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            const Text('Payment Details', style: TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w600)),
                            const SizedBox(height: 16),
                            if (_method == 'regt' || _method == 'usdt')
                              Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Text((withdrawalMethods.firstWhere((m) => m['id'] == _method)['description'] as String?) ?? '', style: const TextStyle(color: Color(0xff808080), fontSize: 12)),
                                  const SizedBox(height: 16),
                                  TextField(
                                    controller: _walletAddressController,
                                    decoration: InputDecoration(
                                      labelText: 'Wallet Address',
                                      labelStyle: const TextStyle(color: Color(0xff808080)),
                                      border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
                                    ),
                                    style: const TextStyle(color: Colors.white),
                                  ),
                                ],
                              )
                            else
                              Column(
                                children: [
                                  TextField(
                                    controller: _nameController,
                                    decoration: InputDecoration(
                                      labelText: 'Name',
                                      labelStyle: const TextStyle(color: Color(0xff808080)),
                                      border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
                                    ),
                                    style: const TextStyle(color: Colors.white),
                                  ),
                                  const SizedBox(height: 8),
                                  TextField(
                                    controller: _bankNameController,
                                    decoration: InputDecoration(
                                      labelText: 'Bank Name',
                                      labelStyle: const TextStyle(color: Color(0xff808080)),
                                      border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
                                    ),
                                    style: const TextStyle(color: Colors.white),
                                  ),
                                  const SizedBox(height: 8),
                                  TextField(
                                    controller: _countryController,
                                    decoration: InputDecoration(
                                      labelText: 'Country',
                                      labelStyle: const TextStyle(color: Color(0xff808080)),
                                      border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
                                    ),
                                    style: const TextStyle(color: Colors.white),
                                  ),
                                  const SizedBox(height: 8),
                                  TextField(
                                    controller: _swiftController,
                                    decoration: InputDecoration(
                                      labelText: 'SWIFT',
                                      labelStyle: const TextStyle(color: Color(0xff808080)),
                                      border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
                                    ),
                                    style: const TextStyle(color: Colors.white),
                                  ),
                                  const SizedBox(height: 8),
                                  TextField(
                                    controller: _ibanController,
                                    decoration: InputDecoration(
                                      labelText: 'IBAN',
                                      labelStyle: const TextStyle(color: Color(0xff808080)),
                                      border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
                                    ),
                                    style: const TextStyle(color: Colors.white),
                                  ),
                                ],
                              ),
                          ],
                        )
                  : Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            const Text('Review Withdrawal', style: TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w600)),
                            const SizedBox(height: 16),
                            Container(
                              padding: const EdgeInsets.all(16),
                              decoration: BoxDecoration(
                                color: const Color(0xff1a1a1a),
                                borderRadius: BorderRadius.circular(12),
                                border: Border.all(color: const Color(0xff808080)),
                              ),
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Row(
                                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                                    children: [
                                      const Text('Amount', style: TextStyle(color: Color(0xff808080))),
                                      Text('${_amountController.text} REGT', style: const TextStyle(color: Colors.white)),
                                    ],
                                  ),
                                  const SizedBox(height: 8),
                                  Row(
                                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                                    children: [
                                      const Text('Method', style: TextStyle(color: Color(0xff808080))),
                                      Text((withdrawalMethods.firstWhere((m) => m['id'] == _method)['label']?.toString() ?? ''), style: const TextStyle(color: Colors.white)),
                                    ],
                                  ),
                                  const SizedBox(height: 8),
                                  if (_method != 'bank')
                                    Row(
                                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                                      children: [
                                        const Text('Address', style: TextStyle(color: Color(0xff808080))),
                                        Row(
                                          children: [
                                            Text(
                                              '${_walletAddressController.text.substring(0, 10)}...${_walletAddressController.text.substring(_walletAddressController.text.length - 6)}',
                                              style: const TextStyle(color: Colors.white),
                                            ),
                                            IconButton(
                                              onPressed: () => _copyToClipboard(_walletAddressController.text),
                                              icon: const Icon(Icons.copy, size: 16, color: Color(0xff808080)),
                                            ),
                                          ],
                                        ),
                                      ],
                                    )
                                  else
                                    Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: [
                                        Row(
                                          mainAxisAlignment: MainAxisAlignment.spaceBetween,
                                          children: [
                                            const Text('Name', style: TextStyle(color: Color(0xff808080))),
                                            Text(_nameController.text, style: const TextStyle(color: Colors.white)),
                                          ],
                                        ),
                                        const SizedBox(height: 8),
                                        Row(
                                          mainAxisAlignment: MainAxisAlignment.spaceBetween,
                                          children: [
                                            const Text('Bank Name', style: TextStyle(color: Color(0xff808080))),
                                            Text(_bankNameController.text, style: const TextStyle(color: Colors.white)),
                                          ],
                                        ),
                                        const SizedBox(height: 8),
                                        Row(
                                          mainAxisAlignment: MainAxisAlignment.spaceBetween,
                                          children: [
                                            const Text('Country', style: TextStyle(color: Color(0xff808080))),
                                            Text(_countryController.text, style: const TextStyle(color: Colors.white)),
                                          ],
                                        ),
                                        const SizedBox(height: 8),
                                        Row(
                                          mainAxisAlignment: MainAxisAlignment.spaceBetween,
                                          children: [
                                            const Text('SWIFT', style: TextStyle(color: Color(0xff808080))),
                                            Text(_swiftController.text, style: const TextStyle(color: Colors.white)),
                                          ],
                                        ),
                                        const SizedBox(height: 8),
                                        Row(
                                          mainAxisAlignment: MainAxisAlignment.spaceBetween,
                                          children: [
                                            const Text('IBAN', style: TextStyle(color: Color(0xff808080))),
                                            Text(_ibanController.text, style: const TextStyle(color: Colors.white)),
                                          ],
                                        ),
                                      ],
                                    ),
                                ],
                              ),
                            ),
                          ],
                        ),
            ),
          ),
          Padding(
            padding: const EdgeInsets.all(16.0),
            child: Row(
              children: [
                if (_currentStep > 1)
                  Expanded(
                    child: OutlinedButton(
                      onPressed: () => setState(() => _currentStep--),
                      style: OutlinedButton.styleFrom(
                        side: const BorderSide(color: Color(0xff808080)),
                        foregroundColor: Color(0xff808080),
                      ),
                      child: const Text('Back'),
                    ),
                  ),
                if (_currentStep > 1) const SizedBox(width: 8),
                Expanded(
                  child: ElevatedButton(
                    onPressed: _loading ? null : (_currentStep == 3 ? _submitWithdrawal : _handleNext),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: const Color(0xffFFD700),
                      foregroundColor: Colors.black,
                    ),
                    child: _loading ? const CircularProgressIndicator(color: Colors.black) : Text(_currentStep == 3 ? 'Submit Withdrawal' : 'Continue'),
                  ),
                ),
              ],
            ),
          ),
          if (_pendingRequests.isNotEmpty)
            Container(
              padding: const EdgeInsets.all(16),
              decoration: const BoxDecoration(
                border: Border(top: BorderSide(color: Color(0xff808080))),
              ),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const Text('Pending Withdrawals', style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.w600)),
                  const SizedBox(height: 8),
                  ..._pendingRequests.map((request) => Container(
                        margin: const EdgeInsets.only(bottom: 8),
                        padding: const EdgeInsets.all(16),
                        decoration: BoxDecoration(
                          color: const Color(0xff1a1a1a),
                          borderRadius: BorderRadius.circular(12),
                          border: Border.all(color: const Color(0xff808080)),
                        ),
                        child: Row(
                          mainAxisAlignment: MainAxisAlignment.spaceBetween,
                          children: [
                            Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text('${request['amount']} REGT', style: const TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.w500)),
                                Text(request['method'], style: const TextStyle(color: Color(0xff808080), fontSize: 12)),
                              ],
                            ),
                            Column(
                              crossAxisAlignment: CrossAxisAlignment.end,
                              children: [
                                Text(request['status'].toString().capitalize(), style: TextStyle(color: _getStatusColor(request['status']), fontSize: 12, fontWeight: FontWeight.w500)),
                                Text(DateFormat('MMM d, yyyy').format(DateTime.parse(request['created_at'])), style: const TextStyle(color: Color(0xff808080), fontSize: 10)),
                              ],
                            ),
                          ],
                        ),
                      )),
                ],
              ),
            ),
        ],
      ),
    );
  }
}

extension StringExtension on String {
  String capitalize() {
    return "${this[0].toUpperCase()}${substring(1)}";
  }
}

